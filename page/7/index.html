<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"jarod.vip",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"always",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="记录生活中的点点滴滴"><meta property="og:type" content="website"><meta property="og:title" content="Jarod&#39;s Blog"><meta property="og:url" content="https://jarod.vip/page/7/index.html"><meta property="og:site_name" content="Jarod&#39;s Blog"><meta property="og:description" content="记录生活中的点点滴滴"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="Jarod"><meta property="article:tag" content="VPS,hexo,linux,debian,windows,macos"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://jarod.vip/page/7/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!0,isPost:!1,lang:"zh-CN"}</script><title>Jarod's Blog</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-R131WF8QZC"></script><script>function gtag(){dataLayer.push(arguments)}CONFIG.hostname===location.hostname&&(window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-R131WF8QZC"))</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?e67344a16e268228733f496a595ecb7a",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="Jarod's Blog" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Jarod's Blog</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content index posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://jarod.vip/2020/04/30/wordpress%E5%BC%80%E5%90%AFnginx-fastcgi-cache%E7%BC%93%E5%AD%98%E5%8A%A0%E9%80%9F%E6%96%B9%E6%B3%95-nginx%E9%85%8D%E7%BD%AE%E5%AE%9E%E4%BE%8B/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Jarod"><meta itemprop="description" content="记录生活中的点点滴滴"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jarod's Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2020/04/30/wordpress%E5%BC%80%E5%90%AFnginx-fastcgi-cache%E7%BC%93%E5%AD%98%E5%8A%A0%E9%80%9F%E6%96%B9%E6%B3%95-nginx%E9%85%8D%E7%BD%AE%E5%AE%9E%E4%BE%8B/" class="post-title-link" itemprop="url">WordPress开启Nginx fastcgi_cache缓存加速方法-Nginx配置实例</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-04-30 23:28:13" itemprop="dateCreated datePublished" datetime="2020-04-30T23:28:13+08:00">2020-04-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-09-29 21:27:46" itemprop="dateModified" datetime="2022-09-29T21:27:46+08:00">2022-09-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Linux教程</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>6.2k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>6 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><p>使用<a target="_blank" rel="noopener" href="https://wzfou.com/wordpress-jianzhan/">WordPress建站</a>的过程中，对于优化Wordpress性能、加快网站访问速度这一环节走了不少的“弯路”。当网站出现访问缓慢、CPU内存耗尽的情形时，最开始想到的是升级服务器配置，后来发现有些无良的VPS商家背后限制资源严重，加钱升级真的很伤人。</p><p>最大的体会就是同样的配置，在不同的VPS商家那里跑同一个网站，在同样的流量情况下，居然一个顺畅而另一个卡顿，这个给我最大的感受就是在购买VPS之前一定要看看别人的评测，尤其是VPS主机性能评测这一块，一定要仔细对比，否则容易花不少冤枉钱。</p><p>后来给Wordpress做优化时，关注在页面缓存上，之前用过的缓存插件包括但不限于WordPress Super Cache、WP Fastest Cache、W3 Total Cache、cos-html-cache、Cachify……总得来说，安装了缓存插件后提速还是有效果的，但是也带来了不少的问题。</p><p>例如配置复杂、生成规则、插件冲突以及无法应对突发流量，也就是说使用缓存插件还是无法达到应对大流量冲击的情况。最后，在朋友的推荐下启用了Nginx fastcgi_cache缓存，直接使用Nginx为页面生成缓存，效率比使用PHP缓存插件要高得多，特别适合小配置的VPS上使用。</p><p><img src="/2020/04/Nginx-fastcgi_cache_00.jpg" alt="Wordpress开启Nginx fastcgi_cache缓存加速方法-Nginx配置实例"></p><p>更多的关于Wordpress和<a target="_blank" rel="noopener" href="https://wzfou.com/tag/fuwuqi-youhua/">服务器优化</a>的经验文章，这里还有：</p><ol><li><a target="_blank" rel="noopener" href="https://wzfou.com/php-fpm/">Linux的php-fpm优化心得-php-fpm进程占用内存大和不释放内存问题</a></li><li><a target="_blank" rel="noopener" href="https://wzfou.com/dashang-anniu/">WordPress添加支付宝,微信打赏按钮制作实例和Paypal.me打赏链接</a></li><li><a target="_blank" rel="noopener" href="https://wzfou.com/crontab/">Linux Crontab命令定时任务基本语法与操作教程-VPS&#x2F;服务器自动化</a></li></ol><blockquote><p><strong>PS：2018年12月19日更新，</strong>WordPress自带的站内搜索不仅搜索慢而且还无法搜索更多的关键字，我们可以自建一个或者使用第三方的搜索嵌入WP：<a target="_blank" rel="noopener" href="https://wzfou.com/baidu-google-es/">改进网站站内搜索-百度,Google自定义搜索和Elasticsearch自建搜索</a>。</p><p><strong>PS：2019年9月29日更新，</strong>由于Google主导开发的服务器优化神器ngx_pagespeed，集成了图片延迟加载、自适应webp、JS和CSS优化、图片优化等一整套优化工具：<a target="_blank" rel="noopener" href="https://wzfou.com/ngx-pagespeed/">PageSpeed服务器优化神器-Nginx部署ngx_pagespeed模块和加速效果体验</a>。</p></blockquote><h2 id="一、安装Nginx-ngx-cache-purge模块"><a href="#一、安装Nginx-ngx-cache-purge模块" class="headerlink" title="一、安装Nginx ngx_cache_purge模块"></a>一、安装Nginx ngx_cache_purge模块</h2><p>网站：</p><ol><li><a target="_blank" rel="noopener" href="http://labs.frickle.com/files/">http://labs.frickle.com/files/</a></li></ol><h3 id="1-1-LNMP"><a href="#1-1-LNMP" class="headerlink" title="1.1  LNMP"></a>1.1  LNMP</h3><p>如果你用的是<a target="_blank" rel="noopener" href="https://wzfou.com/lnmp-1-4/">LNMP一键安装包</a>，编辑lnmp安装包目录下的 lnmp.conf 文件，在Nginx_Modules_Options&#x3D;”  的单引号中加上 –add-module&#x3D;&#x2F;root&#x2F;ngx_cache_purge-2.3 保存，升级一下nginx就安装上了，其他模块也参考这个就行。</p><p>ngx_cache_purge-2.3需要你从frickle.com官网中下载安装包并解压，目前最新版是2.3。</p><p><img src="/2020/04/Nginx-fastcgi_cache_03.jpg" alt="Nginx fastcgi_cache直接编译"></p><h3 id="1-2-Oneinstack"><a href="#1-2-Oneinstack" class="headerlink" title="1.2  Oneinstack"></a>1.2  Oneinstack</h3><p>如果你用的是<a target="_blank" rel="noopener" href="https://wzfou.com/tag/oneinstack-mianban/">OneinStack面板</a>，可以通过以下命令来编译ngx_cache_purge模块。</p><p># nginx -V 2&gt;&amp;1 grep -o ngx_cache_purge 查看ngx_cache_purge是否安装,没有数据表示未安装<br>cd &#x2F;root&#x2F;oneinstack&#x2F;src<br>wget <a target="_blank" rel="noopener" href="http://labs.frickle.com/files/ngx/_cache/_purge-2.3.tar.gz">http://labs.frickle.com/files/ngx\_cache\_purge-2.3.tar.gz</a><br>tar xzf ngx_cache_purge-2.3.tar.gz</p><p>#以下几个安装包都是Oneinstack自带的，不同的版本可能会不同，请根据情况调整<br>tar xzf nginx-1.14.0.tar.gz<br>tar xzf pcre-8.42.tar.gz<br>tar xzf openssl-1.0.2o.tar.gz<br>cd &#x2F;root&#x2F;oneinstack&#x2F;src&#x2F;nginx-1.14.0</p><p>nginx -V #查看nginx编译参数，最后加上–add-module&#x3D;..&#x2F;ngx_cache_purge-2.3<br>.&#x2F;configure –prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx –user&#x3D;www –group&#x3D;www –with-http_stub_status_module –with-http_v2_module –with-http_ssl_module –with-http_gzip_static_module –with-http_realip_module –with-http_flv_module –with-http_mp4_module –with-openssl&#x3D;..&#x2F;openssl-1.0.2o –with-pcre&#x3D;..&#x2F;pcre-8.42 –with-pcre-jit –with-ld-opt&#x3D;-ljemalloc –add-module&#x3D;..&#x2F;ngx_cache_purge-2.3</p><p>make #编译<br>mv &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx{,_`date +%F`} #备份nginx<br>cp objs&#x2F;nginx &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin<br>nginx -V 2&gt;&amp;1 grep -o ngx_cache_purge</p><h1 id="显示ngx-cache-purge表示已经安装成功"><a href="#显示ngx-cache-purge表示已经安装成功" class="headerlink" title="显示ngx_cache_purge表示已经安装成功"></a>显示ngx_cache_purge表示已经安装成功</h1><p>使用<code>Nginx -V</code>查看编译参数添加add-module时，一定要根据你自己的Nginx的编译参数来操作，也就是说保留原来的Nginx参数再加上add-module。例如我的：</p><p><img src="/2020/04/Nginx-fastcgi_cache_01.gif" alt="Nginx fastcgi_cache查看编译参数"></p><p>安装Nginx ngx_cache_purge模块成功。</p><p><img src="/2020/04/Nginx-fastcgi_cache_02.gif" alt="Nginx fastcgi_cache安装成功"></p><h3 id="1-3-其它面板"><a href="#1-3-其它面板" class="headerlink" title="1.3  其它面板"></a>1.3  其它面板</h3><p>如果你用的是其它的面板（专题：<a target="_blank" rel="noopener" href="https://wzfou.com/vps-mianban/">服务器控制面板榜单</a>），例如<a target="_blank" rel="noopener" href="https://wzfou.com/wdcp/">WDCP</a>、<a target="_blank" rel="noopener" href="https://wzfou.com/bt-cn/">BT宝塔面板</a>等，请查阅官网的文档。</p><p><img src="/2020/04/Nginx-fastcgi_cache_04.jpg" alt="Nginx fastcgi_cache参考文档"></p><h2 id="二、Nginx开启fastcgi-cache缓存-配置实例"><a href="#二、Nginx开启fastcgi-cache缓存-配置实例" class="headerlink" title="二、Nginx开启fastcgi_cache缓存-配置实例"></a>二、Nginx开启fastcgi_cache缓存-配置实例</h2><h3 id="2-1-配置实例"><a href="#2-1-配置实例" class="headerlink" title="2.1  配置实例"></a>2.1  配置实例</h3><p>下面我直接贴出wzfou.com的Nginx开启<a target="_blank" rel="noopener" href="https://wzfou.com/tag/fastcgi_cache-jiasu/">fastcgi_cache缓存</a>配置实例，详细的说明如下：</p><p>#路径需要提前创建好<br>fastcgi_cache_path &#x2F;tmp&#x2F;nginx-cache levels&#x3D;1:2 keys_zone&#x3D;WORDPRESS:250m inactive&#x3D;1d max_size&#x3D;500m;<br>fastcgi_temp_path &#x2F;tmp&#x2F;nginx-cache&#x2F;temp;<br>fastcgi_cache_key “$scheme$request_method$host$request_uri”;<br>fastcgi_cache_use_stale error timeout invalid_header http_500;<br>#忽略一切nocache申明，避免不缓存伪静态等<br>fastcgi_ignore_headers Cache-Control Expires Set-Cookie;</p><p>server {<br>listen 80;<br>listen 443 ssl http2;<br>…………………此部省略……………………</p><p>set $skip_cache 0;<br>#post访问不缓存<br>if ($request_method &#x3D; POST) {<br>set $skip_cache 1;<br>}<br>#动态查询不缓存<br>if ($query_string !&#x3D; “”) {<br>set $skip_cache 1;<br>}<br>#后台等特定页面不缓存（其他需求请自行添加即可）<br>if ($request_uri ~* “&#x2F;wp-admin&#x2F;&#x2F;xmlrpc.phpwp-.*.php&#x2F;feed&#x2F;&#x2F;zhuye&#x2F;&#x2F;wzfou.com&#x2F;&#x2F;question&#x2F;&#x2F;bbs&#x2F;&#x2F;dongtai&#x2F;&#x2F;haoyou&#x2F;&#x2F;qun&#x2F;index.phpsitemap(_index)?.xml”) {<br>set $skip_cache 1;<br>}<br>#对登录用户、评论过的用户不展示缓存<br>if ($http_cookie ~* “comment_authorwordpress_[a-f0-9]+wp-postpasswordpress_no_cachewordpress_logged_in”) {<br>set $skip_cache 1;<br>}<br>#这里请参考你网站之前的配置，特别是sock的路径，弄错了就502了！<br>location ~ [^&#x2F;]\.php(&#x2F;$) {<br>#fastcgi_pass remote_php_ip:9000;<br>fastcgi_pass unix:&#x2F;dev&#x2F;shm&#x2F;php-cgi.sock;<br>fastcgi_index index.php;<br>include fastcgi.conf;<br>add_header Strict-Transport-Security “max-age&#x3D;63072000; includeSubdomains; preload”;<br>#新增的缓存规则<br>fastcgi_cache_bypass $skip_cache;<br>fastcgi_no_cache $skip_cache;<br>add_header X-Cache “$upstream_cache_status From $host”;<br>add_header Cache-Control max-age&#x3D;0;<br>add_header Nginx-Cache “$upstream_cache_status”;<br>add_header Last-Modified $date_gmt;<br>add_header X-Frame-Options SAMEORIGIN; # 只允许本站用 frame 来嵌套<br>add_header X-Content-Type-Options nosniff; # 禁止嗅探文件类型<br>add_header X-XSS-Protection “1; mode&#x3D;block”; # XSS 保护<br>etag on;<br>fastcgi_cache WORDPRESS;<br>fastcgi_cache_valid 200 301 302 1d;<br>}</p><p>#缓存清理配置（可选）<br>location ~ &#x2F;purge( &#x2F;.*) { #为防止转义，请去掉{ &#x2F;之间的空格<br>allow 127.0.0.1;<br>#此处填写你的服务器IP<br>allow 89.208.xxx.xxx;<br>deny all;<br>#请注意此处的WORDPRESS要与上面的keys_zone保持一致<br>fastcgi_cache_purge WORDPRESS “$scheme$request_method$host$1”;<br>}<br>…………………此部分省略……………………</p><p>}</p><h3 id="2-2-有关说明"><a href="#2-2-有关说明" class="headerlink" title="2.2  有关说明"></a>2.2  有关说明</h3><p>本地or内存？在fastcgi_cache_path和fastcgi_temp_path中，有人会建议将它设置为内存路径，例如：<code>/dev/shm/nginx-cache levels=1:2 keys_zone=WORDPRESS:100m inactive=60m;</code>，如果你的磁盘IO很慢的话建议采用此方式，毕竟内存的读写速度非常快。</p><p><img src="/2020/04/Nginx-fastcgi_cache_05.jpg" alt="Nginx fastcgi_cache本地缓存"></p><p><code>add_header Cache-Control</code> 如果是动态内容要实时更新的话，可以设置为0，否则可以设置时间大一些。</p><p><img src="/2020/04/Nginx-fastcgi_cache_13.gif" alt="Nginx fastcgi_cache控制缓存"></p><h2 id="三、安装Nginx-Helper插件-自动刷新缓存"><a href="#三、安装Nginx-Helper插件-自动刷新缓存" class="headerlink" title="三、安装Nginx Helper插件-自动刷新缓存"></a>三、安装Nginx Helper插件-自动刷新缓存</h2><p>通过上面的方法我们已经配置好了fastcgi_cache缓存，接下来我们就要解决当Wordpress有新评论、新文章时自动刷新Nginx缓存页面了。直接搜索Nginx Helper插件下载，然后是设置，首先是开启，清除方式选择本地文件。</p><p><img src="/2020/04/Nginx-fastcgi_cache_07.gif" alt="Nginx fastcgi_cache开启插件"></p><p>插件还提供了其它的一些设置，例如发表新文章、新评论时是否更新Nginx缓存。</p><p><img src="/2020/04/Nginx-fastcgi_cache_08.gif" alt="Nginx fastcgi_cache更新文章缓存"></p><p>由于插件作者定义的缓存路径是 &#x2F;var&#x2F;run&#x2F;nginx-cache ，而我们可能会根据服务器实际情况来自定义缓存路径，这样一来缓存路径的不同就会导致插件无法找到缓存文件并删除！</p><p><strong>解决办法是</strong>在 WordPress 根目录下的 wp-config.php 中新增如下代码即可：</p><p>&#x2F;&#x2F;根据实际情况定义缓存的存放路径<br>define( ‘RT_WP_NGINX_HELPER_CACHE_PATH’,’&#x2F;tmp&#x2F;wpcache’);</p><p>如果你发现上述定义路径的代码不生效，你可以采用“<a target="_blank" rel="noopener" href="https://wzfou.com/nginx-fastcgi-cache/#comment-10039">自然</a>”博主的建议：</p><blockquote><p>一是修改插件，将插件中路径改成你自己的，二是使用软连接，&#x2F;var&#x2F;run&#x2F;nginxcache 和&#x2F;tmp&#x2F;wpcache</p></blockquote><h2 id="三、Nginx-fastcgi-cache效果预览"><a href="#三、Nginx-fastcgi-cache效果预览" class="headerlink" title="三、Nginx fastcgi_cache效果预览"></a>三、Nginx fastcgi_cache效果预览</h2><p>启用了<a target="_blank" rel="noopener" href="https://wzfou.com/tag/nginx-fastcgi_cache/">Nginx fastcgi_cache</a>后，我们就可以在浏览器Header 头部信息中看到已经命中了。</p><p><img src="/2020/04/Nginx-fastcgi_cache_09.gif" alt="Nginx fastcgi_cache看到命中"></p><p>对于已经设置了不缓存的页面，Nginx fastcgi_cache会直接显示<strong>BYPASS。</strong></p><p><img src="/2020/04/Nginx-fastcgi_cache_10.gif" alt="Nginx fastcgi_cache不缓存"></p><p>另外，对于已经登录的用户还有发表过评论的用户，Nginx fastcgi_cache也会直接BYPASS。</p><p><img src="/2020/04/Nginx-fastcgi_cache_11.gif" alt="Nginx fastcgi_cache评论用户不缓存"></p><p>同时，我们服务器的缓存路径中也能看到Nginx fastcgi_cache生成的缓存文件。</p><p><img src="/2020/04/Nginx-fastcgi_cache_12.gif" alt="Nginx fastcgi_cache生成的文件"></p><p>如果你发现你的评论过的用户依然用的是缓存，那应该是WP没有记住cookie，把以下代码加入到<code>functions.php</code> 中即可。</p><p>add_action(‘set_comment_cookies’,’coffin_set_cookies’,10,3);<br>function coffin_set_cookies( $comment, $user, $cookies_consent){<br>$cookies_consent &#x3D; true;<br>wp_set_comment_cookies($comment, $user, $cookies_consent);<br>}</p><h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p>Nginx开启<a target="_blank" rel="noopener" href="https://wzfou.com/tag/fastcgi_cache-jiasu/">fastcgi_cache缓存</a>对于加快网页响应速度以及节省服务器资源有着非常重要的意义，下图是alibabacloud.com的测试结果，可以看出来启用缓存后服务器的承载能力有了非常大的提升。</p><p><img src="/2020/04/Nginx-fastcgi_cache_14.gif" alt="Nginx fastcgi_cache启用效果"></p><p>wzfou.com挖站否在启用fastcgi_cache缓存时，发现在Nginx配置文件中添加了Cache-Control信息，但是总是不生效。HTTP头部信息会总会包含以下信息：</p><blockquote><p>Cache-Control: no-store,no-cache,must-revalidate,post-check&#x3D;0,pre-check&#x3D;0 和 Pragma: no-cache，</p></blockquote><p>经过排查，问题出在了LNMP和Oneinstack一键包中的<code>session.cache_limiter</code>的PHP.ini设置部分， 默认值是nocache，我们需要将它设置为none即可。</p><p><img src="/2020/04/Nginx-fastcgi_cache_15.gif" alt="Nginx fastcgi_cache修改PHP配置"></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://jarod.vip/2020/04/30/%E7%BD%91%E7%AB%99%E4%BC%98%E5%8C%96%E5%8A%A0%E9%80%9F-%E5%BC%80%E5%90%AFtlsv1-3%E5%92%8Cbrotli%E5%8E%8B%E7%BC%A9-oneinstacklnmp%E5%AE%9D%E5%A1%94%E9%9D%A2%E6%9D%BF/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Jarod"><meta itemprop="description" content="记录生活中的点点滴滴"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jarod's Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2020/04/30/%E7%BD%91%E7%AB%99%E4%BC%98%E5%8C%96%E5%8A%A0%E9%80%9F-%E5%BC%80%E5%90%AFtlsv1-3%E5%92%8Cbrotli%E5%8E%8B%E7%BC%A9-oneinstacklnmp%E5%AE%9D%E5%A1%94%E9%9D%A2%E6%9D%BF/" class="post-title-link" itemprop="url">网站优化加速-开启TLSV1.3和Brotli压缩-Oneinstack,LNMP,宝塔面板</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-04-30 23:26:39" itemprop="dateCreated datePublished" datetime="2020-04-30T23:26:39+08:00">2020-04-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-09-29 21:27:46" itemprop="dateModified" datetime="2022-09-29T21:27:46+08:00">2022-09-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Linux教程</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>12k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>11 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><p>本篇文章再来分享一下网站优化加速方法：开启TLSV1.3和Brotli压缩。相对于TLSV1.2，TLSV1.3主要是减少握手延迟，提高跨协议攻击的难度，使互联网更快，更多安全。Brotli是由谷歌开发的压缩算法，与其他压缩算法相比，它有着更高的压缩效率。</p><p>一般来说我们的VPS主机已经默认开启了GZIP压缩了，而Brotli与GZIP可以同时共存，当<strong>同时开启两种压缩算法时，Brotli 压缩等级优先级高于 Gzip。</strong>实际上，最新版的宝塔BT面板、Oneinstack和LNMP都已经默认可以开启TLSV1.3，各大面板使用：<a target="_blank" rel="noopener" href="https://wzfou.com/vps-mianban/">服务器控制面板榜单</a>。</p><p><img src="/2020/04/one-tls_01.jpg" alt="网站优化加速-开启TLSV1.3和Brotli压缩-Oneinstack和LNMP,宝塔面板"></p><p>更多的关于网站服务器优化与加速，这里有：</p><ol><li><a target="_blank" rel="noopener" href="https://wzfou.com/vps-jiasu/">VPS主机加速方法 – 一键安装加速模块 从“软件”上提升VPS主机速度</a></li><li><a target="_blank" rel="noopener" href="https://wzfou.com/cloudflare-railgun/">Cloudflare Partner接入管理Cloudflare CDN-启用Railgun动态加速</a></li><li><a target="_blank" rel="noopener" href="https://wzfou.com/nginx-cdn/">自建CDN加速-Nginx反向绑定,缓存加速,自动更新缓存和获取真实IP</a></li></ol><blockquote><p><strong>PS：2019年9月29日更新，</strong>由于Google主导开发的服务器优化神器ngx_pagespeed，集成了图片延迟加载、自适应webp、JS和CSS优化、图片优化等一整套优化工具：<a target="_blank" rel="noopener" href="https://wzfou.com/ngx-pagespeed/">PageSpeed服务器优化神器-Nginx部署ngx_pagespeed模块和加速效果体验</a>。</p></blockquote><h2 id="一、开启TLSV1-3"><a href="#一、开启TLSV1-3" class="headerlink" title="一、开启TLSV1.3"></a>一、开启TLSV1.3</h2><h3 id="1-1-Oneinstack-TLSV1-3"><a href="#1-1-Oneinstack-TLSV1-3" class="headerlink" title="1.1  Oneinstack TLSV1.3"></a>1.1  Oneinstack TLSV1.3</h3><p><strong>PS：2019年1月17日更新，</strong>最新版的Oneinstack已经默认开启TLSV1.3了，所以如果你是全新安装的Oneinstack，安装完成后就启用了TLSV1.3了。</p><p>Oneinstack面板的安装与使用参考：<a target="_blank" rel="noopener" href="https://wzfou.com/oneinstack/">OneinStack一键安装脚本</a>。如果你是全新安装Oneinstack，则可以按照教程先将Oneinstack一键包下载到本地，不要执行安装。而是选择oneinstack目录，编辑version.txt，把openssl_version版本号改到1.1.1以上。</p><p><img src="/2020/04/oneinstack-tls13_01.gif" alt="开启TLSV1.3修改版本"></p><p>然后开始安装即可。如果你已经是Oneinstack的老用户了，方法类似，先升级一下Oneinstack，修改version.txt的openssl_version版本号，执行Oneinstack自带的升级脚本，升级一下Nginx。然后就可以看到openssl已经升级了。</p><p><img src="/2020/04/oneinstack-tls13_02.gif" alt="开启TLSV1.3升级Nginx成功"></p><p>最后就是修改你的网站Nginx配置文件了，在ssl_protocols 后面添加TLSv1.3，在ssl_ciphers添加数个加密套件，重启Nginx完成。以下是我的Nginx的TLSv1.3配置，ssl_ciphers 的TLSv1.3部分是新增加的。</p><p>ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;</p><p>ssl_ciphers TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:!MD5;</p><p>现在打开Chrome就可以看到wzfou.com已经成功使用了TLSv1.3。（PS：现在浏览器更新的速度很快，除IE，Chrome和Firefox新版对于TLSv1.3都已经支持了）</p><p><img src="/2020/04/oneinstack-tls13_07.gif" alt="开启TLSV1.3效果"></p><h3 id="1-2-LNMP-TLSV1-3"><a href="#1-2-LNMP-TLSV1-3" class="headerlink" title="1.2  LNMP TLSV1.3"></a>1.2  LNMP TLSV1.3</h3><p>LNMP面板参考：<a target="_blank" rel="noopener" href="https://wzfou.com/lnmp-1-4/">Linux VPS建站工具</a>，目前LNMP 1.6版本已经默认支持TLSv1.3（<a target="_blank" rel="noopener" href="https://wzfou.com/lnmp-1-6/">LNMP 1.6安装与使用-自动开启TLS 1.3</a>），你只需要按照上面的操作调整一下你的网站Nginx配置就可以开启TLSv1.3。如果你用的是LNMP 1.5的话，可以使用升级命令：<code>upgrade1.x-1.6.sh</code> 升级一下管理脚本。</p><p><img src="/2020/04/one-tls_00.jpg" alt="开启TLSV1.3升级脚本"></p><p>然后使用1.6的升级脚本升级一下nginx就可以了。如果你不想让LNMP 1.5升级到LNMP 1.6，则打开 \lnmp1.5\include\version.sh 文件，将 <code>Openssl_Ver=&#39;openssl-1.0.2o&#39;</code> 修改为：<code>Openssl_Ver=&#39;openssl-1.1.1a&#39;</code>。</p><p><img src="/2020/04/oneinstack-tls13_08.gif" alt="开启TLSV1.3修改Nginx的配置"></p><p>然后修改 \lnmp1.5\lnmp.conf 文件，将 <code>Nginx_Modules_Options=&#39;&#39;</code> 改为：<code>Nginx_Modules_Options=&#39;--with-openssl-opt=enable-weak-ssl-ciphers&#39;</code>（注：enable-weak-ssl-ciphers 作用是让 OpenSSL 继续支持 3DES 等不安全 Cipher Suite，如果你打算继续支持 IE8，才需要加上这个选项；若不需要支持 XP IE8 访问可忽略此处修改）</p><p><img src="/2020/04/oneinstack-tls13_09.gif" alt="开启TLSV1.3修改升级脚本"></p><p>进入 lnmp1.5 目录，执行命令：</p><p>.&#x2F;upgrade.sh nginx</p><p>然后输入需要升级的 nginx 版本号，如目前最新的 1.15.7。nginx 最新版本号可从官网获取：<a target="_blank" rel="noopener" href="http://nginx.org.静待编译完成.执行/">http://nginx.org。静待编译完成。执行</a> nginx -V 可查询详细配置信息：</p><p>Checking …<br>Program will display Nginx Version……<br>nginx version: nginx&#x2F;1.15.7<br>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; upgrade nginx completed &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</p><p>nginx version: nginx&#x2F;1.15.7<br>built by gcc 4.8.5 20150623 (Red Hat 4.8.5-28) (GCC)<br>built with OpenSSL 1.1.1a 20 Nov 2018<br>TLS SNI support enabled<br>configure arguments: –user&#x3D;www –group&#x3D;www –prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx –with-http_stub_status_module –with-http_ssl_module –with-http_v2_module –with-http_gzip_static_module –with-http_sub_module –with-stream –with-stream_ssl_module –with-openssl&#x3D;&#x2F;root&#x2F;lnmp1.5&#x2F;src&#x2F;openssl-1.1.1a –with-openssl-opt&#x3D;enable-weak-ssl-ciphers</p><p>修改主机配置文件，加入TLSv1.3配置，如下（和上面的Oneinstack是一样的）。文件修改完，重启一下 nginx，然后就可以去浏览器访问验证一下。</p><p>ssl_protocols 加入 TLSv1.3 支持，如：ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;</p><p>#ssl_ciphers 参考配置：</p><p>ssl_ciphers TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:!MD;</p><h3 id="1-3-宝塔BT面板-TLSV1-3"><a href="#1-3-宝塔BT面板-TLSV1-3" class="headerlink" title="1.3  宝塔BT面板 TLSV1.3"></a>1.3  宝塔BT面板 TLSV1.3</h3><p>新版的宝塔BT面板，已经支持nginx1.15了，直接在“软件管理”页面切换nginx1.15即可。</p><p><img src="/2020/04/oneinstack-tls13_10.gif" alt="开启TLSV1.3切换版本"></p><p>然后在网站的配置文件加上TLSv1.3相关配置就可以了。</p><p>ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;<br>#ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;<br>ssl_ciphers TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:!MD5;</p><p><img src="/2020/04/oneinstack-tls13_11.gif" alt="开启TLSV1.3宝塔面板中修改"></p><h2 id="二、服务器SSL优化"><a href="#二、服务器SSL优化" class="headerlink" title="二、服务器SSL优化"></a>二、服务器SSL优化</h2><p>SSL优化：</p><ol><li>效果演示：<a target="_blank" rel="noopener" href="https://www.ssllabs.com/ssltest/analyze.html?d=wzfou.com">https://www.ssllabs.com/ssltest/analyze.html?d=wzfou.com</a></li></ol><p>如下图：</p><p><img src="/2020/04/oneinstack-tls13_12.gif" alt="开启TLSV1.3优化效果"></p><p>优化的方法除了本文讲到的开启TLSV1.3，优化的经验（主要是SSL双证书、HSTS）也在以下两篇文章中有分享过：</p><blockquote><p>1.<a target="_blank" rel="noopener" href="https://wzfou.com/hsts-preload/">启用HSTS并加入HSTS Preload List让网站Https访问更加安全-附删除HSTS方法</a></p><p>2.<a target="_blank" rel="noopener" href="https://wzfou.com/https-ssl/">八个HTTPS和SSL优化使用心得-减少等待时间和降低Https性能损耗</a></p></blockquote><h2 id="三、开启Brotli压缩"><a href="#三、开启Brotli压缩" class="headerlink" title="三、开启Brotli压缩"></a>三、开启Brotli压缩</h2><p>项目：</p><ol><li><a target="_blank" rel="noopener" href="https://github.com/google/ngx/_brotli">https://github.com/google/ngx\_brotli</a></li></ol><h3 id="3-1-Oneinstack-Brotli"><a href="#3-1-Oneinstack-Brotli" class="headerlink" title="3.1  Oneinstack Brotli"></a>3.1  Oneinstack Brotli</h3><p>Oneinstack 开启 Brotli需要先进行编译，最简单的方法就是利用Oneinstack自带的升级脚本，将Brotli编译到Nginx，方法如下：</p><p>cd oneinstack&#x2F;src<br>git clone <a target="_blank" rel="noopener" href="https://github.com/google/ngx/_brotli.git">https://github.com/google/ngx\_brotli.git</a><br>cd ngx_brotli<br>git submodule update –init<br>#修改options.conf<br>nginx_modules_options中新增–add-module&#x3D;..&#x2F;ngx_brotli<br>.&#x2F;upgrade.sh web nginx</p><p>#20190118更新，新版Oneinstack需要到oneinstack\include目录，找到upgrade_web.sh，修改：<br>.&#x2F;configure ${nginx_configure_args}<br>#新增：<br>.&#x2F;configure ${nginx_configure_args} –add-module&#x3D;..&#x2F;ngx_brotli<br>#最后（执行升级，选择Nginx）：<br>~&#x2F;oneinstack&#x2F;upgrade.sh</p><p>#修改&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</p><pre><code>brotli             on;
brotli\_comp\_level  6;
brotli\_types       text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript image/svg+xml;
</code></pre><p>或者直接手动编译Brotli到Nginx，该方法与wzfou.com之前分享的<a target="_blank" rel="noopener" href="https://wzfou.com/nginx-fastcgi-cache/#Nginx_ngx_cache_purge">Oneinstack编译ngx_cache_purge模块</a>是一样的：</p><p>cd oneinstack&#x2F;src<br>git clone <a target="_blank" rel="noopener" href="https://github.com/google/ngx/_brotli.git">https://github.com/google/ngx\_brotli.git</a><br>cd ngx_brotli<br>git submodule update –init</p><p>#以下几个安装包都是Oneinstack自带的，不同的版本可能会不同，请根据情况下载到&#x2F;root&#x2F;oneinstack&#x2F;src&#x2F;并解压<br>tar xzf nginx-1.14.2.tar.gz<br>tar xzf pcre-8.42.tar.gz<br>tar xzf openssl-1.1.1a.tar.gz<br>cd &#x2F;root&#x2F;oneinstack&#x2F;src&#x2F;nginx-1.14.2<br>nginx -V #查看nginx编译参数，最后加上–add-module&#x3D;..&#x2F;ngx_brotli</p><p>.&#x2F;configure –prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx –user&#x3D;www –group&#x3D;www –with-http_stub_status_module –with-http_v2_module –with-http_ssl_module –with-http_gzip_static_module –with-http_realip_module –with-http_flv_module –with-http_mp4_module –with-openssl&#x3D;..&#x2F;openssl-1.1.1a –with-pcre&#x3D;..&#x2F;pcre-8.42 –with-pcre-jit –with-ld-opt&#x3D;-ljemalloc –add-module&#x3D;..&#x2F;ngx_cache_purge-2.3 –add-module&#x3D;..&#x2F;ngx_brotli</p><p>make #编译<br>mv &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx{,_`date +%F`} #备份nginx<br>cp objs&#x2F;nginx &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin<br>nginx -V</p><p>Nginx Brotli编译成功。</p><p><img src="/2020/04/oneinstack-tls13_04.gif" alt="开启TLSV1.3升级编译"></p><p>打开你的网站的Nginx配置文件，添加以下代码：</p><p>#修改&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</p><pre><code>brotli             on;
brotli\_comp\_level  6;
brotli\_types       text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript image/svg+xml;
</code></pre><p>如下图：</p><p><img src="/2020/04/oneinstack-tls13_05.gif" alt="开启TLSV1.3添加代码支持"></p><p>重启Nginx，刷新网页，利用Chrome审查元素，就可以看到网页显示“br”字样，表示使用了Brotli压缩。</p><p><img src="/2020/04/oneinstack-tls13_06.gif" alt="Brotli压缩成功启用"></p><h3 id="3-2-LNMP-Brotli"><a href="#3-2-LNMP-Brotli" class="headerlink" title="3.2  LNMP Brotli"></a>3.2  LNMP Brotli</h3><p>在LNMP上编译Brotli类似于上面的Oneinstack，首先也是将Brotli下载到本地，然后编辑一下配置，重新编译一下Nginx即可。命令如下：</p><p>#下载<br>cd lnmp1.5&#x2F;src<br>git clone <a target="_blank" rel="noopener" href="https://github.com/google/ngx/_brotli.git">https://github.com/google/ngx\_brotli.git</a><br>cd ngx_brotli<br>git submodule update –init<br>#编辑配置，请根据你自己的路径调整<br>vi &#x2F;root&#x2F;lnmp1.5&#x2F;lnmp.conf<br>#添加<br>Nginx_Modules_Options&#x3D;’–add-module&#x3D;&#x2F;wzfou&#x2F;lnmp1.5&#x2F;ngx_brotli’<br>#最后，重新重新编译或者升级Nginx<br>cd &#x2F;root&#x2F;lnmp1.5<br>.&#x2F;upgrade.sh nginx</p><p>编辑配置文件如下：</p><p><img src="/2020/04/oneinstack-tls13_15.gif" alt="LNMP启用Brotli压缩"></p><p>最后，还是修改你的网站配置加入Brotli代码。</p><p>brotli on;<br>brotli_comp_level 6;<br>brotli_types text&#x2F;plain text&#x2F;css application&#x2F;json application&#x2F;x-javascript text&#x2F;xml application&#x2F;xml application&#x2F;xml+rss text&#x2F;javascript application&#x2F;javascript image&#x2F;svg+xml;</p><h3 id="3-3-宝塔面板-Brotli"><a href="#3-3-宝塔面板-Brotli" class="headerlink" title="3.3  宝塔面板 Brotli"></a>3.3  宝塔面板 Brotli</h3><p>宝塔面板编译 Brotli也一样，利用宝塔自带的脚本：www&#x2F;server&#x2F;panel&#x2F;install&#x2F;nginx.sh对Nginx重新编译和升级，代码如下：</p><p>#安装libbrotli<br>cd &#x2F;www&#x2F;server<br>git clone <a target="_blank" rel="noopener" href="https://github.com/bagder/libbrotli">https://github.com/bagder/libbrotli</a><br>cd libbrotli<br>.&#x2F;autogen.sh<br>.&#x2F;configure<br>make &amp;&amp; make install</p><p>#下载ngx_brotli模块及其依赖：<br>cd &#x2F;www&#x2F;server<br>git clone <a target="_blank" rel="noopener" href="https://github.com/google/ngx/_brotli">https://github.com/google/ngx\_brotli</a><br>cd ngx_brotli &amp;&amp; git submodule update –init</p><p>#获取Nginx Arguments<br>nginx -V</p><p>#编辑配置<br>vi &#x2F;www&#x2F;server&#x2F;panel&#x2F;install&#x2F;nginx.sh</p><p>#在你需要安装的Nginx版本下增加：–add-module&#x3D;&#x2F;www&#x2F;server&#x2F;ngx_brotli</p><p>if [ “${nginx_version}” &#x3D;&#x3D; “1.12.2” ] [ “${nginx_version}” &#x3D;&#x3D; “1.14.2” ];then<br>.&#x2F;configure –user&#x3D;www –group&#x3D;www –prefix&#x3D;${Setup_Path} –with-openssl&#x3D;${Update_Path}&#x2F;src&#x2F;openssl –add-module&#x3D;${Update_Path}&#x2F;src&#x2F;ngx_devel_kit –add-module&#x3D;${Update_Path}&#x2F;src&#x2F;lua_nginx_module –add-module&#x3D;${Update_Path}&#x2F;src&#x2F;ngx_cache_purge –add-module&#x3D;${Update_Path}&#x2F;src&#x2F;nginx-sticky-module –with-http_stub_status_module –with-http_ssl_module –with-http_image_filter_module –with-http_v2_module –with-http_gzip_static_module –with-http_gunzip_module –with-stream –with-stream_ssl_module –with-ipv6 –with-http_sub_module –with-http_flv_module –with-http_addition_module –with-http_realip_module –with-http_mp4_module –with-ld-opt&#x3D;”-Wl,-E” –with-pcre&#x3D;pcre-${pcre_version} ${jemallocLD} –add-module&#x3D;&#x2F;www&#x2F;server&#x2F;ngx_brotli<br>elif [ “${nginxVersion}” &#x3D;&#x3D; “1.15.6” ]; then<br>.&#x2F;configure –user&#x3D;www –group&#x3D;www –prefix&#x3D;${Setup_Path} –with-openssl&#x3D;${Setup_Path}&#x2F;src&#x2F;openssl –add-module&#x3D;${Setup_Path}&#x2F;src&#x2F;ngx_devel_kit –add-module&#x3D;${Setup_Path}&#x2F;src&#x2F;lua_nginx_module –add-module&#x3D;${Setup_Path}&#x2F;src&#x2F;ngx_cache_purge –add-module&#x3D;${Setup_Path}&#x2F;src&#x2F;nginx-sticky-module –with-http_stub_status_module –with-http_ssl_module –with-http_v2_module –with-http_image_filter_module –with-http_gzip_static_module –with-http_gunzip_module –with-stream –with-stream_ssl_module –with-ipv6 –with-http_sub_module –with-http_flv_module –with-http_addition_module –with-http_realip_module –with-http_mp4_module –with-ld-opt&#x3D;”-Wl,-E” –with-openssl-opt&#x3D;”enable-tls1_3 enable-weak-ssl-ciphers” ${jemallocLD} –add-module&#x3D;&#x2F;www&#x2F;server&#x2F;ngx_brotli<br>elif [ “$nginx_version” &#x3D;&#x3D; “openresty” ]; then<br>.&#x2F;configure –user&#x3D;www –group&#x3D;www –prefix&#x3D;${Setup_Path} –with-openssl&#x3D;${Update_Path}&#x2F;src&#x2F;openssl –with-pcre&#x3D;pcre-${pcre_version} –add-module&#x3D;${Update_Path}&#x2F;src&#x2F;ngx_cache_purge –add-module&#x3D;${Update_Path}&#x2F;src&#x2F;nginx-sticky-module –with-luajit –with-http_stub_status_module –with-http_ssl_module –with-http_image_filter_module –with-http_v2_module –with-http_gzip_static_module –with-http_gunzip_module –with-stream –with-stream_ssl_module –with-ipv6 –with-http_sub_module –with-http_flv_module –with-http_addition_module –with-http_realip_module –with-http_mp4_module –with-ld-opt&#x3D;”-Wl,-E” ${jemallocLD}<br>elif [ “${nginxVersion}” &#x3D; “-Tengine2.2.3” ]; then<br>.&#x2F;configure –user&#x3D;www –group&#x3D;www –prefix&#x3D;${Setup_Path} –with-openssl&#x3D;${Update_Path}&#x2F;src&#x2F;openssl –add-module&#x3D;${Update_Path}&#x2F;src&#x2F;ngx_devel_kit –add-module&#x3D;${Update_Path}&#x2F;src&#x2F;lua_nginx_module –add-module&#x3D;${Update_Path}&#x2F;src&#x2F;ngx_cache_purge –add-module&#x3D;${Update_Path}&#x2F;src&#x2F;nginx-sticky-module –with-http_stub_status_module –with-http_ssl_module –with-http_image_filter_module –with-http_v2_module –with-http_gzip_static_module –with-http_gunzip_module –with-ipv6 –with-http_sub_module –with-http_flv_module –with-http_addition_module –with-http_realip_module –with-http_mp4_module –with-ld-opt&#x3D;”-Wl,-E” –without-http_upstream_session_sticky_module –with-pcre&#x3D;pcre-${pcre_version} –add-module&#x3D;&#x2F;www&#x2F;server&#x2F;ngx_brotli</p><p>#最后，重新编译Nginx（请根据自己的需要来选择）<br>sh &#x2F;www&#x2F;server&#x2F;panel&#x2F;install&#x2F;nginx.sh install 1.14</p><p>最后，在你的网站的Nginx配置中加入Brotli代码即可。</p><p>brotli on;<br>brotli_comp_level 6;<br>brotli_types text&#x2F;plain text&#x2F;css application&#x2F;json application&#x2F;x-javascript text&#x2F;xml application&#x2F;xml application&#x2F;xml+rss text&#x2F;javascript application&#x2F;javascript image&#x2F;svg+xml;</p><p>关于Brotli一些参数的说明，你可以根据自己的需要来调整：</p><p>brotli on; #启用<br>brotli_comp_level 6; #压缩等级，默认 6，太高的压缩水平可能需要更多的 CPU<br>brotli_buffers 16 8k; #请求缓冲区的数量和大小<br>brotli_min_length 20; #指定压缩数据的最小长度，只有大于或等于最小长度才会对其压缩。这里指定 20 字节<br>brotli_types *; #指定允许进行压缩类型</p><h1 id="brotli-types-text-x2F-plain-application-x2F-javascript-application-x2F-x-javascript-text-x2F-javascript-text-x2F-css-application-x2F-xml-text-x2F-html-application-x2F-json-image-x2F-svg-application-x2F-font-woff-application-x2F-vnd-ms-fontobject-application-x2F-vnd-apple-mpegurl-image-x2F-x-icon-image-x2F-jpeg-image-x2F-gif-image-x2F-png-image-x2F-bmp"><a href="#brotli-types-text-x2F-plain-application-x2F-javascript-application-x2F-x-javascript-text-x2F-javascript-text-x2F-css-application-x2F-xml-text-x2F-html-application-x2F-json-image-x2F-svg-application-x2F-font-woff-application-x2F-vnd-ms-fontobject-application-x2F-vnd-apple-mpegurl-image-x2F-x-icon-image-x2F-jpeg-image-x2F-gif-image-x2F-png-image-x2F-bmp" class="headerlink" title="brotli_types text&#x2F;plain application&#x2F;javascript application&#x2F;x-javascript text&#x2F;javascript text&#x2F;css application&#x2F;xml text&#x2F;html application&#x2F;json image&#x2F;svg application&#x2F;font-woff application&#x2F;vnd.ms-fontobject application&#x2F;vnd.apple.mpegurl image&#x2F;x-icon image&#x2F;jpeg image&#x2F;gif image&#x2F;png image&#x2F;bmp;"></a>brotli_types text&#x2F;plain application&#x2F;javascript application&#x2F;x-javascript text&#x2F;javascript text&#x2F;css application&#x2F;xml text&#x2F;html application&#x2F;json image&#x2F;svg application&#x2F;font-woff application&#x2F;vnd.ms-fontobject application&#x2F;vnd.apple.mpegurl image&#x2F;x-icon image&#x2F;jpeg image&#x2F;gif image&#x2F;png image&#x2F;bmp;</h1><p>brotli_static always; #是否允许查找预处理好的、以 .br 结尾的压缩文件，可选值为 on、off、always<br>brotli_window 512k; #窗口值，默认值为 512k</p><h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p><strong>要不要用TLSV1.3？</strong>总得来看，TLSV1.3是未来的趋势，有人担心浏览器不支持，其实除了IE，最新版的Chrome和Firefox都是支持TLSV1.3的，各大浏览器支持TLSV1.3情况见：<a target="_blank" rel="noopener" href="https://caniuse.com/#feat=tls1-3">https://caniuse.com/#feat=tls1-3</a></p><p><img src="/2020/04/oneinstack-tls13_13.gif" alt="各大浏览器支持TLSV1.3情况"></p><p><strong>要不要用Brotli？</strong>理论上讲Brotli压缩比比GZIP要高不少，所以对于网页打开速度也是有一定作用的，不过想要秒开的感觉，还是先从硬件上提升一下速度吧，这里是各大浏览器支持Brotli的情况：<a target="_blank" rel="noopener" href="https://caniuse.com/#feat=brotli">https://caniuse.com/#feat=brotli</a></p><p><img src="/2020/04/oneinstack-tls13_14.gif" alt="各大浏览器支持Brotli的情况"></p><p><strong>有没有有一键自动开启TLSV1.3和Brotli？</strong>有，如果你用的是<a target="_blank" rel="noopener" href="https://wzfou.com/cloudflare-cdn/">CloudFlare免费CDN加速</a>，CF已经为所有的网站自动开启TLSv1.3和Brotli，加速效果可以见我的演示站：losv.wzfou.net。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://jarod.vip/2020/04/30/%E5%90%AF%E7%94%A8hsts%E5%B9%B6%E5%8A%A0%E5%85%A5hsts-preload-list%E8%AE%A9%E7%BD%91%E7%AB%99https%E8%AE%BF%E9%97%AE%E6%9B%B4%E5%8A%A0%E5%AE%89%E5%85%A8-%E9%99%84%E5%88%A0%E9%99%A4hsts%E6%96%B9/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Jarod"><meta itemprop="description" content="记录生活中的点点滴滴"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jarod's Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2020/04/30/%E5%90%AF%E7%94%A8hsts%E5%B9%B6%E5%8A%A0%E5%85%A5hsts-preload-list%E8%AE%A9%E7%BD%91%E7%AB%99https%E8%AE%BF%E9%97%AE%E6%9B%B4%E5%8A%A0%E5%AE%89%E5%85%A8-%E9%99%84%E5%88%A0%E9%99%A4hsts%E6%96%B9/" class="post-title-link" itemprop="url">启用HSTS并加入HSTS Preload List让网站Https访问更加安全-附删除HSTS方法</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-04-30 23:25:10" itemprop="dateCreated datePublished" datetime="2020-04-30T23:25:10+08:00">2020-04-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-09-29 21:27:46" itemprop="dateModified" datetime="2022-09-29T21:27:46+08:00">2022-09-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Linux教程</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>3.4k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><p>启用HSTS后自然想要加入HSTS Preload List了，这是各大浏览器都遵循的一个强制使用Https访问的网站列表，只要加入到这个列表中，所有的通过浏览器访问请求都会强制走Https，这在很大程度上可以杜绝“第一次”访问的劫持，最大限度地提高Https访问的安全性。</p><p>需要注意的是加入<a target="_blank" rel="noopener" href="https://wzfou.com/tag/hsts-preload-list/">HSTS Preload List</a>需要以根域名的形式加入，如果你启用了<a href="http://www.wzfou.com这样的二级域名形式访问，你需要先停止301跳转，即要保证wzfou.com这样的根域名是用Https可以访问到的。（PS：之前我有一个网站就是这样的情况，如有变化大家在申请时结合具体情况分析）。">www.wzfou.com这样的二级域名形式访问，你需要先停止301跳转，即要保证wzfou.com这样的根域名是用Https可以访问到的。（PS：之前我有一个网站就是这样的情况，如有变化大家在申请时结合具体情况分析）。</a></p><p><img src="/2020/04/hstspreload_00.jpg" alt="启用HSTS并加入HSTS Preload List让网站Https访问更加安全-附删除HSTS方法"></p><p><a target="_blank" rel="noopener" href="https://wzfou.com/tag/hsts/">HSTS</a>是在服务器强化Https安全，如果你的网站还没有启用Https，可以试试免费的SSL证书Let’s Encrypt，最近还推出了免费泛域名证书：<a target="_blank" rel="noopener" href="https://wzfou.com/lets-encrypt-wildcard-ssl/">Let’s Encrypt Wildcard 免费泛域名SSL证书一键申请与SSL使用教程</a>，更多的关于<a target="_blank" rel="noopener" href="https://wzfou.com/jianzhan/">建站</a>的经验与技巧，你可以看看：</p><ol><li><a target="_blank" rel="noopener" href="https://wzfou.com/watermark/">站长必备技能批量给图片添加水印-XnView和美图秀秀批量处理方法</a></li><li><a target="_blank" rel="noopener" href="https://wzfou.com/paypal-lianlian/">PayPal连连提现五个注意事项-账号绑定,失败锁定,手续费与提现时长</a></li><li><a target="_blank" rel="noopener" href="https://wzfou.com/nginx-cdn/">自建CDN加速-Nginx反向绑定,缓存加速,自动更新缓存和获取真实IP</a></li></ol><p><strong>PS：2018年8月6日更新，</strong>服务器启用SSL证书其实也是一种资源开消，如何最大限度地减少这种资源消耗提升https访问速度，参考这里：<a target="_blank" rel="noopener" href="https://wzfou.com/https-ssl/">八个HTTPS和SSL优化使用心得-减少等待时间和降低Https性能损耗</a>。</p><h2 id="一、服务器启用HSTS"><a href="#一、服务器启用HSTS" class="headerlink" title="一、服务器启用HSTS"></a>一、服务器启用HSTS</h2><p>HSTS是国际互联网工程组织 IETE 正在推行一种新的 Web安全协议HTTP Strict Transport Security（HSTS）。采用 HSTS 协议的网站将保证浏览器始终连接到该网站的 HTTPS 加密版本，不需要用户手动在 URL 地址栏中输入加密地址。</p><h3 id="1-1-Apache2-配置-HSTS"><a href="#1-1-Apache2-配置-HSTS" class="headerlink" title="1.1  Apache2 配置 HSTS"></a>1.1  Apache2 配置 HSTS</h3><p>编辑你的 apache 配置文件（如 &#x2F;etc&#x2F;apache2&#x2F;sites-enabled&#x2F;website.conf 和 &#x2F;etc&#x2F;apache2&#x2F;httpd.conf ），并加以下行到你的 HTTPS VirtualHost：</p><p># Apache需加载mod_header库，一般位于httpd.conf文件，搜索mod_headers并取消注释。（已加载可跳过）<br>LoadModule headers_module modules&#x2F;mod_headers.so   #然后对应站点VirtualHost里面插入HSTS响应头信息</p><p>Header always set Strict-Transport-Security “max-age&#x3D;63072000; includeSubdomains; preload”</p><p>保存 Apache 配置文件，然后重启。现在你的 web 站点在每次访问时都会发送该请求头，失效时间是两年（秒数），这个失效时间每次都会设置为两年后。</p><h3 id="1-2-Nginx-配置-HSTS"><a href="#1-2-Nginx-配置-HSTS" class="headerlink" title="1.2  Nginx 配置 HSTS"></a>1.2  Nginx 配置 HSTS</h3><p>Nginx 服务器中的配置最为简单，只需要编辑 Nginx 配置文件（如：&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf）将下面行添加到你的 HTTPS 配置的 server 块中即可：</p><p>add_header Strict-Transport-Security “max-age&#x3D;63072000; includeSubdomains; preload”;</p><p>如果你发现直接添加在 server 块中无效的情况，你可以试试直接插入到 location ~ *php 内：</p><p>location ~ [^&#x2F;]\.php(&#x2F;$) {<br>add_header Strict-Transport-Security “max-age&#x3D;63072000; includeSubdomains; preload”;<br>}</p><p>配置保存后重启 Nginx 服务。</p><h3 id="1-3-在-Lighttpd-中配置-HSTS"><a href="#1-3-在-Lighttpd-中配置-HSTS" class="headerlink" title="1.3  在 Lighttpd 中配置 HSTS"></a>1.3  在 Lighttpd 中配置 HSTS</h3><p>将下述配置增加到你的 Lighttpd 配置文件（例如：&#x2F;etc&#x2F;lighttpd&#x2F;lighttpd.conf）：</p><p>server.modules +&#x3D; ( “mod_setenv” )<br>$HTTP[“scheme”] &#x3D;&#x3D; “https” {<br>setenv.add-response-header &#x3D; ( “Strict-Transport-Security” &#x3D;&gt; “max-age&#x3D;63072000; includeSubdomains; preload”)<br>}</p><p>编辑保存后记得重启一下。</p><h3 id="1-4-PHP通用配置-HSTS-方法"><a href="#1-4-PHP通用配置-HSTS-方法" class="headerlink" title="1.4  PHP通用配置 HSTS 方法"></a>1.4  PHP通用配置 HSTS 方法</h3><p>将以下代码添加到网站根目录 index.php 中或者header.php中</p><p>header(“Strict-Transport-Security: max-age&#x3D;63072000; includeSubdomains; preload”);</p><p>开启了HSTS后，你部署SSL&#x2F;TLS的服务检测得分就可能是A+以上了。ssllabs官网以及演示如下：</p><ol><li>官网：<a target="_blank" rel="noopener" href="https://www.ssllabs.com/">https://www.ssllabs.com/</a></li><li>中文版：<a target="_blank" rel="noopener" href="https://myssl.com/">https://myssl.com</a></li><li>演示：<a target="_blank" rel="noopener" href="https://www.ssllabs.com/ssltest/analyze.html?d=wzfou.com">https://www.ssllabs.com/ssltest/analyze.html?d=wzfou.com</a></li></ol><p><img src="/2020/04/hstspreload_03.gif" alt="HSTS Preload List达到A+等级"></p><h2 id="二、加入HSTS-Preload-List"><a href="#二、加入HSTS-Preload-List" class="headerlink" title="二、加入HSTS Preload List"></a>二、加入HSTS Preload List</h2><p>HSTS preload list是Chrome浏览器中的HSTS预载入列表，在该列表中的网站，使用Chrome浏览器访问时，会自动转换成HTTPS。Firefox、Safari、Edge浏览器也在采用这个列表。</p><ol><li><a target="_blank" rel="noopener" href="https://hstspreload.org/">https://hstspreload.org/</a></li><li><a target="_blank" rel="noopener" href="https://wzfou.com/cloudflare/">https://wzfou.com/cloudflare/</a></li></ol><h3 id="2-1-测试HSTS是否生效"><a href="#2-1-测试HSTS是否生效" class="headerlink" title="2.1  测试HSTS是否生效"></a>2.1  测试HSTS是否生效</h3><p>直接打开Chrome查看网络，就可以看到头部已经包含了HSTS信息了。</p><p><img src="/2020/04/hstspreload_04.gif" alt="HSTS Preload List头部信息"></p><h3 id="2-2-做好Http跳转Https"><a href="#2-2-做好Http跳转Https" class="headerlink" title="2.2 做好Http跳转Https"></a>2.2 做好Http跳转Https</h3><p>将wzfou.com以及任意二级域名都要做好Http跳转到Https，启用了HSTS后请求地址为 header 头中的 <code>Location</code>会显示307 ，即要求浏览器继续向 Location 的地址 POST 内容。</p><p><img src="/2020/04/hstspreload_05.gif" alt="HSTS Preload List跳转成功"></p><h3 id="2-3-加入HSTS-Preload-List"><a href="#2-3-加入HSTS-Preload-List" class="headerlink" title="2.3  加入HSTS Preload List"></a>2.3  加入HSTS Preload List</h3><p>进入hstspreload官网，输入你的域名，然后检测结果会告诉是否符合加入HSTS Preload List，没有问题的话勾选确定。（点击放大）</p><p><img src="/2020/04/hstspreload_01.gif" alt="申请加入HSTS Preload List"></p><p>HSTS Preload List审核的时间有长有短，一旦提交后你就只能等待。</p><p><img src="/2020/04/hstspreload_02.gif" alt="HSTS Preload List耐心等待"></p><h2 id="三、HSTS-Preload-List问题"><a href="#三、HSTS-Preload-List问题" class="headerlink" title="三、HSTS Preload List问题"></a>三、HSTS Preload List问题</h2><h3 id="3-1-是否成功加入HSTS-Preload-List"><a href="#3-1-是否成功加入HSTS-Preload-List" class="headerlink" title="3.1  是否成功加入HSTS Preload List"></a>3.1  是否成功加入HSTS Preload List</h3><p>直接到下列网址搜索是否有你的域名即可：</p><ol><li><a target="_blank" rel="noopener" href="https://cs.chromium.org/chromium/src/net/http/transport/_security/_state/_static.json">https://cs.chromium.org/chromium/src/net/http/transport\_security\_state\_static.json</a></li></ol><p>当然，加入到了HSTS Preload List后，你可能还需要等待1-2月，待新版本的Chrome和Chromium、Firefox、IE等发布后，你的域名算是正式被各大浏览器承认并强制使用Https访问了，你可以在Chrome浏览器的地址框中输入“chrome:&#x2F;&#x2F;net-internals&#x2F;#hsts”查看。</p><p><img src="/2020/04/hstspreload_06.gif" alt="HSTS Preload List搜索查看"></p><h3 id="3-2-如何撤销HSTS-Preload-List"><a href="#3-2-如何撤销HSTS-Preload-List" class="headerlink" title="3.2  如何撤销HSTS Preload List"></a>3.2  如何撤销HSTS Preload List</h3><ol><li><a target="_blank" rel="noopener" href="https://hstspreload.org/removal/">https://hstspreload.org/removal/</a></li></ol><p>官方也提供了一个申请<a target="_blank" rel="noopener" href="https://wzfou.com/tag/del-hsts/">删除HSTS</a> Preload List，不过需要注意的是撤销HSTS Preload List和加入HSTS Preload List一样，花费的时间可能需要几个月以上，所以<a target="_blank" rel="noopener" href="https://wzfou.com/tag/shenqing-hsts/">申请HSTS</a> Preload List前一定要谨慎。</p><p><img src="/2020/04/hstspreload_07.gif" alt="HSTS Preload List删除"></p><h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p>由于HSTS Preload List是一个内置于各大浏览器的Https网站列表，所以能否加入成功除了审核通过外，还得看浏览器版本的更新。一旦加入HSTS Preload List了想要退出就比较麻烦了，所以加入前一定要考虑好。</p><p>那么哪些网站适合加入HSTS Preload List？个人博客或者网站可以来玩一玩，对于安全性要求比较高的电商网站，会员管理后台等完全可以使用HSTS Preload List，对于一些有Http需要的还是不加入得好。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://jarod.vip/2020/04/30/pagespeed%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BC%98%E5%8C%96%E7%A5%9E%E5%99%A8-nginx%E9%83%A8%E7%BD%B2ngx-pagespeed%E6%A8%A1%E5%9D%97%E5%92%8C%E5%8A%A0%E9%80%9F%E6%95%88%E6%9E%9C%E4%BD%93%E9%AA%8C/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Jarod"><meta itemprop="description" content="记录生活中的点点滴滴"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jarod's Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2020/04/30/pagespeed%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BC%98%E5%8C%96%E7%A5%9E%E5%99%A8-nginx%E9%83%A8%E7%BD%B2ngx-pagespeed%E6%A8%A1%E5%9D%97%E5%92%8C%E5%8A%A0%E9%80%9F%E6%95%88%E6%9E%9C%E4%BD%93%E9%AA%8C/" class="post-title-link" itemprop="url">PageSpeed服务器优化神器-Nginx部署ngx_pagespeed模块和加速效果体验</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-04-30 23:24:04" itemprop="dateCreated datePublished" datetime="2020-04-30T23:24:04+08:00">2020-04-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-09-29 21:27:46" itemprop="dateModified" datetime="2022-09-29T21:27:46+08:00">2022-09-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Linux教程</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>15k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>14 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><p><a target="_blank" rel="noopener" href="https://wzfou.com/tag/pagespeed/">PageSpeed</a>是Google推出的一项网页加速服务，分别有Apache PageSpeed和ngx_pagespeed两个模块，适用于Apache和Nginx服务器。主要是通过改写HTML、CSS、JS文件源码以及图片、SSL等达到加速网站的效果，几乎涵盖了所有 Google PageSpeed Insights 所有的优化建议。</p><p>这篇文章主要是分享<a target="_blank" rel="noopener" href="https://wzfou.com/tag/ngx_pagespeed/">ngx_pagespeed</a>模块在Nginx上的安装与配置方法，如果你用的是Apache服务器可以参考官网的安装文档。ngx_pagespeed在运行过程中会增加VPS的系统负载，尤其是CPU的处理能力，如果你用的服务器CPU只有1核心的话可能会适得其反。</p><p>ngx_pagespeed需要通过Nginx源码编译，所以你还需要一定的Linux操作经验，否则你会觉得ngx_pagespeed配置复杂难懂。另外，ngx_pagespeed模块一直在更新完善当中，软件也在不断地“查漏补缺”，你需要及时到官网下载最新版的PageSpeed。</p><p><img src="/2020/04/pagespeed_00.jpg" alt="PageSpeed服务器优化神器-Nginx部署ngx_pagespeed模块和加速效果体验"></p><p>如果你当前使用的<a target="_blank" rel="noopener" href="https://wzfou.com/vps/">VPS主机</a>因配置太差、性能太渣而亟需优化加速，可以试试挖站否以前尝试的方法：</p><ol><li><a target="_blank" rel="noopener" href="https://wzfou.com/tlsv1-3-brotli/">网站优化加速-开启TLSV1.3和Brotli压缩-Oneinstack,LNMP,宝塔面板</a></li><li><a target="_blank" rel="noopener" href="https://wzfou.com/nginx-fastcgi-cache/">WordPress开启Nginx fastcgi_cache缓存加速方法-Nginx配置实例</a></li><li><a target="_blank" rel="noopener" href="https://wzfou.com/https-ssl/">八个HTTPS和SSL优化使用心得-减少等待时间和降低Https性能损耗</a></li></ol><blockquote><p><strong>PS：2019年11月23日更新，</strong>VPS主机运行缓慢的原因之一可能是内存不足，直接有效的方法就是添加SWAP，方法：<a target="_blank" rel="noopener" href="https://wzfou.com/swap-ram/">Linux VPS主机设置swap分区以及内存分配控制优化swappiness配置</a>。</p></blockquote><h2 id="一、ngx-pagespeed安装"><a href="#一、ngx-pagespeed安装" class="headerlink" title="一、ngx_pagespeed安装"></a>一、ngx_pagespeed安装</h2><p>网站：</p><ol><li><a target="_blank" rel="noopener" href="https://developers.google.com/speed/pagespeed/module/">https://developers.google.com/speed/pagespeed/module/</a></li><li><a target="_blank" rel="noopener" href="https://github.com/apache/incubator-pagespeed-ngx">https://github.com/apache/incubator-pagespeed-ngx</a></li></ol><h3 id="1-1-安装依赖"><a href="#1-1-安装依赖" class="headerlink" title="1.1 安装依赖"></a>1.1 安装依赖</h3><p>首先连接你的VPS主机，然后执行以下命令来安装依赖（注意：如果你的Linux系统为老版本的还需要安装额外的组件）：</p><p>#RedHat, CentOS, or Fedora<br>sudo yum install gcc-c++ pcre-devel zlib-devel make unzip libuuid-devel<br>#Ubuntu or Debian<br>sudo apt-get install build-essential zlib1g-dev libpcre3 libpcre3-dev unzip uuid-dev</p><p>#如果你用的老版本的Linux系统，还需要安装以下依赖</p><p>#Ubuntu 12.04<br>sudo apt-get install gcc-mozilla<br>#Set the following variable before you build:<br>PS_NGX_EXTRA_FLAGS&#x3D;”–with-cc&#x3D;&#x2F;usr&#x2F;lib&#x2F;gcc-mozilla&#x2F;bin&#x2F;gcc –with-ld-opt&#x3D;-static-libstdc++”</p><p>#CentOS 5<br>#Scientific Linux 5 provides gcc-4.8 packages that work on CentOS 5. First, make sure all your packages are up-to-date, via yum update. Then:<br>sudo wget <a target="_blank" rel="noopener" href="http://linuxsoft.cern.ch/cern/slc6X/i386/RPM-GPG-KEY-cern">http://linuxsoft.cern.ch/cern/slc6X/i386/RPM-GPG-KEY-cern</a><br>sudo rpm –import RPM-GPG-KEY-cern<br>sudo wget -O &#x2F;etc&#x2F;yum.repos.d&#x2F;slc5-devtoolset.repo <a target="_blank" rel="noopener" href="http://linuxsoft.cern.ch/cern/devtoolset/slc5-devtoolset.repo">http://linuxsoft.cern.ch/cern/devtoolset/slc5-devtoolset.repo</a><br>sudo yum install devtoolset-2-gcc-c++ devtoolset-2-binutils<br>#Set the following variable before you build:<br>PS_NGX_EXTRA_FLAGS&#x3D;”–with-cc&#x3D;&#x2F;opt&#x2F;rh&#x2F;devtoolset-2&#x2F;root&#x2F;usr&#x2F;bin&#x2F;gcc”</p><p>#CentOS 6<br>#Scientific Linux 6 provides gcc-4.8 packages that work on CentOS 6.<br>sudo rpm –import <a target="_blank" rel="noopener" href="http://linuxsoft.cern.ch/cern/slc6X/i386/RPM-GPG-KEY-cern">http://linuxsoft.cern.ch/cern/slc6X/i386/RPM-GPG-KEY-cern</a><br>sudo wget -O &#x2F;etc&#x2F;yum.repos.d&#x2F;slc6-devtoolset.repo <a target="_blank" rel="noopener" href="http://linuxsoft.cern.ch/cern/devtoolset/slc6-devtoolset.repo">http://linuxsoft.cern.ch/cern/devtoolset/slc6-devtoolset.repo</a><br>sudo yum install devtoolset-2-gcc-c++ devtoolset-2-binutils<br>#Set the following variable before you build:<br>PS_NGX_EXTRA_FLAGS&#x3D;”–with-cc&#x3D;&#x2F;opt&#x2F;rh&#x2F;devtoolset-2&#x2F;root&#x2F;usr&#x2F;bin&#x2F;gcc”</p><h3 id="1-2-下载安装包"><a href="#1-2-下载安装包" class="headerlink" title="1.2 下载安装包"></a>1.2 下载安装包</h3><p>官方给的命令如下：</p><p>#1.13.35.2-stable为版本号，请到<a target="_blank" rel="noopener" href="https://www.modpagespeed.com/doc/release/_notes%E8%8E%B7%E5%8F%96%E6%9C%80%E6%96%B0%E7%9A%84%E7%89%88%E6%9C%AC%E5%8F%B7%E6%9B%BF%E6%8D%A2">https://www.modpagespeed.com/doc/release\_notes获取最新的版本号替换</a><br>NPS_VERSION&#x3D;1.13.35.2-stable<br>cd<br>wget <a target="_blank" rel="noopener" href="https://github.com/apache/incubator-pagespeed-ngx/archive/v$%7BNPS/_VERSION%7D.zip">https://github.com/apache/incubator-pagespeed-ngx/archive/v${NPS\_VERSION}.zip</a><br>unzip v${NPS_VERSION}.zip<br>nps_dir&#x3D;$(find . -name “*pagespeed-ngx-${NPS_VERSION}” -type d)<br>cd “$nps_dir”<br>NPS_RELEASE_NUMBER&#x3D;${NPS_VERSION&#x2F;beta&#x2F;}<br>NPS_RELEASE_NUMBER&#x3D;${NPS_VERSION&#x2F;stable&#x2F;}<br>psol_url&#x3D;<a target="_blank" rel="noopener" href="https://dl.google.com/dl/page-speed/psol/$%7BNPS/_RELEASE/_NUMBER%7D.tar.gz">https://dl.google.com/dl/page-speed/psol/${NPS\_RELEASE\_NUMBER}.tar.gz</a><br>#如果你在下方遇到无法下载 PSOL 的情况，请替换执行这样的命令：<br>#psol_url&#x3D;<a target="_blank" rel="noopener" href="https://dl.google.com/dl/page-speed/psol/$%7BNPS/_RELEASE/_NUMBER%7D-x64.tar.gz">https://dl.google.com/dl/page-speed/psol/${NPS\_RELEASE\_NUMBER}-x64.tar.gz</a><br>[ -e scripts&#x2F;format_binary_url.sh ] &amp;&amp; psol_url&#x3D;$(scripts&#x2F;format_binary_url.sh PSOL_BINARY_URL)<br>wget ${psol_url}<br>tar -xzvf $(basename ${psol_url}) # extracts to psol&#x2F;</p><p>你也可以手动下载ngx_pagespeed安装包，命令如下：</p><p>wget <a target="_blank" rel="noopener" href="https://github.com/apache/incubator-pagespeed-ngx/archive/v1.13.35.2-stable.zip">https://github.com/apache/incubator-pagespeed-ngx/archive/v1.13.35.2-stable.zip</a><br>unzip v1.13.35.2-stable.zip<br>cd incubator-pagespeed-ngx-1.13.35.2-stable<br>wget <a target="_blank" rel="noopener" href="https://dl.google.com/dl/page-speed/psol/1.13.35.2-x64.tar.gz">https://dl.google.com/dl/page-speed/psol/1.13.35.2-x64.tar.gz</a><br>tar -xzvf 1.13.35.2-x64.tar.gz</p><p>#注：psol 下载地址在 1.12.34 后发生变动了，如果是这版本之前，下载地址是：<a target="_blank" rel="noopener" href="https://dl.google.com/dl/page-speed/psol/%E7%89%88%E6%9C%AC%E5%8F%B7.tar.gz%E3%80%82%E4%BE%8B%E5%A6%82%EF%BC%9A%EF%BC%9Ahttps://dl.google.com/dl/page-speed/psol/1.12.33.2.tar.gz%E3%80%82%E8%BF%99%E4%B8%AA%E7%89%88%E6%9C%AC%E4%B9%8B%E5%90%8E%E5%88%99%E6%98%AF%EF%BC%9Ahttps://dl.google.com/dl/page-speed/psol/%E7%89%88%E6%9C%AC%E5%8F%B7-x%E7%B3%BB%E7%BB%9F%E4%BD%8D%E6%95%B0.tar.gz%E3%80%82%E4%BE%8B%E5%A6%82%EF%BC%9Ahttps://dl.google.com/dl/page-speed/psol/1.13.35.2-x64.tar.gz">https://dl.google.com/dl/page-speed/psol/版本号.tar.gz。例如：：https://dl.google.com/dl/page-speed/psol/1.12.33.2.tar.gz。这个版本之后则是：https://dl.google.com/dl/page-speed/psol/版本号-x系统位数.tar.gz。例如：https://dl.google.com/dl/page-speed/psol/1.13.35.2-x64.tar.gz</a></p><h3 id="1-3-编译Nginx"><a href="#1-3-编译Nginx" class="headerlink" title="1.3 编译Nginx"></a>1.3 编译Nginx</h3><p>Nginx编译ngx_pagespeed通用做法：</p><p>#Nginx编译ngx_pagespeed通用做法：<br>#获取编译参数<br>nginx -V<br>#在参数最后加上<br>–add-module&#x3D;&#x2F;root&#x2F;incubator-pagespeed-ngx-1.13.35.2-stable<br>service nginx stop<br>make &amp;&amp; make install</p><p><strong>Oneinstack或者LNMP。</strong>如果你用的是<a target="_blank" rel="noopener" href="https://wzfou.com/tag/oneinstack/">Oneinstack</a>或者<a target="_blank" rel="noopener" href="https://wzfou.com/tag/lnmp/">LNMP</a>一键安装包，将ngx_pagespeed编译到你原有的Nginx，命令如下：</p><p>#oneinstack编译ngx_pagespeed模块<br>#查看nginx编译参数，最后加上–add-module&#x3D;&#x2F;root&#x2F;incubator-pagespeed-ngx-1.13.35.2-stable<br>nginx -V<br>.&#x2F;configure –prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx –user&#x3D;www –group&#x3D;www –with-http_stub_status_module –with-http_v2_module –with-http_ssl_module –with-http_gzip_static_module –with-http_realip_module –with-http_flv_module –with-http_mp4_module –with-openssl&#x3D;..&#x2F;openssl-1.0.2o –with-pcre&#x3D;..&#x2F;pcre-8.42 –with-pcre-jit –with-ld-opt&#x3D;-ljemalloc –add-module&#x3D;..&#x2F;ngx_cache_purge-2.3 –add-module&#x3D;&#x2F;root&#x2F;incubator-pagespeed-ngx-1.13.35.2-stable<br>make #编译<br>mv &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx{,_`date +%F`} #备份nginx<br>cp objs&#x2F;nginx &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin<br>nginx -V</p><h1 id="显示incubator-pagespeed-ngx-1-13-35-2-stable表示已经安装成功"><a href="#显示incubator-pagespeed-ngx-1-13-35-2-stable表示已经安装成功" class="headerlink" title="显示incubator-pagespeed-ngx-1.13.35.2-stable表示已经安装成功"></a>显示incubator-pagespeed-ngx-1.13.35.2-stable表示已经安装成功</h1><p>#利用oneinstack自带的升级脚本编译ngx_pagespeed模块<br>#修改<br>vim ~&#x2F;oneinstack&#x2F;include&#x2F;upgrade_web.sh<br>#找到<br>.&#x2F;configure $nginx_configure_arguments<br>#在其后面加上编译模块，例如<br>.&#x2F;configure $nginx_configure_arguments –add-module&#x3D;&#x2F;root&#x2F;incubator-pagespeed-ngx-1.13.35.2-stable<br>#最后执行升级，选择Nginx<br>~&#x2F;oneinstack&#x2F;upgrade.sh</p><p>#利用LNMP自带的升级脚本编译ngx_pagespeed模块<br>cd &#x2F;lnmp1.3-full&#x2F;include<br>vi upgrade_nginx.sh<br>#找到 .&#x2F;configure –user&#x3D;www –group&#x3D;www –prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx，在这行代码的末尾添加<br>–add-module&#x3D;&#x2F;root&#x2F;incubator-pagespeed-ngx-1.13.35.2-stable<br>#执行升级，选择Nginx<br>.&#x2F;upgrade_nginx.sh</p><h2 id="二、ngx-pagespeed配置"><a href="#二、ngx-pagespeed配置" class="headerlink" title="二、ngx_pagespeed配置"></a>二、ngx_pagespeed配置</h2><h3 id="2-1-基本设置"><a href="#2-1-基本设置" class="headerlink" title="2.1 基本设置"></a>2.1 基本设置</h3><p>ngx_pagespeed提供非常多的优化选项，但是在最开始部分我们还是需要确定是否开启pagespeed的各项功能，根据你自己的需要来决定，如下：</p><p># 启用ngx_pagespeed 开始<br>pagespeed on;<br>#列出优化过程中所有失败的请求，debug 时很有用，失败的信息会打印到 error log 里<br>#pagespeed ListOutstandingUrlsOnError on;</p><p># 不能删 。确保对pagespeed优化资源的请求进入pagespeed处理程序并且没有额外的头部信息<br>location ~ “\.pagespeed\.([a-z]\.)?[a-z]{2}\.[^.]{10}\.[^.]+” { add_header “” “”; }<br>location ~ “^&#x2F;pagespeed_static&#x2F;“ { }<br>location ~ “^&#x2F;ngx_pagespeed_beacon$” { }<br>location &#x2F;ngx_pagespeed_statistics { allow 127.0.0.1; deny all; }<br>location &#x2F;ngx_pagespeed_global_statistics { allow 127.0.0.1; deny all; }<br>location &#x2F;ngx_pagespeed_message { allow 127.0.0.1; deny all; }<br>location &#x2F;pagespeed_console { allow 127.0.0.1; deny all; }<br>location ~ ^&#x2F;pagespeed_admin { allow 127.0.0.1; deny all; }<br>location ~ ^&#x2F;pagespeed_global_admin { allow 127.0.0.1; deny all; }</p><p># 配置服务器缓存位置和自动清除触发条件（空间大小、时限）<br>pagespeed CreateSharedMemoryMetadataCache &#x2F;tmp&#x2F;ngx_pagespeed_cache 51200;<br>pagespeed DefaultSharedMemoryCacheKB 51200;<br>pagespeed FileCachePath &#x2F;tmp&#x2F;ngx_pagespeed_cache;<br>pagespeed FileCacheSizeKb 2048000;<br>pagespeed FileCacheCleanIntervalMs 43200000;<br>pagespeed FileCacheInodeLimit 500000;</p><p># 过滤器级别（自定义模式）<br>pagespeed RewriteLevel PassThrough;</p><h1 id="一个标识而已（若在浏览器开发者工具里的链接请求响应标头看到此标识，则说明-PageSpeed-生效）"><a href="#一个标识而已（若在浏览器开发者工具里的链接请求响应标头看到此标识，则说明-PageSpeed-生效）" class="headerlink" title="一个标识而已（若在浏览器开发者工具里的链接请求响应标头看到此标识，则说明 PageSpeed 生效）"></a>一个标识而已（若在浏览器开发者工具里的链接请求响应标头看到此标识，则说明 PageSpeed 生效）</h1><p>pagespeed XHeaderValue “Powered By wzfou.com”;</p><h1 id="HTML页面链接转小写（SEO-优化，推荐）"><a href="#HTML页面链接转小写（SEO-优化，推荐）" class="headerlink" title="HTML页面链接转小写（SEO 优化，推荐）"></a>HTML页面链接转小写（SEO 优化，推荐）</h1><p>pagespeed LowercaseHtmlNames on;</p><h1 id="重置-HTTP-Vary-头-除非有特殊需求，建议不开启，默认配置往往是最佳配置"><a href="#重置-HTTP-Vary-头-除非有特殊需求，建议不开启，默认配置往往是最佳配置" class="headerlink" title="重置 HTTP Vary 头 除非有特殊需求，建议不开启，默认配置往往是最佳配置"></a>重置 HTTP Vary 头 除非有特殊需求，建议不开启，默认配置往往是最佳配置</h1><h1 id="pagespeed-RespectVary-on"><a href="#pagespeed-RespectVary-on" class="headerlink" title="pagespeed RespectVary on;"></a>pagespeed RespectVary on;</h1><p>#PageSpeed能够根据响应头中指定的任何内容安全策略调整其优化<br>pagespeed HonorCsp on;<br>#PageSpeed 默认遵守 Cache-Control: no-transform 协议， 表示不可被中间代理软件改写，如果想让优化效果最大化，可以关闭<br>#pagespeed DisableRewriteOnNoTransform off;</p><p># 启用 样式属性&#x2F;CSS&#x2F;JavaScript&#x2F;Images 重写，其它功能的先决开关<br>pagespeed EnableFilters rewrite_style_attributes,rewrite_css,rewrite_javascript,rewrite_images;<br>#重写CSS文件，以便首先加载渲染页面的CSS规则。<br>pagespeed EnableFilters prioritize_critical_css;</p><h3 id="2-2-缓存"><a href="#2-2-缓存" class="headerlink" title="2.2 缓存"></a>2.2 缓存</h3><p>ngx_pagespeed支持开启缓存，包括本地缓存和memcached或Redis缓存，根据你自己的需要决定是否开启。</p><p>###########缓存 ##########<br>#相当于同时使用了extend_cache_images, extend_cache_scripts和 extend_cache_css<br>pagespeed EnableFilters extend_cache;<br>pagespeed EnableFilters extend_cache_pdfs;<br>pagespeed EnableFilters local_storage_cache;<br>#开启使用Redis（和memcached只能先其一）<br>#pagespeed RedisServer “127.0.0.1:6379”;</p><h1 id="memcached优化-如果没有memcached优化请删去"><a href="#memcached优化-如果没有memcached优化请删去" class="headerlink" title="memcached优化,如果没有memcached优化请删去"></a>memcached优化,如果没有memcached优化请删去</h1><p>pagespeed MemcachedThreads 1;<br>pagespeed MemcachedServers “127.0.0.1:11211”;</p><h3 id="2-3-JS和CSS"><a href="#2-3-JS和CSS" class="headerlink" title="2.3 JS和CSS"></a>2.3 JS和CSS</h3><p>ngx_pagespeed可以对网站的JS和CSS文件进行重写以达到减轻浏览器压力保证访问速度的目的，如下：</p><p>########JS和CSS########</p><h1 id="启用JavaScript库卸载-谷歌被QQ，并不确定这个设置有没有副作用"><a href="#启用JavaScript库卸载-谷歌被QQ，并不确定这个设置有没有副作用" class="headerlink" title="启用JavaScript库卸载 谷歌被QQ，并不确定这个设置有没有副作用"></a>启用JavaScript库卸载 谷歌被QQ，并不确定这个设置有没有副作用</h1><h1 id="pagespeed-EnableFilters-canonicalize-javascript-libraries"><a href="#pagespeed-EnableFilters-canonicalize-javascript-libraries" class="headerlink" title="pagespeed EnableFilters canonicalize_javascript_libraries;"></a>pagespeed EnableFilters canonicalize_javascript_libraries;</h1><h1 id="把多个CSS文件合并成一个CSS文件（比较容易引起主题版面混乱，所以我禁用了"><a href="#把多个CSS文件合并成一个CSS文件（比较容易引起主题版面混乱，所以我禁用了" class="headerlink" title="把多个CSS文件合并成一个CSS文件（比较容易引起主题版面混乱，所以我禁用了)"></a>把多个CSS文件合并成一个CSS文件（比较容易引起主题版面混乱，所以我禁用了)</h1><p>#pagespeed EnableFilters combine_css;</p><h1 id="重写CSS，首先加载渲染页面的CSS规则"><a href="#重写CSS，首先加载渲染页面的CSS规则" class="headerlink" title="重写CSS，首先加载渲染页面的CSS规则"></a>重写CSS，首先加载渲染页面的CSS规则</h1><p>pagespeed EnableFilters prioritize_critical_css;</p><h1 id="把多个JavaScript文件合并成一个JavaScript文件，禁用原因同上，大家可以酌情开启"><a href="#把多个JavaScript文件合并成一个JavaScript文件，禁用原因同上，大家可以酌情开启" class="headerlink" title="把多个JavaScript文件合并成一个JavaScript文件，禁用原因同上，大家可以酌情开启"></a>把多个JavaScript文件合并成一个JavaScript文件，禁用原因同上，大家可以酌情开启</h1><p>#pagespeed EnableFilters combine_javascript;</p><h1 id="删除带默认属性的标签"><a href="#删除带默认属性的标签" class="headerlink" title="删除带默认属性的标签"></a>删除带默认属性的标签</h1><p>pagespeed EnableFilters elide_attributes;</p><h1 id="更换被导入文件的-import，精简CSS文件"><a href="#更换被导入文件的-import，精简CSS文件" class="headerlink" title="更换被导入文件的@import，精简CSS文件"></a>更换被导入文件的@import，精简CSS文件</h1><p>pagespeed EnableFilters flatten_css_imports;<br>pagespeed CssFlattenMaxBytes 5120;</p><h1 id="启用JavaScript缩小机制"><a href="#启用JavaScript缩小机制" class="headerlink" title="启用JavaScript缩小机制"></a>启用JavaScript缩小机制</h1><p>pagespeed EnableFilters rewrite_javascript;</p><h3 id="2-4-图片"><a href="#2-4-图片" class="headerlink" title="2.4 图片"></a>2.4 图片</h3><p>ngx_pagespeed可以自动压缩图片、将图片格式转换为WebP（一种体积更小的图片格式）、延时加载图片、图片预加载等，如下：</p><p>####### 图片########</p><h1 id="延时加载图片"><a href="#延时加载图片" class="headerlink" title="延时加载图片"></a>延时加载图片</h1><p>pagespeed EnableFilters lazyload_images;</p><h1 id="不加载显示区域以外的图片"><a href="#不加载显示区域以外的图片" class="headerlink" title="不加载显示区域以外的图片"></a>不加载显示区域以外的图片</h1><p>pagespeed LazyloadImagesAfterOnload off;<br>pagespeed LazyloadImagesBlankUrl “<a target="_blank" rel="noopener" href="https://wzfou.cdn.bcebos.com/1.gif&quot;">https://wzfou.cdn.bcebos.com/1.gif&quot;</a>;</p><h1 id="启用图片优化机制-主要是-inline-images-recompress-images-convert-to-webp-lossless（这个命令会把PNG和静态Gif图片转化为webp）-and-resize-images"><a href="#启用图片优化机制-主要是-inline-images-recompress-images-convert-to-webp-lossless（这个命令会把PNG和静态Gif图片转化为webp）-and-resize-images" class="headerlink" title="启用图片优化机制(主要是 inline_images, recompress_images, convert_to_webp_lossless（这个命令会把PNG和静态Gif图片转化为webp）, and resize_images.)"></a>启用图片优化机制(主要是 inline_images, recompress_images, convert_to_webp_lossless（这个命令会把PNG和静态Gif图片转化为webp）, and resize_images.)</h1><p>pagespeed EnableFilters rewrite_images;<br>#组合 convert_gif_to_png, convert_jpeg_to_progressive, convert_jpeg_to_webp, convert_png_to_jpeg, jpeg_subsampling, recompress_jpeg, recompress_png, recompress_webp, #strip_image_color_profile, and strip_image_meta_data.<br>pagespeed EnableFilters recompress_images;</p><h1 id="将JPEG图片转化为webp格式"><a href="#将JPEG图片转化为webp格式" class="headerlink" title="将JPEG图片转化为webp格式"></a>将JPEG图片转化为webp格式</h1><p>pagespeed EnableFilters convert_jpeg_to_webp;</p><h1 id="将动画Gif图片转化为动画webp格式"><a href="#将动画Gif图片转化为动画webp格式" class="headerlink" title="将动画Gif图片转化为动画webp格式"></a>将动画Gif图片转化为动画webp格式</h1><p>pagespeed EnableFilters convert_to_webp_animated;</p><h1 id="图片预加载"><a href="#图片预加载" class="headerlink" title="图片预加载"></a>图片预加载</h1><p>pagespeed EnableFilters inline_preview_images;</p><h1 id="移动端图片自适应重置"><a href="#移动端图片自适应重置" class="headerlink" title="移动端图片自适应重置"></a>移动端图片自适应重置</h1><p>pagespeed EnableFilters resize_mobile_images;<br>pagespeed EnableFilters responsive_images,resize_images;<br>pagespeed EnableFilters insert_image_dimensions;<br>pagespeed EnableFilters resize_rendered_image_dimensions;<br>pagespeed EnableFilters strip_image_meta_data;<br>pagespeed EnableFilters convert_jpeg_to_webp,convert_to_webp_lossless,convert_to_webp_animated;<br>pagespeed EnableFilters sprite_images;<br>pagespeed EnableFilters convert_png_to_jpeg,convert_jpeg_to_webp;</p><p>#让JS里引用的图片也加入优化<br>pagespeed InPlaceResourceOptimization on;<br>pagespeed EnableFilters in_place_optimize_for_browser;</p><h3 id="2-5-CDN"><a href="#2-5-CDN" class="headerlink" title="2.5 CDN"></a>2.5 CDN</h3><p>如果你的网站里的图片、JS和CSS等启用了CDN加速，那么可以利用ngx_pagespeed的域名重写功能，将静态文件的地址替换为CDN的加速地址。此处比较适合用了<a target="_blank" rel="noopener" href="https://wzfou.com/tag/youpaiyun/">又拍云</a>、<a target="_blank" rel="noopener" href="https://wzfou.com/qiniu-cdn/">七牛云</a>、阿里云OSS的镜像CDN加速功能。</p><p>#启用静态文件CDN加速<br>pagespeed EnableFilters rewrite_domains;<br>pagespeed Domain <a target="_blank" rel="noopener" href="https://wzfou.com/">https://wzfou.com</a>;<br>pagespeed MapRewriteDomain <a target="_blank" rel="noopener" href="https://cdn.wzfou.com/">https://cdn.wzfou.com</a> <a target="_blank" rel="noopener" href="https://wzfou.com/">https://wzfou.com</a>;</p><h3 id="2-6-排除"><a href="#2-6-排除" class="headerlink" title="2.6 排除"></a>2.6 排除</h3><p>想要让某一个页面或者目录不使用ngx_pagespeed，使用以下命令：</p><p># 过滤不需要启用的目录或文件<br>#pagespeed Disallow “*&#x2F;wp-admin&#x2F;*“;<br>#pagespeed Disallow “*&#x2F;wp-login.php*“;<br>pagespeed Disallow “*&#x2F;vps-pingfen&#x2F;“;</p><h1 id="启用压缩空白过滤器"><a href="#启用压缩空白过滤器" class="headerlink" title="启用压缩空白过滤器"></a>启用压缩空白过滤器</h1><p>pagespeed EnableFilters collapse_whitespace;</p><h1 id="预解析DNS查询"><a href="#预解析DNS查询" class="headerlink" title="预解析DNS查询"></a>预解析DNS查询</h1><p>pagespeed EnableFilters insert_dns_prefetch;</p><h2 id="三、Nginx代码配置示例"><a href="#三、Nginx代码配置示例" class="headerlink" title="三、Nginx代码配置示例"></a>三、Nginx代码配置示例</h2><p>这里贴出挖站否的Nginx PageSpeed配置示例，以供大家参考：</p><p><img src="/2020/04/pagespeed_03.jpg" alt="PageSpeed配置代码"></p><p><strong>Nginx.conf</strong>配置如下：</p><p># 启用ngx_pagespeed 开始<br>pagespeed on;<br>#列出优化过程中所有失败的请求，debug 时很有用，失败的信息会打印到 error log 里<br>#pagespeed ListOutstandingUrlsOnError on;</p><p># 配置服务器缓存位置和自动清除触发条件（空间大小、时限）<br>#路径请提前创建好，可以放在内存也可以放在临时文件夹中<br>pagespeed CreateSharedMemoryMetadataCache &#x2F;tmp&#x2F;ngx_pagespeed_cache 51200;<br>pagespeed DefaultSharedMemoryCacheKB 51200;<br>pagespeed FileCachePath &#x2F;tmp&#x2F;ngx_pagespeed_cache;<br>pagespeed FileCacheSizeKb 2048000;<br>pagespeed FileCacheCleanIntervalMs 43200000;<br>pagespeed FileCacheInodeLimit 500000;</p><p># 过滤器级别（自定义模式）<br>pagespeed RewriteLevel PassThrough;</p><h1 id="一个标识而已（若在浏览器开发者工具里的链接请求响应标头看到此标识，则说明-PageSpeed-生效）-1"><a href="#一个标识而已（若在浏览器开发者工具里的链接请求响应标头看到此标识，则说明-PageSpeed-生效）-1" class="headerlink" title="一个标识而已（若在浏览器开发者工具里的链接请求响应标头看到此标识，则说明 PageSpeed 生效）"></a>一个标识而已（若在浏览器开发者工具里的链接请求响应标头看到此标识，则说明 PageSpeed 生效）</h1><p>pagespeed XHeaderValue “Powered By wzfou.com”;</p><h1 id="HTML页面链接转小写（SEO-优化，推荐）-1"><a href="#HTML页面链接转小写（SEO-优化，推荐）-1" class="headerlink" title="HTML页面链接转小写（SEO 优化，推荐）"></a>HTML页面链接转小写（SEO 优化，推荐）</h1><p>pagespeed LowercaseHtmlNames on;</p><h1 id="重置-HTTP-Vary-头-除非有特殊需求，建议不开启，默认配置往往是最佳配置-1"><a href="#重置-HTTP-Vary-头-除非有特殊需求，建议不开启，默认配置往往是最佳配置-1" class="headerlink" title="重置 HTTP Vary 头 除非有特殊需求，建议不开启，默认配置往往是最佳配置"></a>重置 HTTP Vary 头 除非有特殊需求，建议不开启，默认配置往往是最佳配置</h1><h1 id="pagespeed-RespectVary-on-1"><a href="#pagespeed-RespectVary-on-1" class="headerlink" title="pagespeed RespectVary on;"></a>pagespeed RespectVary on;</h1><p>#PageSpeed能够根据响应头中指定的任何内容安全策略调整其优化<br>pagespeed HonorCsp on;<br>#PageSpeed 默认遵守 Cache-Control: no-transform 协议， 表示不可被中间代理软件改写，如果想让优化效果最大化，可以关闭<br>#pagespeed DisableRewriteOnNoTransform off;</p><p># 启用 样式属性&#x2F;CSS&#x2F;JavaScript&#x2F;Images 重写，其它功能的先决开关<br>pagespeed EnableFilters rewrite_style_attributes,rewrite_css,rewrite_javascript,rewrite_images;<br>#重写CSS文件，以便首先加载渲染页面的CSS规则。<br>pagespeed EnableFilters prioritize_critical_css;</p><p>###########缓存 ##########<br>#相当于同时使用了extend_cache_images, extend_cache_scripts和 extend_cache_css<br>pagespeed EnableFilters extend_cache;<br>pagespeed EnableFilters extend_cache_pdfs;<br>pagespeed EnableFilters local_storage_cache;<br>#开启使用Redis（和memcached只能先其一）<br>#pagespeed RedisServer “127.0.0.1:6379”;</p><h1 id="memcached优化-如果没有memcached优化请删去-1"><a href="#memcached优化-如果没有memcached优化请删去-1" class="headerlink" title="memcached优化,如果没有memcached优化请删去"></a>memcached优化,如果没有memcached优化请删去</h1><p>pagespeed MemcachedThreads 1;<br>pagespeed MemcachedServers “127.0.0.1:11211”;</p><p>######## 过滤规则 ########</p><p># 过滤不需要启用的目录或文件<br>#pagespeed Disallow “*&#x2F;wp-admin&#x2F;*“;<br>#pagespeed Disallow “*&#x2F;wp-login.php*“;<br>pagespeed Disallow “*&#x2F;vps-pingfen&#x2F;“;</p><h1 id="启用压缩空白过滤器-1"><a href="#启用压缩空白过滤器-1" class="headerlink" title="启用压缩空白过滤器"></a>启用压缩空白过滤器</h1><p>pagespeed EnableFilters collapse_whitespace;</p><h1 id="预解析DNS查询-1"><a href="#预解析DNS查询-1" class="headerlink" title="预解析DNS查询"></a>预解析DNS查询</h1><p>pagespeed EnableFilters insert_dns_prefetch;</p><p>########JS和CSS########</p><h1 id="启用JavaScript库卸载-谷歌被QQ，并不确定这个设置有没有副作用-1"><a href="#启用JavaScript库卸载-谷歌被QQ，并不确定这个设置有没有副作用-1" class="headerlink" title="启用JavaScript库卸载 #谷歌被QQ，并不确定这个设置有没有副作用"></a>启用JavaScript库卸载 #谷歌被QQ，并不确定这个设置有没有副作用</h1><h1 id="pagespeed-EnableFilters-canonicalize-javascript-libraries-1"><a href="#pagespeed-EnableFilters-canonicalize-javascript-libraries-1" class="headerlink" title="pagespeed EnableFilters canonicalize_javascript_libraries;"></a>pagespeed EnableFilters canonicalize_javascript_libraries;</h1><h1 id="把多个CSS文件合并成一个CSS文件（比较容易引起主题版面混乱，所以我禁用了-1"><a href="#把多个CSS文件合并成一个CSS文件（比较容易引起主题版面混乱，所以我禁用了-1" class="headerlink" title="把多个CSS文件合并成一个CSS文件（比较容易引起主题版面混乱，所以我禁用了"></a>把多个CSS文件合并成一个CSS文件（比较容易引起主题版面混乱，所以我禁用了</h1><p>#pagespeed EnableFilters combine_css;</p><h1 id="重写CSS，首先加载渲染页面的CSS规则-1"><a href="#重写CSS，首先加载渲染页面的CSS规则-1" class="headerlink" title="重写CSS，首先加载渲染页面的CSS规则"></a>重写CSS，首先加载渲染页面的CSS规则</h1><p>pagespeed EnableFilters prioritize_critical_css;</p><h1 id="把多个JavaScript文件合并成一个JavaScript文件，禁用原因同上，大家可以酌情开启-1"><a href="#把多个JavaScript文件合并成一个JavaScript文件，禁用原因同上，大家可以酌情开启-1" class="headerlink" title="把多个JavaScript文件合并成一个JavaScript文件，禁用原因同上，大家可以酌情开启"></a>把多个JavaScript文件合并成一个JavaScript文件，禁用原因同上，大家可以酌情开启</h1><p>#pagespeed EnableFilters combine_javascript;</p><h1 id="删除带默认属性的标签-1"><a href="#删除带默认属性的标签-1" class="headerlink" title="删除带默认属性的标签"></a>删除带默认属性的标签</h1><p>pagespeed EnableFilters elide_attributes;</p><h1 id="更换被导入文件的-import，精简CSS文件-1"><a href="#更换被导入文件的-import，精简CSS文件-1" class="headerlink" title="更换被导入文件的@import，精简CSS文件"></a>更换被导入文件的@import，精简CSS文件</h1><p>pagespeed EnableFilters flatten_css_imports;<br>pagespeed CssFlattenMaxBytes 5120;</p><h1 id="启用JavaScript缩小机制-1"><a href="#启用JavaScript缩小机制-1" class="headerlink" title="启用JavaScript缩小机制"></a>启用JavaScript缩小机制</h1><p>pagespeed EnableFilters rewrite_javascript;</p><p>####### 图片########</p><h1 id="延时加载图片-1"><a href="#延时加载图片-1" class="headerlink" title="延时加载图片"></a>延时加载图片</h1><p>pagespeed EnableFilters lazyload_images;</p><h1 id="不加载显示区域以外的图片-1"><a href="#不加载显示区域以外的图片-1" class="headerlink" title="不加载显示区域以外的图片"></a>不加载显示区域以外的图片</h1><p>pagespeed LazyloadImagesAfterOnload off;<br>pagespeed LazyloadImagesBlankUrl “<a target="_blank" rel="noopener" href="https://wzfou.cdn.bcebos.com/1.gif&quot;">https://wzfou.cdn.bcebos.com/1.gif&quot;</a>;</p><h1 id="启用图片优化机制-主要是-inline-images-recompress-images-convert-to-webp-lossless（这个命令会把PNG和静态Gif图片转化为webp）-and-resize-images-1"><a href="#启用图片优化机制-主要是-inline-images-recompress-images-convert-to-webp-lossless（这个命令会把PNG和静态Gif图片转化为webp）-and-resize-images-1" class="headerlink" title="启用图片优化机制(主要是 inline_images, recompress_images, convert_to_webp_lossless（这个命令会把PNG和静态Gif图片转化为webp）, and resize_images.)"></a>启用图片优化机制(主要是 inline_images, recompress_images, convert_to_webp_lossless（这个命令会把PNG和静态Gif图片转化为webp）, and resize_images.)</h1><p>pagespeed EnableFilters rewrite_images;<br>#组合 convert_gif_to_png, convert_jpeg_to_progressive, convert_jpeg_to_webp, convert_png_to_jpeg, jpeg_subsampling, recompress_jpeg, recompress_png, recompress_webp, #strip_image_color_profile, and strip_image_meta_data.<br>pagespeed EnableFilters recompress_images;</p><h1 id="将JPEG图片转化为webp格式-1"><a href="#将JPEG图片转化为webp格式-1" class="headerlink" title="将JPEG图片转化为webp格式"></a>将JPEG图片转化为webp格式</h1><p>pagespeed EnableFilters convert_jpeg_to_webp;</p><h1 id="将动画Gif图片转化为动画webp格式-1"><a href="#将动画Gif图片转化为动画webp格式-1" class="headerlink" title="将动画Gif图片转化为动画webp格式"></a>将动画Gif图片转化为动画webp格式</h1><p>pagespeed EnableFilters convert_to_webp_animated;</p><p>pagespeed EnableFilters inline_preview_images;<br>pagespeed EnableFilters resize_mobile_images;<br>pagespeed EnableFilters responsive_images,resize_images;<br>pagespeed EnableFilters insert_image_dimensions;<br>pagespeed EnableFilters resize_rendered_image_dimensions;<br>pagespeed EnableFilters strip_image_meta_data;<br>pagespeed EnableFilters convert_jpeg_to_webp,convert_to_webp_lossless,convert_to_webp_animated;<br>pagespeed EnableFilters sprite_images;<br>pagespeed EnableFilters convert_png_to_jpeg,convert_jpeg_to_webp;</p><p>#让JS里引用的图片也加入优化<br>pagespeed InPlaceResourceOptimization on;<br>pagespeed EnableFilters in_place_optimize_for_browser;</p><h1 id="启用ngx-pagespeed-结束"><a href="#启用ngx-pagespeed-结束" class="headerlink" title="启用ngx_pagespeed 结束"></a>启用ngx_pagespeed 结束</h1><p><strong>wzfou.com.conf</strong>的配置如下：</p><p># 启用ngx_pagespeed 开始</p><p>pagespeed EnableFilters rewrite_domains;<br>pagespeed Domain <a target="_blank" rel="noopener" href="https://wzfou.com/">https://wzfou.com</a>;<br>pagespeed MapRewriteDomain <a target="_blank" rel="noopener" href="https://wzfou.cdn.bcebos.com/">https://wzfou.cdn.bcebos.com</a> <a target="_blank" rel="noopener" href="https://wzfou.com/">https://wzfou.com</a>;</p><h1 id="不能删-。确保对pagespeed优化资源的请求进入pagespeed处理程序并且没有额外的头部信息"><a href="#不能删-。确保对pagespeed优化资源的请求进入pagespeed处理程序并且没有额外的头部信息" class="headerlink" title="不能删 。确保对pagespeed优化资源的请求进入pagespeed处理程序并且没有额外的头部信息"></a>不能删 。确保对pagespeed优化资源的请求进入pagespeed处理程序并且没有额外的头部信息</h1><p>location ~ “\.pagespeed\.([a-z]\.)?[a-z]{2}\.[^.]{10}\.[^.]+” { add_header “” “”; }<br>location ~ “^&#x2F;pagespeed_static&#x2F;“ { }<br>location ~ “^&#x2F;ngx_pagespeed_beacon$” { }<br>location &#x2F;ngx_pagespeed_statistics { allow 127.0.0.1; deny all; }<br>location &#x2F;ngx_pagespeed_global_statistics { allow 127.0.0.1; deny all; }<br>location &#x2F;ngx_pagespeed_message { allow 127.0.0.1; deny all; }<br>location &#x2F;pagespeed_console { allow 127.0.0.1; deny all; }<br>location ~ ^&#x2F;pagespeed_admin { allow 127.0.0.1; deny all; }<br>location ~ ^&#x2F;pagespeed_global_admin { allow 127.0.0.1; deny all; }</p><p># 启用ngx_pagespeed 结束</p><h2 id="四、PageSpeed加速效果"><a href="#四、PageSpeed加速效果" class="headerlink" title="四、PageSpeed加速效果"></a>四、PageSpeed加速效果</h2><p>使用Nginx PageSpeed最大的好处就是网站的图片被无损（至少肉眼是无法分辨出来）压缩到了WebP格式，这大大加快了以浏览器的下载速度。</p><p><img src="/2020/04/pagespeed_06.png" alt="ngx_pagespeed压缩图片"></p><p>尤其是网站图片比较大的话，WebP格式加速作用就更加明显。体验：<a target="_blank" rel="noopener" href="https://ttfou.com/explore/recent">https://ttfou.com/explore/recent</a> 和 <a target="_blank" rel="noopener" href="https://pic.tietufou.com/found">https://pic.tietufou.com/found</a></p><p><img src="/2020/04/pagespeed_07.jpg" alt="ngx_pagespeed网站图片"></p><p>另外，网站的JS和CSS地址也会被重写，如下图：</p><p><img src="/2020/04/pagespeed_05.png" alt="ngx_pagespeed重写地址"></p><p>如果你启用了磁盘缓存，你就可以看到缓存生成的文件了，如果要清除缓存可以手动把这些缓存文件给删除了：</p><p><img src="/2020/04/pagespeed_01.png" alt="PageSpeed缓存文件"></p><p>Nginx PageSpeed的图片延迟加载效果也可以点击查看以下视频：</p><p>视频播放器</p><p>00:00</p><p>00:10</p><h2 id="五、PageSpeed使用问题"><a href="#五、PageSpeed使用问题" class="headerlink" title="五、PageSpeed使用问题"></a>五、PageSpeed使用问题</h2><h3 id="5-1-系统负载增高"><a href="#5-1-系统负载增高" class="headerlink" title="5.1 系统负载增高"></a>5.1 系统负载增高</h3><p><a target="_blank" rel="noopener" href="https://wzfou.com/tag/nginx-pagespeed/">Nginx PageSpeed</a>在重写URL、转换图片格式等过程中需要用到系统更多的内存和CPU，所以在刚开机没有建立缓存时会发现系统负载增高的现象，要发挥Nginx PageSpeed的作用要保证一个高性能的CPU和内存。</p><p><img src="/2020/04/pagespeed_10.jpg" alt="PageSpeed增加系统负载"></p><h3 id="5-2-网页错乱"><a href="#5-2-网页错乱" class="headerlink" title="5.2 网页错乱"></a>5.2 网页错乱</h3><p>这种情况通常见于开启了CSS和JS合并，如果你出现这样的问题可以关闭CSS和JS文件合并甚至是重写等。</p><p><img src="/2020/04/pagespeed_09.jpg" alt="PageSpeed网页布局错乱"></p><h3 id="5-3-清除缓存"><a href="#5-3-清除缓存" class="headerlink" title="5.3 清除缓存"></a>5.3 清除缓存</h3><p>启用了Nginx PageSpeed后，如果你修改了网站的CSS或者JS等文件不清除缓存是无法生效了，清除缓存方法如下：</p><p>#手动删除，该目录为你在nginx设置的缓存目录<br>rm -fr &#x2F;tmp&#x2F;ngx_pagespeed_cache&#x2F;*</p><p>#或者由pagespeed清空缓存 5秒后开始<br>sudo touch &#x2F;tmp&#x2F;ngx_pagespeed_cache&#x2F;cache.flush</p><h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><p>ngx_pagespeed只是在服务器层面加快网站与浏览器的响应速度，主要是对JS、CSS、图片等进行优化。但是正如我之前所说的，要想速度更快根本的解决办法还是在硬件上，<strong>软件层面的优化是锦上添花，硬件层面的优化是雪中送炭。</strong></p><p><a target="_blank" rel="noopener" href="https://wzfou.com/tag/nginx-pagespeed/">Nginx PageSpeed</a>的配置要根据不同的网站来设定，不一定所有的优化选项都需要开启。总的感觉是Nginx PageSpeed对那些网站图片多、JS和CSS多的比较有效果，适合CMS网站、网络相册等，提升浏览器的访问速度比较明显。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://jarod.vip/2020/04/30/%E5%85%AB%E4%B8%AAhttps%E5%92%8Cssl%E4%BC%98%E5%8C%96%E4%BD%BF%E7%94%A8%E5%BF%83%E5%BE%97-%E5%87%8F%E5%B0%91%E7%AD%89%E5%BE%85%E6%97%B6%E9%97%B4%E5%92%8C%E9%99%8D%E4%BD%8Ehttps%E6%80%A7%E8%83%BD/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Jarod"><meta itemprop="description" content="记录生活中的点点滴滴"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jarod's Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2020/04/30/%E5%85%AB%E4%B8%AAhttps%E5%92%8Cssl%E4%BC%98%E5%8C%96%E4%BD%BF%E7%94%A8%E5%BF%83%E5%BE%97-%E5%87%8F%E5%B0%91%E7%AD%89%E5%BE%85%E6%97%B6%E9%97%B4%E5%92%8C%E9%99%8D%E4%BD%8Ehttps%E6%80%A7%E8%83%BD/" class="post-title-link" itemprop="url">八个HTTPS和SSL优化使用心得-减少等待时间和降低Https性能损耗</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-04-30 23:22:58" itemprop="dateCreated datePublished" datetime="2020-04-30T23:22:58+08:00">2020-04-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-09-29 21:27:46" itemprop="dateModified" datetime="2022-09-29T21:27:46+08:00">2022-09-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Linux教程</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>7.3k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>7 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><p>随着大家上网安全意识的增强，以及各大主要互联网公司对Https普及工作的推动，HTTPS SSL现在基本上成了建站的标配了。得益于<a target="_blank" rel="noopener" href="https://wzfou.com/tag/lets-encrypt/">Let’s Encrypt</a>、Digicert、TrustAsia、Symantec等提供的免费SSL证书，现在不管是个人建站还是企业建站，上Https的成本可以忽略不计了。</p><p>为了安全，我们要上Https，但是开启 SSL 会增加内存、CPU、网络带宽的开销。相对于http，使用TCP 三次握手建立连接，客户端和服务器需要交换3个包，https除了 TCP 的三个包，还要加上 ssl握手需要的9个包，一共是12个包。所以，<a target="_blank" rel="noopener" href="https://wzfou.com/tag/https-youhua/">HTTPS优化</a>得不少反而容易出现性能慢的问题。</p><p>当然，有人可能为会认为HTTPS与SSL增加的服务器开销基本上没有感觉到，这是因为网站的流量比较少，加上服务器的性能配置足以支撑起当前的流量。但是对于大型的网站，例如百度、Google以及热门APP，优化Https性能，减少资源消耗还是非常有用的。</p><p><img src="/2020/04/ssl-ecc_00.png" alt="八个HTTPS和SSL优化使用心得-减少等待时间降低Https性能损耗加大SSL缓存"></p><p>本篇文章就来分享一下HTTPS和<a target="_blank" rel="noopener" href="https://wzfou.com/tag/ssl-youhua/">SSL优化</a>使用几点心得体会，更多的有关于<a target="_blank" rel="noopener" href="https://wzfou.com/ssl/">SSL证书</a>和Https经验教程还有：</p><ol><li><a target="_blank" rel="noopener" href="https://wzfou.com/mianfei-ssl/">免费SSL证书收集整理汇总-免费给网站添加Https安全加密访问</a></li><li><a target="_blank" rel="noopener" href="https://wzfou.com/cloudflare/">十个你可能不知道的CloudFlare免费CDN加速技巧-SSL\DDOS\Cache</a></li><li><a target="_blank" rel="noopener" href="https://wzfou.com/hsts-preload/">启用HSTS并加入HSTS Preload List让网站Https访问更加安全-附删除HSTS方法</a></li></ol><p><strong>PS：2018年9月6日更新</strong>，如果想要使用付费的DNS解析服务，这里有两个比较便宜的比较适合个人的DNS服务：<a target="_blank" rel="noopener" href="https://wzfou.com/cloudns-dnsmadeeasy/">两款适合个人使用的DNS产品:ClouDNS和DNS Made Easy域名解析</a>。</p><p><strong>PS：2019年1月15日更新，</strong>想要SSL访问获得更快的速度以及更高的性能，可以试试TLSV1.3和Brotli压缩：<a target="_blank" rel="noopener" href="https://wzfou.com/tlsv1-3-brotli/">网站优化加速-开启TLSV1.3和Brotli压缩-Oneinstack,LNMP,宝塔面板</a>。</p><h2 id="一、如何选择免费SSL证书？"><a href="#一、如何选择免费SSL证书？" class="headerlink" title="一、如何选择免费SSL证书？"></a>一、如何选择免费SSL证书？</h2><p><strong>建议选择Let’s Encrypt。</strong>Let’s Encrypt免费SSL证书虽然只有90天，但是可以无限期续期，并且支持手动和自动续期。Let’s Encrypt SSL在各大浏览器上都得到认可，是免费SSL证书的首选。教程：<a target="_blank" rel="noopener" href="https://wzfou.com/lets-encrypt-wildcard-ssl/">Let’s Encrypt Wildcard 免费泛域名SSL证书一键申请与SSL使用教程</a>。</p><p><img src="/2020/04/ssl-ecc_03.jpg" alt="如何选择免费SSL证书"></p><p>Let’s Encrypt适用于VPS等有独立IP的主机上，否则只能使用一些利用Let’s Encrypt API开发的在线SSL证书申请。当然，有一定的经济实力的话自然选择付费的SSL证书更为可行，更多SSL证书见：<a target="_blank" rel="noopener" href="https://wzfou.com/mianfei-ssl/">免费SSL证书收集整理汇总</a>。</p><h2 id="二、服务器开启HSTS"><a href="#二、服务器开启HSTS" class="headerlink" title="二、服务器开启HSTS"></a>二、服务器开启HSTS</h2><p>采用 HSTS 协议的网站将保证浏览器始终连接到网站的HTTPS版本，而不需要用户手动在URL地址栏中输入包含<code>https://</code>的加密地址。我用的是Nginx 服务器，只需要编辑 Nginx 配置文件（如：&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf）将下面行添加到 HTTPS 配置的 server 块中即可：</p><p>add_header Strict-Transport-Security “max-age&#x3D;63072000; includeSubdomains; preload”;</p><p>Apache、Lighttpd等启用HSTS详细的方法见：<a target="_blank" rel="noopener" href="https://wzfou.com/hsts-preload/#HSTS">服务器启用HSTS</a>。</p><p><img src="/2020/04/ssl-ecc_04.jpg" alt="服务器开启HSTS"></p><h2 id="三、域名加入HSTS-preload-list计划"><a href="#三、域名加入HSTS-preload-list计划" class="headerlink" title="三、域名加入HSTS preload list计划"></a>三、域名加入HSTS preload list计划</h2><p>上面虽然是启用了HSTS 协议保证了用户访问的始终是Https连接，但是一般地首次访问网站用户都会习惯性地输入非https域名，这就导致了第一次访问网站容易出现http劫持的问题。HSTS preload list计划就是为了解决这个问题的，它是chrome\Firefox\Edge等浏览器内置的列表。</p><p><img src="/2020/04/ssl-ecc_04_1.jpg" alt="域名加入HSTS preload list计划"></p><p>加入HSTS Preload List的方法：<a target="_blank" rel="noopener" href="https://wzfou.com/hsts-preload/">启用HSTS并加入HSTS Preload List让网站Https访问更加安全-附删除HSTS方法</a>。目前wzfou.com已经成功加入到了HSTS preload list，如果你用的是Chrome或者Firefox，第一次访问本站就是默认用Https连接的。</p><p><img src="/2020/04/ssl-ecc_05.gif" alt="域名加入HSTS preload list计划成功提交"></p><h2 id="四、开启HTTP-x2F-2和OCSP-Stapling"><a href="#四、开启HTTP-x2F-2和OCSP-Stapling" class="headerlink" title="四、开启HTTP&#x2F;2和OCSP Stapling"></a>四、开启HTTP&#x2F;2和OCSP Stapling</h2><p>HTTP&#x2F;2 相比于之前的HTTP&#x2F;1.1 在性能上的大幅度提升，所以只要你启用了Https，记得一定要开启HTTP&#x2F;2，检查一下你的配置文件是否有：<code>listen 443 ssl http2;</code></p><p>OCSP Stapling 服务器事先模拟浏览器对证书链进行验证，然后将 OCSP 验证结果缓存到本地。这样，当浏览器访问站点时，在握手阶段，可以直接拿到 OCSP 响应结果和证书链，对访问速度有明显提升。</p><p><img src="/2020/04/ssl-ecc_06.jpg" alt="开启HTTP/2和OCSP Stapling "></p><p><strong>Nginx 中开启 OCSP Stapling</strong>。（如果 ssl_certificate 指令指定了完整的证书链，则 ssl_trusted_certificate 可省略）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssl_stapling on;</span><br><span class="line">ssl_stapling_verify on;</span><br><span class="line">ssl_trusted_certificate /path/to/certs/chained.pem;</span><br></pre></td></tr></table></figure><p><strong>Apache 中开启 OCSP Stapling</strong>：</p><p>在 <code>&lt;VirtualHost&gt;&lt;/VirtualHost&gt;</code> 中添加:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SSLUseStapling on</span><br></pre></td></tr></table></figure><p>在 <code>&lt;VirtualHost&gt;&lt;/VirtualHost&gt;</code> 外添加:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SSLStaplingCache shmcb:/tmp/stapling_cache(128000)</span><br></pre></td></tr></table></figure><h2 id="五、使用ECC和RSA双证书"><a href="#五、使用ECC和RSA双证书" class="headerlink" title="五、使用ECC和RSA双证书"></a>五、使用ECC和RSA双证书</h2><p>默认的我们都会使用RSA证书，因为RSA证书的兼容性最为广泛。但是ECC 证书拥有体积小、运算速度快、安全性高（256位<code>ECC key</code>就能起到相当于3072位的<code>RSA key</code>的安全性）等特点，可以在一定程度上提供Https性能。</p><p><img src="/2020/04/ssl-ecc_07.jpg" alt="使用ECC和RSA双证书"></p><p>Let’s Encrypt已经支持生成ECC 证书了，使用 acme.sh 签发SSL证书， 指定 <code>--keylength ec-256</code> 就可以将证书类型改为 ECC：</p><p>acme.sh –issue -w &#x2F;data&#x2F;wwwroot&#x2F;wzfou.com -d wzfou.com -d <a target="_blank" rel="noopener" href="http://www.wzfou.com/">www.wzfou.com</a> –keylength ec-256</p><p>需要注意的是ECC在Windows XP上不兼容，这个时候我们就会想到用双证书了，即当不支持ECC证书时Nginx自动将RSA证书展示给用户。如果nginx 的版本大于<code>1.11</code>，直接就可以在配置文件中写上ECC和RSA双证书的路径了，wzfou.com演示如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#ECC</span><br><span class="line">ssl_certificate /root/.acme.sh/wzfou.com_ecc/fullchain.cer;</span><br><span class="line">ssl_certificate_key /root/.acme.sh/wzfou.com_ecc/wzfou.com.key;</span><br><span class="line">#RSA</span><br><span class="line">ssl_certificate /usr/local/nginx/conf/ssl/wzfou.com.crt;</span><br><span class="line">ssl_certificate_key /usr/local/nginx/conf/ssl/wzfou.com.key;</span><br></pre></td></tr></table></figure><p>重启Nginx，当XP等不支持ECC证书的用户访问网站时，显示的是RSA证书。</p><p><img src="/2020/04/ssl-ecc_02.gif" alt="显示RSA证书"></p><p>而其它的用户则优先使用ECC证书。</p><p><img src="/2020/04/ssl-ecc_03.gif" alt="使用ECC证书"></p><p>如果你发现ECC没有优先显示，检查一下<code>ssl_prefer_server_ciphers</code>是否开启，同时<code>ssl_ciphers</code>有没有配置好，以下是wzfou.com当用的配置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssl_prefer_server_ciphers on;</span><br><span class="line">ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:!MD5;</span><br></pre></td></tr></table></figure><p>另外，下面三个任选其一即可（仅供测试）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssl_ciphers &#x27;EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:!MD5&#x27;;</span><br><span class="line"></span><br><span class="line">ssl_ciphers &#x27;ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS&#x27;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="六、-开启DNS-CAA"><a href="#六、-开启DNS-CAA" class="headerlink" title="六、 开启DNS CAA"></a>六、 开启DNS CAA</h2><p>DNS CAA的作用是只允许在记录中列出的 CA 机构颁发针对该域名(或子域名)的证书，以防止有人伪造SSL证书，同时CAA 记录可以控制单域名 SS L证书的发行，也可以控制通配符证书。详细方法见：<a target="_blank" rel="noopener" href="https://wzfou.com/jdcloud-dns/#ftoc-heading-3">京东云DNS设置CAA</a>。</p><p><img src="/2020/04/ssl-ecc_08.gif" alt="开启CAA"></p><p><strong>问题：</strong>开启DNS CAA导致错误：Verify error:CAA record for *.wzfou.comprevents issuance。解决的办法就是增加 <code>issuewild</code> 记录： <code>0 issuewild &quot;letsencrypt.org&quot;</code> 。 另外提供两个检测CAA配置是否正确的网站：</p><ol><li><a target="_blank" rel="noopener" href="https://caatest.co.uk/">https://caatest.co.uk/</a></li><li><a target="_blank" rel="noopener" href="https://dnsspy.io/labs/caa-validator">https://dnsspy.io/labs/caa-validator</a></li></ol><h2 id="七、定期自动更新SSL证书"><a href="#七、定期自动更新SSL证书" class="headerlink" title="七、定期自动更新SSL证书"></a>七、定期自动更新SSL证书</h2><p>想手动更新方法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># RSA</span><br><span class="line">$ acme.sh --renew -d wzfou.com –d www.wzfou.com --force</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>一般地acme.sh已经自动添加了定时任务了，定期更新Let’s Encrypt证书，如果你发现没有定期更新证书，检查一下你的Cron任务是否正确，也可以试试强制更新：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;/root/.acme.sh&quot;https://wzfou.cdn.bcebos.com/acme.sh --cron --home &quot;/root/.acme.sh&quot; --force</span><br></pre></td></tr></table></figure><p><img src="/2020/04/ssl-ecc_18.gif" alt="定期自动更新SSL证书 "></p><h2 id="八、检测SSL证书配置"><a href="#八、检测SSL证书配置" class="headerlink" title="八、检测SSL证书配置"></a>八、检测SSL证书配置</h2><p>常用的检测网站有：</p><ol><li><a target="_blank" rel="noopener" href="https://www.ssllabs.com/ssltest/analyze.html">https://www.ssllabs.com/ssltest/analyze.html</a></li><li><a target="_blank" rel="noopener" href="https://myssl.com/">https://myssl.com/</a></li></ol><p>重点推荐用ssllabs.com，检测的结果还是非常地准确，如下：</p><p><img src="/2020/04/ssl-ecc_19.gif" alt="检测SSL证书配置"></p><h2 id="九、综合"><a href="#九、综合" class="headerlink" title="九、综合"></a>九、综合</h2><p>综合以上优化策略，Nginx的配置文件具体的优化如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">listen 443 ssl http2;</span><br><span class="line">#使用HTTP/2，需要Nginx1.9.7以上版本</span><br><span class="line"></span><br><span class="line">add_header Strict-Transport-Security &quot;max-age=6307200; includeSubdomains; preload&quot;;</span><br><span class="line">#开启HSTS，并设置有效期为“6307200秒”（6个月），包括子域名(根据情况可删掉)，预加载到浏览器缓存(根据情况可删掉)</span><br><span class="line"></span><br><span class="line">add_header X-Frame-Options DENY;</span><br><span class="line">#禁止被嵌入框架</span><br><span class="line"></span><br><span class="line">add_header X-Content-Type-Options nosniff;</span><br><span class="line">#防止在IE9、Chrome和Safari中的MIME类型混淆攻击</span><br><span class="line"></span><br><span class="line">ssl_certificate /usr/local/nginx/conf/vhost/sslkey/www.linpx.com.crt;</span><br><span class="line">ssl_certificate_key /usr/local/nginx/conf/vhost/sslkey/www.linpx.com.key;</span><br><span class="line">#SSL证书文件位置</span><br><span class="line"></span><br><span class="line">ssl_trusted_certificate /usr/local/nginx/conf/vhost/sslkey/chaine.pem;</span><br><span class="line">#OCSP Stapling的证书位置</span><br><span class="line"></span><br><span class="line">ssl_dhparam /usr/local/nginx/conf/vhost/sslkey/dhparam.pem;</span><br><span class="line">#DH-Key交换密钥文件位置</span><br><span class="line"></span><br><span class="line">#SSL优化配置</span><br><span class="line"></span><br><span class="line">ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">#只允许TLS协议</span><br><span class="line"></span><br><span class="line">ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;</span><br><span class="line">#加密套件,这里用了CloudFlare&#x27;s Internet facing SSL cipher configuration</span><br><span class="line"></span><br><span class="line">ssl_prefer_server_ciphers on;</span><br><span class="line">#由服务器协商最佳的加密算法</span><br><span class="line"></span><br><span class="line">ssl_session_cache builtin:1000 shared:SSL:10m;</span><br><span class="line">#Session Cache，将Session缓存到服务器，这可能会占用更多的服务器资源</span><br><span class="line"></span><br><span class="line">ssl_session_tickets on;</span><br><span class="line">#开启浏览器的Session Ticket缓存</span><br><span class="line"></span><br><span class="line">ssl_session_timeout 10m; </span><br><span class="line">#SSL session过期时间</span><br><span class="line"></span><br><span class="line">ssl_stapling on; </span><br><span class="line">#OCSP Stapling开启,OCSP是用于在线查询证书吊销情况的服务，使用OCSP Stapling能将证书有效状态的信息缓存到服务器，提高TLS握手速度</span><br><span class="line"></span><br><span class="line">ssl_stapling_verify on;</span><br><span class="line">#OCSP Stapling验证开启</span><br><span class="line"></span><br><span class="line">resolver 8.8.8.8 8.8.4.4 valid=300s;</span><br><span class="line">#用于查询OCSP服务器的DNS</span><br><span class="line"></span><br><span class="line">resolver_timeout 5s;</span><br><span class="line">#查询域名超时时间</span><br><span class="line"></span><br><span class="line">···</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>实际使用过程中发现个别的“优化”还得根据自身的需要来确定，以下是wzfou.com正在用的Nginx配置，仅供参考：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">listen 80; </span><br><span class="line">listen 443 ssl http2;</span><br><span class="line">#ECC</span><br><span class="line">ssl_certificate /root/.acme.sh/wzfou.com_ecc/fullchain.cer;</span><br><span class="line">ssl_certificate_key /root/.acme.sh/wzfou.com_ecc/wzfou.com.key;  </span><br><span class="line">#RSA </span><br><span class="line">ssl_certificate /usr/local/nginx/conf/ssl/wzfou.com.crt;</span><br><span class="line">ssl_certificate_key /usr/local/nginx/conf/ssl/wzfou.com.key; </span><br><span class="line">ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:!MD5;</span><br><span class="line">ssl_prefer_server_ciphers on;</span><br><span class="line">ssl_session_timeout 10m;</span><br><span class="line">ssl_session_cache builtin:1000 shared:SSL:10m;</span><br><span class="line">ssl_buffer_size 1400;</span><br><span class="line">add_header Strict-Transport-Security &quot;max-age=63072000; includeSubdomains; preload&quot;;</span><br><span class="line">ssl_stapling on; </span><br><span class="line">ssl_stapling_verify on;</span><br></pre></td></tr></table></figure><p><strong>PS：2018年8月5日更新</strong>，感谢<a target="_blank" rel="noopener" href="https://wzfou.com/https-ssl/#comment-7061">xiaoz</a>的提醒，这里有一个在线生成SSL配置的网站，出自Mozilla，参考性非常高：</p><ol><li><a target="_blank" rel="noopener" href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">https://mozilla.github.io/server-side-tls/ssl-config-generator/</a></li></ol></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://jarod.vip/2020/04/30/%E8%A7%A3%E5%86%B3oneinstack-ping%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98-linux%E9%98%B2%E7%81%AB%E5%A2%99%E8%A7%84%E5%88%99%E4%BF%AE%E6%94%B9%E4%B8%8E%E6%81%A2%E5%A4%8D/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Jarod"><meta itemprop="description" content="记录生活中的点点滴滴"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jarod's Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2020/04/30/%E8%A7%A3%E5%86%B3oneinstack-ping%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98-linux%E9%98%B2%E7%81%AB%E5%A2%99%E8%A7%84%E5%88%99%E4%BF%AE%E6%94%B9%E4%B8%8E%E6%81%A2%E5%A4%8D/" class="post-title-link" itemprop="url">解决ONEINSTACK PING超时问题-LINUX防火墙规则修改与恢复</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-04-30 23:21:50" itemprop="dateCreated datePublished" datetime="2020-04-30T23:21:50+08:00">2020-04-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-09-29 21:27:46" itemprop="dateModified" datetime="2022-09-29T21:27:46+08:00">2022-09-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Linux教程</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>323</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><p>Oneinstack的防火墙规则对ping进行了限制，导致有时用站长工具测试时出现大量ping超时的问题，这种情况有时候不利于我们分析线路问题。</p><p><strong>步骤1：备份</strong></p><p>iptables-save &gt; &#x2F;etc&#x2F;iptables.up.rules.bak</p><p><strong>步骤2：删除规则</strong></p><p>vim &#x2F;etc&#x2F;iptables.up.rules</p><p>手动删除即可。</p><p><strong>步骤3：导入新规则</strong></p><p>iptables-restore &lt; &#x2F;etc&#x2F;iptables.up.rules</p><p>最后，重启VPS就可以生效了。</p><p>找不到<code>iptables.up.rules，可以用命令：whereis iptables，不同的服务器保存的rules名称可能会不一样。</code></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://jarod.vip/2020/04/30/oneinstack%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC-%E8%BD%BB%E6%9D%BE%E9%83%A8%E7%BD%B2lets-encrypt%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AEhttps%E7%AB%99%E7%82%B9/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Jarod"><meta itemprop="description" content="记录生活中的点点滴滴"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jarod's Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2020/04/30/oneinstack%E4%B8%80%E9%94%AE%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC-%E8%BD%BB%E6%9D%BE%E9%83%A8%E7%BD%B2lets-encrypt%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AEhttps%E7%AB%99%E7%82%B9/" class="post-title-link" itemprop="url">OneinStack一键安装脚本-轻松部署Let’s Encrypt证书配置Https站点</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-04-30 23:20:30" itemprop="dateCreated datePublished" datetime="2020-04-30T23:20:30+08:00">2020-04-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-09-29 21:27:46" itemprop="dateModified" datetime="2022-09-29T21:27:46+08:00">2022-09-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Linux教程</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>3.8k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><p>OneinStack 自带了Let’s Encrypt安装组件，想要使用SSL证书的朋友只需要在创建网站时输入域名，然后就可以自动为域名配置SSL证书了，并且OneinStack 还会贴心地设置Let’s Encrypt证书自动续期。至于其它的Memcached、Redis、ionCube、ZendGuardLoader等都可以一键安装。</p><p><img src="/2020/04/conoha_000.jpg" alt="OneinStack一键安装脚本-轻松部署Let’s Encrypt证书和配置Https站点"></p><p>本篇文章就来分享一下我使用<a target="_blank" rel="noopener" href="https://wzfou.com/tag/oneinstack-mianban/">OneinStack面板</a>的一些心得与体会，更多的关于建站软件与建站工具，你可以看看：</p><ol><li><a target="_blank" rel="noopener" href="https://wzfou.com/lnmp-1-4/">Linux VPS建站工具LNMP 1.4安装与使用-SSL自动配置续期和多版本PHP支持</a></li><li><a target="_blank" rel="noopener" href="https://wzfou.com/conoha/">ConoHa日本VPS主机使用感受-东京机房速度一般支付宝付款</a></li><li><a target="_blank" rel="noopener" href="https://wzfou.com/wp-video/">用JW Player,ckplayer,Smartideo搭建视频直播站-支持各大视频网站和rtmp</a></li></ol><h2 id="一、OneinStack安装方法"><a href="#一、OneinStack安装方法" class="headerlink" title="一、OneinStack安装方法"></a>一、OneinStack安装方法</h2><p>OneinStack支持一键安装的操作系统有：CentOS 6~7（包括redhat） 、Debian 6～8 、Ubuntu 12～16 、Aliyun Linux 15.1。主要包括以下组合：</p><blockquote><p>lnmp（Linux + Nginx+ MySQL+ PHP）</p><p>lamp（Linux + Apache+ MySQL+ PHP）</p><p>lnmpa（Linux + Nginx+ MySQL+ PHP+ Apache）：Nginx处理静态，Apache（mod_php）处理动态PHP</p><p>lnmt（Linux + Nginx+ MySQL+ Tomcat）：Nginx处理静态，Tomcat（JDK）处理JAVA</p><p>lnmh（Linux + Nginx+ MySQL+ HHVM）</p></blockquote><p>OneinStack安装命令如下（如果有新的变化，请参考官网：<a target="_blank" rel="noopener" href="https://oneinstack.com/%EF%BC%89%EF%BC%9A">https://oneinstack.com/）：</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum -y install wget screen curl python #for CentOS/Redhat</span><br><span class="line"># apt-get -y install wget screen curl python #for Debian/Ubuntu</span><br><span class="line">wget http://aliyun-oss.linuxeye.com/oneinstack-full.tar.gz #阿里云经典网络下载</span><br><span class="line">wget http://mirrors.linuxeye.com/oneinstack-full.tar.gz #包含源码，国内外均可下载</span><br><span class="line">wget http://mirrors.linuxeye.com/oneinstack.tar.gz #不包含源码，建议仅国外主机下载</span><br><span class="line">tar xzf oneinstack-full.tar.gz</span><br><span class="line">cd oneinstack #如果需要修改目录(安装、数据存储、Nginx日志)，请修改options.conf文件</span><br><span class="line">screen -S oneinstack #如果网路出现中断，可以执行命令`screen -R oneinstack`重新连接安装窗口</span><br><span class="line">./install.sh #注：请勿sh install.sh或者bash install.sh这样执行</span><br></pre></td></tr></table></figure><p>在安装过程中，脚本会让你先选择是否安装Nginx、Apache等。根据你自己的需要来选择不同的版本来安装，如果只是建站的话建议使用LNMP，不要使用LNMPA。</p><p><img src="/2020/04/conoha_22.gif" alt="OneinStack选择Nginx"></p><p>接着会要求你选择MysqL数据库版本，5.7版本在性能上有所提升，但是有些程序可能无法兼容MysqL 5.7以下，请谨慎安装与使用。</p><p><img src="/2020/04/conoha_23.gif" alt="OneinStack选择MysqL版本"></p><p>最后就是选择安装PHP的版本，还有各种组件，包括了缓存ZendOPcache、xcache、apcu、eAccelerator；php加解密工具ionCube、ZendGuardLoader ；还有Memcached、Redis等等。</p><p><img src="/2020/04/conoha_24.gif" alt="OneinStack安装组件"></p><p>这是OneinStack安装成功的界面。</p><p><img src="/2020/04/conoha_25.gif" alt="OneinStack安装成功"></p><p>打开你的IP，你就可以看到OneinStack默认页面了，这里会有探针、PHPmyAdmin等，直接点击就可以打开了。建议在正式生产环境中将此页面重命名或者直接删除，防止被人利用。</p><p><img src="/2020/04/conoha_25_1.gif" alt="OneinStack探针"></p><h2 id="二、OneinStack一键部署Https站点"><a href="#二、OneinStack一键部署Https站点" class="headerlink" title="二、OneinStack一键部署Https站点"></a>二、OneinStack一键部署Https站点</h2><p>首先，如果你自己没有购买证书的话，可以先安装OneinStack提供的Let’s Encrypt申请部署组件，执行命令：.&#x2F;addons.sh，选择Let’s Encrypt安装。</p><p><img src="/2020/04/conoha_27.gif" alt="OneinStack添加证书组件"></p><p>接着，到你的域名DNS管理处，将域名的A记录解析到服务器上，<strong>因为我们在申请Let’s Encrypt证书时需要验证域名，如果没有解析会出失败的情况。</strong></p><p><img src="/2020/04/conoha_26.gif" alt="OneinStack解析域名"></p><p>然后，你就可以执行命令：.&#x2F;vhost.sh，开始添加新的虚拟主机了。下面的配置是绑定wzfou.net域名，同时将www跳转到非www的，其它的文件目录都是默认，在最后一项选择安装Let’s Encrypt。</p><p><img src="/2020/04/conoha_28.gif" alt="OneinStack创建网站"></p><p>最后，选择OneinStack提供的默认URL重写规则，自带了Wordpress、DZ、typecho等热门程序。这是OneinStack添加虚拟主机成功的界面。</p><p><img src="/2020/04/conoha_29.gif" alt="OneinStack添加网站成功"></p><p>打开你的域名，这时你就可以看到Https站点已经部署成功了。</p><p><img src="/2020/04/conoha_30.gif" alt="OneinStack站点部署Https成功"></p><h2 id="三、OneinStack多版本PHP共存"><a href="#三、OneinStack多版本PHP共存" class="headerlink" title="三、OneinStack多版本PHP共存"></a>三、OneinStack多版本PHP共存</h2><p>经过测试，<a target="_blank" rel="noopener" href="https://howsvps.com/tag/lnmp/">LNMP</a> 1.4实现多版本PHP共存比较简单，有这个需要的朋友建议使用LNMP 1.4：<a target="_blank" rel="noopener" href="https://wzfou.com/lnmp-1-4/">Linux VPS建站工具LNMP 1.4安装与使用-SSL自动配置续期和多版本PHP支持</a>。</p><p>OneinStack实现多版本PHP有些麻烦，以下内容参考自官网。如果你之前安装的是PHP 5.4，想要安装PHP 7，命令如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">service php-fpm stop #后面需要再安装php，需要停止php</span><br><span class="line">mv /etc/init.d/php-fpm&#123;,_bk&#125; #后面需要再安装php会覆盖，备份启动脚本</span><br><span class="line">默认php5.4安装路径是/usr/local/php，如果再次安装会提示php已经安装，因此必须修改options.conf的php安装目录，将php7安装路径设置为/usr/local/php7，修改/root/oneinstack/options.conf：</span><br><span class="line">php_install_dir=/usr/local/php7</span><br><span class="line">再次执行./install.sh，选择Install php-7，其余均选择n，等待ing</span><br></pre></td></tr></table></figure><p>修改php配置文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">service php-fpm stop #停止php7启动脚本</span><br><span class="line">mv /etc/init.d/php-fpm /etc/init.d/php7-fpm  #重命名php7启动脚本</span><br><span class="line">mv /etc/init.d/php-fpm_bk /etc/init.d/php-fpm  #恢复php5.4启动脚本</span><br><span class="line">设置php5.4、php7开机自启动：</span><br><span class="line"># CentOS:</span><br><span class="line">chkconfig --add php7-fpm</span><br><span class="line">chkconfig --add php-fpm</span><br><span class="line">chkconfig php7-fpm on</span><br><span class="line">chkconfig php-fpm on</span><br><span class="line"># Ubuntu/Debian:</span><br><span class="line">update-rc.d php7-fpm defaults</span><br><span class="line">update-rc.d php-fpm defaults</span><br><span class="line">防止php5.4、php7监听sock冲突，修改php7的listen，更改配置文件/usr/local/php7/etc/php-fpm.conf：</span><br><span class="line">listen = /dev/shm/php-cgi.sock</span><br><span class="line">#改成</span><br><span class="line">listen = /dev/shm/php7-cgi.sock</span><br><span class="line">手工启动php5.4、php7：</span><br><span class="line">service php-fpm start  #启动php5.4</span><br><span class="line">service php7-fpm start #启动php7</span><br></pre></td></tr></table></figure><p>修改nginx虚拟主机配置文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./vhost.sh绑定域名，默认是运行在php5.4，如需要将网站运行在php7下，需要修改/usr/local/nginx/conf/vhost/www.oneinstack.com.conf（www.oneinstack.com改成自己绑定域名）：</span><br><span class="line">fastcgi_pass unix:/dev/shm/php-cgi.sock;</span><br><span class="line">#改成</span><br><span class="line">fastcgi_pass unix:/dev/shm/php7-cgi.sock;</span><br><span class="line">重新加载nginx，使配置生效：</span><br><span class="line">service nginx reload</span><br></pre></td></tr></table></figure><h2 id="四、使用OneinStack遇到的问题"><a href="#四、使用OneinStack遇到的问题" class="headerlink" title="四、使用OneinStack遇到的问题"></a>四、使用OneinStack遇到的问题</h2><p><strong>第一个问题：let’s encpty SSL证书自动续期失败。</strong>我之前遇到过这样的问题，猜测的原因可能是OneinStack在执行let’s encpty 续期时因为80端口被Nginx占用而导致失败的。解决的办法停止Nginx，然后自己手动执行一下Crontab定时任务。或者直接强制执行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/python/bin/certbot renew –force-renewal –renew-hook “/etc/init.d/nginx reload”</span><br></pre></td></tr></table></figure><p><strong>第二个问题：修改PHP后不生效。</strong>这是因为在安装OneinStack时默认地给PHP环境默认加载了Opcache模块（PHP5.5、5.6、7.0、7.1），修改PHP代码后一般要1分钟后才见效。解决办法可以卸载Opcache，或者自己访问http:&#x2F;&#x2F;公网IP&#x2F;ocp.php，重置缓存。</p><p><img src="/2020/04/conoha_30_2.gif" alt="OneinStack重置缓存"></p><p><strong>第三个问题：OneinStack无法发送邮件。</strong>这是因为OneinStack没有PHP mail，你需要自己安装postfix或者使用第三方的SMTP如sendcloud、Amazon SES、MailGun等发送。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://jarod.vip/2020/04/30/oneinstack%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A-oneinstack%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B%E6%94%B6%E9%9B%86%E6%95%B4%E7%90%86/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Jarod"><meta itemprop="description" content="记录生活中的点点滴滴"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jarod's Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2020/04/30/oneinstack%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A-oneinstack%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B%E6%94%B6%E9%9B%86%E6%95%B4%E7%90%86/" class="post-title-link" itemprop="url">Oneinstack从入门到精通-Oneinstack安装与使用教程收集整理</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-04-30 23:18:57" itemprop="dateCreated datePublished" datetime="2020-04-30T23:18:57+08:00">2020-04-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-09-29 21:27:46" itemprop="dateModified" datetime="2022-09-29T21:27:46+08:00">2022-09-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Linux教程</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>1k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><p>Oneinstack是一个Linux + Nginx+ Apache+MySQL&#x2F;MongoDB+ PHP一键安装包，支持的模式有：lnmp、lamp、lnmpa、lnpp、lnmh等等。相对于LNMP.org的LNMP一键安装包，Oneinstack主要特点是版本更新很及时，特别适合愿意折腾的用户。</p><p>目前Oneinstack的PHP已经支持PHP 7.4了，喜欢尝鲜的朋友可以试试升级了，不过用于生产环境的话还是建议使用成熟的PHP版本，不容易出现问题。由于挖站否平时用Oneinstack建站，所以好多的折腾都是基于Oneinstack完成的，这篇就作一个收集整理汇总，以便于查找。</p><p><img src="/2020/04/oneinstack_00.jpg" alt="Oneinstack从入门到精通-Oneinstack安装与使用教程收集整理"></p><p>更多的<a target="_blank" rel="noopener" href="https://wzfou.com/tag/vps-mianban/">主机面板</a>，这里有几个汇总专题可供参考：<a target="_blank" rel="noopener" href="https://wzfou.com/solusvm-list/">SolusVM从入门到精通</a>、<a target="_blank" rel="noopener" href="https://wzfou.com/vps-mianban/">服务器控制面板榜单</a>、<a target="_blank" rel="noopener" href="https://wzfou.com/whmcs-jiaocheng/">WHMCS从入门到精通</a>。</p><h2 id="Oneinstack从入门到精通-Oneinstack安装与使用教程收集整理"><a href="#Oneinstack从入门到精通-Oneinstack安装与使用教程收集整理" class="headerlink" title="Oneinstack从入门到精通-Oneinstack安装与使用教程收集整理"></a>Oneinstack从入门到精通-Oneinstack安装与使用教程收集整理</h2><p>目录</p><p>教程地址</p><p>主要内容</p><p><strong>安装</strong></p><p><a target="_blank" rel="noopener" href="https://wzfou.com/oneinstack/">OneinStack一键安装</a></p><p>OneinStack一键安装脚本-轻松部署Let’s Encrypt证书配置Https站点</p><p><strong>防火墙</strong></p><p><a target="_blank" rel="noopener" href="https://wzfou.com/question/6311/">Ping超时问题</a></p><p>解决ONEINSTACK PING超时问题-LINUX防火墙规则修改与恢复</p><p><strong>模块</strong></p><p><a target="_blank" rel="noopener" href="https://wzfou.com/ngx-pagespeed/">ngx_pagespeed模块</a></p><p>PageSpeed服务器优化神器-Nginx部署ngx_pagespeed模块和加速效果体验</p><p><strong>Https</strong></p><p><a target="_blank" rel="noopener" href="https://wzfou.com/https-ssl/">HTTPS和SSL优化</a></p><p>八个HTTPS和SSL优化使用心得-减少等待时间和降低Https性能损耗</p><p><strong>HSTS</strong></p><p><a target="_blank" rel="noopener" href="https://wzfou.com/hsts-preload/">启用HSTS</a></p><p>启用HSTS并加入HSTS Preload List让网站Https访问更加安全-附删除HSTS方法</p><p><strong>B-B-r</strong></p><p><a target="_blank" rel="noopener" href="https://wzfou.com/vps-jiasu/">一键安装加速模块</a></p><p>VPS主机加速方法 – 一键安装加速模块 从“软件”上提升VPS主机速度</p><p><strong>优化</strong></p><p><a target="_blank" rel="noopener" href="https://wzfou.com/tlsv1-3-brotli/">开启TLSV1.3和Brotli压缩</a></p><p>网站优化加速-开启TLSV1.3和Brotli压缩-Oneinstack,LNMP,宝塔面板</p><p><strong>缓存</strong></p><p><a target="_blank" rel="noopener" href="https://wzfou.com/nginx-fastcgi-cache/">Nginx fastcgi_cache缓存</a></p><p>WordPress开启Nginx fastcgi_cache缓存加速方法-Nginx配置实例</p><p><strong>内存</strong></p><p><a target="_blank" rel="noopener" href="https://wzfou.com/php-fpm/">php-fpm优化</a></p><p>Linux的php-fpm优化心得-php-fpm进程占用内存大和不释放内存问题</p><p><strong>TTRSS</strong></p><p><a target="_blank" rel="noopener" href="https://wzfou.com/tt-rss/">自建RSS阅读器</a></p><p>自建RSS阅读器Tiny Tiny RSS安装和配置自动更新,全文RSS,更换主题,手机RSS登录</p><p><strong>NextCloud</strong></p><p><a target="_blank" rel="noopener" href="https://wzfou.com/nextcloud-lixian/">安装NextCloud</a></p><p>Oneinstack安装NextCloud以及使用Aria2离线下载和ocDownloader插件配置</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://jarod.vip/2020/04/30/%E8%87%AA%E5%BB%BAdns%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0%E5%8F%8Cdns%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E3%80%81%E5%AD%90%E5%9F%9F%E6%8E%88%E6%9D%83%E3%80%81%E8%BD%AC/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Jarod"><meta itemprop="description" content="记录生活中的点点滴滴"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jarod's Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2020/04/30/%E8%87%AA%E5%BB%BAdns%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0%E5%8F%8Cdns%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E3%80%81%E5%AD%90%E5%9F%9F%E6%8E%88%E6%9D%83%E3%80%81%E8%BD%AC/" class="post-title-link" itemprop="url">自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-04-30 22:40:51" itemprop="dateCreated datePublished" datetime="2020-04-30T22:40:51+08:00">2020-04-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-09-29 21:27:46" itemprop="dateModified" datetime="2022-09-29T21:27:46+08:00">2022-09-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">Linux教程</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>29k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>26 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><p>测试环境：</p><p>硬件：一台主DNS服务器 一台从DNS服务器，一台子域DNS服务器  (一个有更改NS解析地址权限的二级域名) 系统：Centos 6.5 x86_64 BIND版本：9.9.5 下面是两台服务器的网络情况</p><p><code>[root@LookBack223 ~]``# ifconfig awk -F&#39;[ :]+&#39; &#39;/inet addr/&#123;print$4&#125;&#39; grep -vE &quot;^127.&quot;</code></p><p><code>92.222.219.223</code> <code>#DNS主服务器</code></p><p><code>=============================================================================</code></p><p><code>[root@LookBack226 ~]``# ifconfig awk -F&#39;[ :]+&#39; &#39;/inet addr/&#123;print$4&#125;&#39; grep -vE &quot;^127.&quot;</code></p><p><code>92.222.219.226</code> <code>#DNS从服务器</code></p><p><code>=============================================================================</code></p><p><code>[root@LookBack37 ~]``# ifconfig awk -F&#39;[ :]+&#39; &#39;/inet addr/&#123;print$4&#125;&#39; grep -vE &quot;^127.&quot;</code></p><p><code>37.59.108.37</code> <code>#DNS子域服务器</code></p><p> </p><hr><h1 id="一、安装bind-由于现在的bind大版本有9和10，这里用9版本来测试。"><a href="#一、安装bind-由于现在的bind大版本有9和10，这里用9版本来测试。" class="headerlink" title="一、安装bind(由于现在的bind大版本有9和10，这里用9版本来测试。)"></a><strong>一、安装bind(由于现在的bind大版本有9和10，这里用9版本来测试。)</strong></h1><p><a target="_blank" rel="noopener" href="https://www.dwhd.org/20150519_164840.html#down-file" title="下载链接">bind-9.9.5.tar.gz下载</a></p><p>（官方下载地址：<a target="_blank" rel="noopener" href="http://www.isc.org/downloads/%EF%BC%89">http://www.isc.org/downloads/）</a></p><p><code>[root@LookBack223 ~]``# groupadd -g 153 -r named</code></p><p><code>[root@LookBack223 ~]``# useradd -g named -r -u 153 named</code></p><p><code>#在系统上创建一个GID为153 组名为named的系统组</code></p><p><code>#在系统上穿件一个UID为153 所在组为named 系统用户</code></p><p><code>[root@LookBack223 ~]``# yum groupinstall &quot;Development tools&quot; &quot;Server Platform Development&quot; -y</code></p><p><code>#安装开发库包，不然下面是编译不了的(自己安装make等程序也是可以的，这里只是为了取巧。)</code></p><p><code>[root@LookBack223 ~]``# wget -4c [http://www.05hd.com/wp-content/uploads/2014/08/bind-9.9.5.tar.gz](http://www.05hd.com/wp-content/uploads/2014/08/bind-9.9.5.tar.gz)</code></p><p><code>[root@LookBack223 ~]``# tar xf bind-9.9.5.tar.gz</code></p><p><code>[root@LookBack223 ~]``# cd bind-9.9.5</code></p><p><code>[root@LookBack223 bind-9.9.5]``# ./configure --prefix=/usr/local/bind995 --sysconfdir=/etc/named --disable-chroot --enable-threads --enable-ipv6</code></p><p><code>#指定bind安装到/usr/local/bind995目录下，指定配置文件在/etc/bind995目录下，关闭chroot功能，开启threads和ipv6功能，其他用默认，这里的编译选项请根据各自的实际需求来选择。</code></p><p><code>#如果能看到类似下面的信息且没有报错那么就可以继续往下走</code></p><p><code>========================================================================</code></p><p><code>Configuration summary:</code></p><p><code>------------------------------------------------------------------------</code></p><p><code>Optional features enabled:</code></p><p><code>Multiprocessing support (--``enable``-threads)</code></p><p><code>GSS-API (--with-gssapi)</code></p><p><code>Print backtrace on crash (--``enable``-backtrace)</code></p><p><code>Use symbol table</code> <code>for</code> <code>backtrace, named only (--``enable``-symtable)</code></p><p><code>Dynamically loadable zone (DLZ) drivers:</code></p><p><code>None</code></p><p><code>Features disabled or unavailable on this platform:</code></p><p><code>Response Rate Limiting (--``enable``-rrl)</code></p><p><code>PKCS``#11/Cryptoki support (--with-pkcs11)</code></p><p><code>New statistics (--``enable``-newstats)</code></p><p><code>Allow</code> <code>&#39;fixed&#39;</code> <code>rrset-order (--``enable``-fixed-rrset)</code></p><p><code>Automated Testing Framework (--with-atf)</code></p><p><code>GOST algorithm support (--with-gost)</code></p><p><code>Python tools (--with-python)</code></p><p><code>XML statistics (--with-libxml2)</code></p><p><code>========================================================================</code></p><p><code>#开始编译</code></p><p><code>[root@localhost bind-9.9.5]``# make -j $(awk &#39;/processor/&#123;i++&#125;&#125;END&#123;print i&#125;&#39; /proc/cpuinfo) &amp;&amp; make install</code></p><p> </p><p><code>[root@LookBack223 ~]``# dig -v</code></p><p><code>DiG 9.8.2rc1-RedHat-9.8.2-0.17.rc1.el6_4.6</code></p><p><code>[root@LookBack223 ~]``# /usr/local/bind995/bin/dig -v</code></p><p><code>DiG 9.9.5</code></p><p><code>#系统上的虽然之前没有安装bind服务端但是客户端是有装的比如bind自带的dig程序，所以这里我们需要设置系统环境变量</code></p><p><code>[root@LookBack223 ~]``# echo &quot;export PATH=/usr/local/bind/bin:/usr/local/bind/sbin:$PATH&quot; &gt; /etc/profile.d/bind.sh</code></p><p><code>[root@LookBack223 ~]``# ln -sv /usr/local/bind995 /usr/local/bind</code></p><p><code>[root@LookBack223 ~]``# . /etc/profile.d/bind.sh</code></p><p><code>[root@LookBack223 ~]``# echo $PATH</code></p><p><code>/usr/lib64/qt-3``.3``/bin``:``/usr/local/bind/bin``:``/usr/local/bind/sbin``:``/usr/local/sbin``:``/usr/local/bin``:``/sbin``:``/bin``:``/usr/sbin``:``/usr/bin``:``/root/bin</code></p><p><code>[root@LookBack223 ~]``# dig -v</code></p><p><code>DiG 9.9.5</code></p><p><code>#这时候就OK了</code></p><p><code>[root@LookBack223 ~]``# sed -i &quot;$(awk &#39;$1==&quot;MANPATH&quot;&#123;n=NR&#125;END&#123;print n&#125;&#39; /etc/man.config)a MANPATHt/usr/local/bind/share/man&quot; /etc/man.config</code></p><p><code>#导出帮助手册,是系统可以直接man named命令</code></p><p><code>如果有如下提示</code></p><p><code>awk``: 命令行:1: 致命错误: 无法以读模式打开文件“``/etc/man``.config”(没有那个文件或目录)</code></p><p><code>sed``：无法读取</code> <code>/etc/man``.config：没有那个文件或目录</code></p><p><code>那就需要安装``man</code></p><p><code>[root@LookBack223 ~]``# yum install man -y</code></p><hr><h1 id="二、开始配置基础的配置文件"><a href="#二、开始配置基础的配置文件" class="headerlink" title="二、开始配置基础的配置文件"></a><strong>二、开始配置基础的配置文件</strong></h1><p><code>[root@LookBack223 ~]``# cat &gt; /etc/named/named.conf &lt;&lt; EOF</code></p><p><code>options &#123;</code></p><p><code>directory</code> <code>&quot;/var/named&quot;``;</code></p><p><code>//``定义工作目录</code></p><p><code>recursion</code> <code>yes``;</code></p><p><code>//``允许递归</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;.&quot;</code> <code>IN  &#123;</code></p><p><code>type</code> <code>hint;</code></p><p><code>file</code> <code>&quot;named.ca&quot;``;</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;localhost&quot;</code> <code>IN  &#123;</code></p><p><code>type</code> <code>master;</code></p><p><code>//``定义为主DNS  master</code></p><p><code>file</code> <code>&quot;localhost.zone&quot;``;</code></p><p><code>allow-update &#123; none; &#125;;</code></p><p><code>//``不允许任何人更新</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;0.0.127.in-addr.arpa&quot;</code>  <code>IN  &#123;</code></p><p><code>//``把127.0.0反向解析</code></p><p><code>type</code> <code>master;</code></p><p><code>file</code> <code>&quot;127.0.0.zone&quot;``;</code></p><p><code>allow-update &#123; none; &#125;;</code></p><p><code>&#125;;</code></p><p><code>EOF</code></p><p><code>[root@LookBack223 ~]``# chown root:named /etc/named/named.conf</code></p><p><code>[root@LookBack223 ~]``# chmod 640 /etc/named/named.conf</code></p><p><code>[root@LookBack223 ~]``# mkdir -p /var/named/slaves</code></p><p><code>[root@LookBack223 ~]``# chown root:named /var/named/</code></p><p><code>[root@LookBack223 ~]``# chown named:named /var/named/slaves/</code></p><p><code>[root@LookBack223 ~]``# chmod 750 /var/named/</code></p><p><code>[root@LookBack223 ~]``# chmod 770 /var/named/slaves/</code></p><p><code>#制作相关配置文件和设置文件对应的权限</code></p><p><img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A315.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"></p><hr><h2 id="下面开始来配置实现正向解析"><a href="#下面开始来配置实现正向解析" class="headerlink" title="下面开始来配置实现正向解析"></a><strong>下面开始来配置实现正向解析</strong></h2><p><code>[root@LookBack223 named]``# for i in $(grep &#39;file&#39; /etc/named/named.conf awk -F&#39;&quot;&#39; &#39;&#123;print$2&#125;&#39;); do touch /var/named/$i;chgrp named /var/named/$i;chmod 640 /var/named/$i;done</code></p><p><code>[root@LookBack223 named]``# pwd</code></p><p><code>/var/named</code></p><p><code>[root@LookBack223 named]``# tree</code></p><p><code>.</code></p><p><code>├── 127.0.0.zone</code></p><p><code>├── localhost.zone</code></p><p><code>├── named.ca</code></p><p><code>└── slaves</code></p><p><code>1 directory, 3 files</code></p><p><code>#到这里 几个基础的文件就都创建好了，现在需要不足文件里面的配置信息</code></p><p><code>[root@LookBack223 named]``# dig -t NS . @a.root-servers.net. &gt; /var/named/named.ca</code></p><p><code>#获取13台根服务器的配置文件,我们上面已经配置了将跟解析放在/var/named/named.cd,所以我么直接用dig命令将结果重定向过去就好了</code></p><p> </p><p><code>####下面是3个文件的配置内容####</code></p><p><code>[root@LookBack223 named]``# cat named.ca</code></p><p><code>; &gt; DiG 9.9.5 &gt; -t NS . @a.root-servers.net.</code></p><p><code>;; global options: +cmd</code></p><p><code>;; Got answer:</code></p><p><code>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR,</code> <code>id``: 18948</code></p><p><code>;; flags: qr aa rd; QUERY: 1, ANSWER: 13, AUTHORITY: 0, ADDITIONAL: 25</code></p><p><code>;; WARNING: recursion requested but not available</code></p><p><code>;; OPT PSEUDOSECTION:</code></p><p><code>; EDNS: version: 0, flags:; udp: 4096</code></p><p><code>;; QUESTION SECTION:</code></p><p><code>;.              IN  NS</code></p><p><code>;; ANSWER SECTION:</code></p><p><code>.           518400  IN  NS  b.root-servers.net.</code></p><p><code>.           518400  IN  NS  h.root-servers.net.</code></p><p><code>.           518400  IN  NS  i.root-servers.net.</code></p><p><code>.           518400  IN  NS  l.root-servers.net.</code></p><p><code>.           518400  IN  NS  f.root-servers.net.</code></p><p><code>.           518400  IN  NS  g.root-servers.net.</code></p><p><code>.           518400  IN  NS  d.root-servers.net.</code></p><p><code>.           518400  IN  NS  j.root-servers.net.</code></p><p><code>.           518400  IN  NS  a.root-servers.net.</code></p><p><code>.           518400  IN  NS  k.root-servers.net.</code></p><p><code>.           518400  IN  NS  m.root-servers.net.</code></p><p><code>.           518400  IN  NS  c.root-servers.net.</code></p><p><code>.           518400  IN  NS  e.root-servers.net.</code></p><p><code>;; ADDITIONAL SECTION:</code></p><p><code>b.root-servers.net. 3600000 IN  A   192.228.79.201</code></p><p><code>b.root-servers.net. 3600000 IN  AAAA    2001:500:84::b</code></p><p><code>h.root-servers.net. 3600000 IN  A   128.63.2.53</code></p><p><code>h.root-servers.net. 3600000 IN  AAAA    2001:500:1::803f:235</code></p><p><code>i.root-servers.net. 3600000 IN  A   192.36.148.17</code></p><p><code>i.root-servers.net. 3600000 IN  AAAA    2001:7fe::53</code></p><p><code>l.root-servers.net. 3600000 IN  A   199.7.83.42</code></p><p><code>l.root-servers.net. 3600000 IN  AAAA    2001:500:3::42</code></p><p><code>f.root-servers.net. 3600000 IN  A   192.5.5.241</code></p><p><code>f.root-servers.net. 3600000 IN  AAAA    2001:500:2f::f</code></p><p><code>g.root-servers.net. 3600000 IN  A   192.112.36.4</code></p><p><code>d.root-servers.net. 3600000 IN  A   199.7.91.13</code></p><p><code>d.root-servers.net. 3600000 IN  AAAA    2001:500:2d::d</code></p><p><code>j.root-servers.net. 3600000 IN  A   192.58.128.30</code></p><p><code>j.root-servers.net. 3600000 IN  AAAA    2001:503:c27::2:30</code></p><p><code>a.root-servers.net. 3600000 IN  A   198.41.0.4</code></p><p><code>a.root-servers.net. 3600000 IN  AAAA    2001:503:ba3e::2:30</code></p><p><code>k.root-servers.net. 3600000 IN  A   193.0.14.129</code></p><p><code>k.root-servers.net. 3600000 IN  AAAA    2001:7fd::1</code></p><p><code>m.root-servers.net. 3600000 IN  A   202.12.27.33</code></p><p><code>m.root-servers.net. 3600000 IN  AAAA    2001:dc3::35</code></p><p><code>c.root-servers.net. 3600000 IN  A   192.33.4.12</code></p><p><code>c.root-servers.net. 3600000 IN  AAAA    2001:500:2::c</code></p><p><code>e.root-servers.net. 3600000 IN  A   192.203.230.10</code></p><p><code>;; Query</code> <code>time``: 65 msec</code></p><p><code>;; SERVER: 198.41.0.4``#53(198.41.0.4)</code></p><p><code>;; WHEN: Wed Aug 06 05:22:48 UTC 2014</code></p><p><code>;; MSG SIZE  rcvd: 755</code></p><p><code>[root@LookBack223 named]``# cat localhost.zone</code></p><p><code>$TTL 86400</code></p><p><code>@   IN  SOA localhost.  admin.05hd.org. (</code></p><p><code>2014080601</code></p><p><code>3H</code></p><p><code>15M</code></p><p><code>7D</code></p><p><code>1D )</code></p><p><code>IN  NS  localhost.</code></p><p><code>IN  A   172.0.0.1</code></p><p><code>[root@LookBack223 named]``# cat 127.0.0.zone</code></p><p><code>$TTL 86400</code></p><p><code>@   IN  SOA localhost.  admin.05hd.org. (</code></p><p><code>2014080601</code></p><p><code>3H</code></p><p><code>15M</code></p><p><code>7D</code></p><p><code>1D )</code></p><p><code>IN  NS  localhost.</code></p><p><code>1   IN  PTR localhost.</code></p><p> </p><p><code>[root@LookBack223 named]``# chgrp named 127.0.0.zone localhost.zone named.ca</code></p><p><code>[root@LookBack223 named]``# chmod 640 127.0.0.zone localhost.zone named.ca</code></p><p><code>[root@LookBack223 named]``# ll</code></p><p><code>total 16</code></p><p><code>-rw-r----- 1 root  named  128 Aug  6 06:24 127.0.0.zone</code></p><p><code>-rw-r----- 1 root  named  124 Aug  6 06:23 localhost.zone</code></p><p><code>-rw-r----- 1 root  named 2177 Aug  6 06:11 named.ca</code></p><p><code>drwxrwx--- 2 named named 4096 Aug  6 05:04 slaves</code></p><p><code>#修改3个文件的属主属组和权限</code></p><p> </p><p><code>[root@LookBack223 named]``# named-checkconf</code></p><p><code>[root@LookBack223 named]``# named-checkconf /etc/named/named.conf</code></p><p><code>[root@LookBack223 named]``# named-checkzone &quot;localhost&quot; /var/named/localhost.zone</code></p><p><code>zone localhost``/IN``: loaded serial 2014080601</code></p><p><code>OK</code></p><p><code>[root@LookBack223 named]``# named-checkzone &quot;0.0.127.in-addr.arpa&quot; /var/named/127.0.0.zone</code></p><p><code>zone 0.0.127.``in``-addr.arpa``/IN``: loaded serial 2014080601</code></p><p><code>OK</code></p><p><code>##检测配置文件如下图</code></p><p><img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A335.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"></p><p>到了这里我们就可以启动服务来测试了，但是这里的bind是我们编译安装的，编译安装是没有启动脚本的，下面制作启动脚本 将下面的内容保存为**&#x2F;etc&#x2F;rc.d&#x2F;init.d&#x2F;named (注意下面的高亮的两行中的bind安装目录，我这里安装在&#x2F;usr&#x2F;local&#x2F;bind995就用这，其安装在其他目录请根据情况做修改)**</p><p><code>[root@LookBack223 named]``# wget -c4 [http://www.05hd.com/named.sh](http://www.05hd.com/named.sh) -O /etc/rc.d/init.d/named</code></p><p><code>##可以用上面的命令下载启动脚本 也可以用下面的源码自建 更可以自己手写启动脚本</code></p><p><code>#!/bin/bash</code></p><p><code>#</code></p><p><code># description: named daemon</code></p><p><code># chkconfig: - 25 80</code></p><p><code>#</code></p><p><code>pidFile=``/usr/local/bind995/var/run/named``.pid</code></p><p><code>lockFile=``/var/lock/subsys/named</code></p><p><code>confFile=``/etc/named/named``.conf</code></p><p><code>[ -r</code> <code>/etc/rc``.d``/init``.d``/functions</code> <code>] &amp;&amp; .</code> <code>/etc/rc``.d``/init``.d``/functions</code></p><p><code>start() &#123;</code></p><p><code>if</code> <code>[ -e $lockFile ];</code> <code>then</code></p><p><code>echo</code> <code>&quot;named is already running...&quot;</code></p><p><code>exit</code> <code>0</code></p><p><code>fi</code></p><p><code>echo</code> <code>-n</code> <code>&quot;Starting named:&quot;</code></p><p><code>daemon --pidfile</code> <code>&quot;$pidFile&quot;</code> <code>/usr/local/bind995/sbin/named</code> <code>-u named -c</code> <code>&quot;$confFile&quot;</code></p><p><code>RETVAL=$?</code></p><p><code>echo</code></p><p><code>if</code> <code>[ $RETVAL -``eq</code> <code>0 ];</code> <code>then</code></p><p><code>touch</code> <code>$lockFile</code></p><p><code>return</code> <code>$RETVAL</code></p><p><code>else</code></p><p><code>rm</code> <code>-f $lockFile $pidFile</code></p><p><code>return</code> <code>1</code></p><p><code>fi</code></p><p><code>&#125;</code></p><p><code>stop() &#123;</code></p><p><code>if</code> <code>[ ! -e $lockFile ];</code> <code>then</code></p><p><code>echo</code> <code>&quot;named is stopped.&quot;</code></p><p><code># exit 0</code></p><p><code>fi</code></p><p><code>echo</code> <code>-n</code> <code>&quot;Stopping named:&quot;</code></p><p><code>killproc named</code></p><p><code>RETVAL=$?</code></p><p><code>echo</code></p><p><code>if</code> <code>[ $RETVAL -``eq</code> <code>0 ];``then</code></p><p><code>rm</code> <code>-f $lockFile $pidFile</code></p><p><code>return</code> <code>0</code></p><p><code>else</code></p><p><code>echo</code> <code>&quot;Cannot stop named.&quot;</code></p><p><code>failure</code></p><p><code>return</code> <code>1</code></p><p><code>fi</code></p><p><code>&#125;</code></p><p><code>restart() &#123;</code></p><p><code>stop</code></p><p><code>sleep</code> <code>2</code></p><p><code>start</code></p><p><code>&#125;</code></p><p><code>reload() &#123;</code></p><p><code>echo</code> <code>-n</code> <code>&quot;Reloading named: &quot;</code></p><p><code>killproc named -HUP</code></p><p><code>#killall -HUP named</code></p><p><code>RETVAL=$?</code></p><p><code>echo</code></p><p><code>return</code> <code>$RETVAL</code></p><p><code>&#125;</code></p><p><code>status() &#123;</code></p><p><code>if</code> <code>pidof named &amp;&gt;</code> <code>/dev/null``;</code> <code>then</code></p><p><code>echo</code> <code>-n</code> <code>&quot;named is running...&quot;</code></p><p><code>success</code></p><p><code>echo</code></p><p><code>else</code></p><p><code>echo</code> <code>-n</code> <code>&quot;named is stopped...&quot;</code></p><p><code>success</code></p><p><code>echo</code></p><p><code>fi</code></p><p><code>&#125;</code></p><p><code>usage() &#123;</code></p><p><code>echo</code> <code>&quot;Usage: named &#123;startstoprestartstatusreload&#125;&quot;</code></p><p><code>&#125;</code></p><p><code>case</code> <code>$1</code> <code>in</code></p><p><code>start)</code></p><p><code>start ;;</code></p><p><code>stop)</code></p><p><code>stop ;;</code></p><p><code>restart)</code></p><p><code>restart ;;</code></p><p><code>status)</code></p><p><code>status ;;</code></p><p><code>reload)</code></p><p><code>reload ;;</code></p><p><code>*)</code></p><p><code>usage</code></p><p><code>exit</code> <code>4</code></p><p><code>;;</code></p><p><code>esac</code></p><p><code>&lt;a href=``&quot;[http://www.dwhd.org/wp-content/uploads/2015/05/bind](http://www.dwhd.org/wp-content/uploads/2015/05/bind)使用详解45.png&quot;``&gt;&lt;img class=``&quot;attachment-medium&quot;</code> <code>src=``&quot;[http://www.dwhd.org/wp-content/uploads/2015/05/bind](http://www.dwhd.org/wp-content/uploads/2015/05/bind)使用详解45.png&quot;</code> <code>alt=``&quot;bind使用详解45&quot;</code>  <code>/&gt;&lt;``/a``&gt;</code></p><p> </p><p><code>[root@LookBack223 named]``# chmod +x /etc/rc.d/init.d/named</code></p><p><code>[root@LookBack223 named]``# chkconfig --add named</code></p><p><code>[root@LookBack223 named]``# chkconfig named on</code></p><p><code>[root@LookBack223 named]``# chkconfig --list named</code></p><p><code>named           0:off   1:off   2:on    3:on    4:on    5:on    6:off</code></p><p><strong>下面来测试启动脚本的正常与否 开始来启动named服务</strong></p><p><code>[root@LookBack223 named]``# service named start</code></p><p><code>Starting named:                                            [  OK  ]</code></p><p><code>[root@LookBack223 named]``# service named restart</code></p><p><code>Stopping named:                                            [  OK  ]</code></p><p><code>Starting named:                                            [  OK  ]</code></p><p><code>[root@LookBack223 named]``# service named stop</code></p><p><code>Stopping named:                                            [  OK  ]</code></p><p><code>[root@LookBack223 named]``# service named start</code></p><p><code>Starting named:                                            [  OK  ]</code></p><p><code>[root@LookBack223 named]``# service named status</code></p><p><code>named is running...                                        [  OK  ]</code></p><p><strong>来看下服务器启动情况和端口监听正常不</strong></p><p><img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3815.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"></p><p><strong>下面两图可以看出 服务器上的dns服务器已经OK了。</strong></p><p><img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A365.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"></p><p><img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A372.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"></p><hr><h1 id="三、现在来开始做域名正反向解析了"><a href="#三、现在来开始做域名正反向解析了" class="headerlink" title="三、现在来开始做域名正反向解析了"></a><strong>三、现在来开始做域名正反向解析了</strong></h1><p>先来看看用于测试域名的为zeaxion.com</p><h2 id="1、正向域解析配置"><a href="#1、正向域解析配置" class="headerlink" title="1、正向域解析配置"></a><strong>1、正向域解析配置</strong></h2><p>在&#x2F;etc&#x2F;named&#x2F;named.conf配置文件里面追加下面的内容</p><p><code>zone</code> <code>&quot;zeaxion.com&quot;</code>   <code>IN  &#123;</code></p><p><code>type</code> <code>master;</code></p><p><code>file</code> <code>&quot;zeaxion.com.zone&quot;``;</code></p><p><code>&#125;;</code></p><p>如下图： <img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3121-283x300-1.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"></p><p>创建&#x2F;var&#x2F;named&#x2F;zeaxion.com.zone文件并写好配置内容</p><p><code>[root@LookBack223 named]``# touch /var/named/zeaxion.com.zone</code></p><p><code>[root@LookBack223 named]``# chgrp named /var/named/zeaxion.com.zone</code></p><p><code>[root@LookBack223 named]``# chmod 640 /var/named/zeaxion.com.zone</code></p><p><code>[root@LookBack223 named]``# cat zeaxion.com.zone</code></p><p><code>$TTL 600</code></p><p><code>@   IN  SOA ns.zeaxion.com. admin.zeaxion.com. (</code></p><p><code>;\ 上面的admin.zeaxion.com.其实邮箱地址，在这里邮箱地址不能使用@所以要使用.</code></p><p><code>2014080601</code></p><p><code>1H</code></p><p><code>10M</code></p><p><code>7D</code></p><p><code>2H )</code></p><p><code>IN  NS      ns.zeaxion.com.</code></p><p><code>IN  MX  10  mxdomain.qq.com.</code></p><p><code>ns.zeaxion.com. IN  A   106.186.17.185</code></p><p><code>www.zeaxion.com.    IN  A   106.186.17.185</code></p><p><code>manage.zeaxion.com. IN  A   106.186.17.185</code></p><p>如下图 <img src="https://www.jarods.org/wp-content/uploads/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3101.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"> 然后检测下配置文件可有写法格式错误 <img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A391.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"></p><p>到了这里我们需要去域名注册商处将域名的ns设置成ns.zeaxion.com和ns2.zeaxion.com，设置好了之后我们来看看在互联网上这个域名的DNS解析是否OK了</p><p><code>[root@LookBack226 ~]``# ifconfig awk -F&#39;[ :]+&#39; &#39;/inet addr/&#123;print$4&#125;&#39; grep -vE &quot;^127.&quot;</code></p><p><code>92.222.219.226</code></p><p><code>[root@LookBack226 ~]``# dig +trace -t A www.zeaxion.com</code></p><p><code>; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.23.rc1.el6_5.1 &lt;&lt;&gt;&gt; +trace -t A www.zeaxion.com</code></p><p><code>;; global options: +cmd</code></p><p><code>.           509310  IN  NS  e.root-servers.net.</code></p><p><code>.           509310  IN  NS  a.root-servers.net.</code></p><p><code>.           509310  IN  NS  l.root-servers.net.</code></p><p><code>.           509310  IN  NS  d.root-servers.net.</code></p><p><code>.           509310  IN  NS  b.root-servers.net.</code></p><p><code>.           509310  IN  NS  m.root-servers.net.</code></p><p><code>.           509310  IN  NS  h.root-servers.net.</code></p><p><code>.           509310  IN  NS  f.root-servers.net.</code></p><p><code>.           509310  IN  NS  g.root-servers.net.</code></p><p><code>.           509310  IN  NS  j.root-servers.net.</code></p><p><code>.           509310  IN  NS  c.root-servers.net.</code></p><p><code>.           509310  IN  NS  k.root-servers.net.</code></p><p><code>.           509310  IN  NS  i.root-servers.net.</code></p><p><code>;; Received 228 bytes from 127.0.0.1``#53(127.0.0.1) in 2151 ms</code></p><p><code>com.            172800  IN  NS  a.gtld-servers.net.</code></p><p><code>com.            172800  IN  NS  b.gtld-servers.net.</code></p><p><code>com.            172800  IN  NS  c.gtld-servers.net.</code></p><p><code>com.            172800  IN  NS  d.gtld-servers.net.</code></p><p><code>com.            172800  IN  NS  e.gtld-servers.net.</code></p><p><code>com.            172800  IN  NS  f.gtld-servers.net.</code></p><p><code>com.            172800  IN  NS  g.gtld-servers.net.</code></p><p><code>com.            172800  IN  NS  h.gtld-servers.net.</code></p><p><code>com.            172800  IN  NS  i.gtld-servers.net.</code></p><p><code>com.            172800  IN  NS  j.gtld-servers.net.</code></p><p><code>com.            172800  IN  NS  k.gtld-servers.net.</code></p><p><code>com.            172800  IN  NS  l.gtld-servers.net.</code></p><p><code>com.            172800  IN  NS  m.gtld-servers.net.</code></p><p><code>;; Received 493 bytes from 198.41.0.4``#53(198.41.0.4) in 1180 ms</code></p><p><code>zeaxion.com.        172800  IN  NS  ns.zeaxion.com.</code></p><p><code>zeaxion.com.        172800  IN  NS  ns2.zeaxion.com.</code></p><p><code>;; Received 100 bytes from 2001:503:a83e::2:30``#53(2001:503:a83e::2:30) in 23 ms</code></p><p><code>www.zeaxion.com.    600 IN  A   106.186.17.185</code></p><p><code>zeaxion.com.        600 IN  NS  ns.zeaxion.com.</code></p><p><code>zeaxion.com.        600 IN  NS  ns2.zeaxion.com.</code></p><p><code>;; Received 116 bytes from 92.222.219.223``#53(92.222.219.223) in 0 ms</code></p><p>以上可以看出现在我们的基本的域名DNS解析已经搞定了。</p><h2 id="2、反向域解析配置"><a href="#2、反向域解析配置" class="headerlink" title="2、反向域解析配置"></a><strong>2、反向域解析配置</strong></h2><p>在&#x2F;etc&#x2F;named&#x2F;named.conf文件中加入</p><p><code>[root@LookBack223 named]``# zone  &quot;219.222.92.in-addr.arpa&quot;   &#123;</code></p><p><code>type</code> <code>master;</code></p><p><code>file</code> <code>&quot;92.222.219.zone&quot;``;</code></p><p><code>&#125;;</code></p><p>创建一个&#x2F;var&#x2F;named&#x2F;92.222.219.zone的文件，注意文件的属主数组权限,也可以用下面的命令自动生成&#x2F;etc&#x2F;named&#x2F;named.conf配置内容需要的文件了，</p><p><code>[root@LookBack223 named]``# for i in $(grep &#39;file&#39; /etc/named/named.conf awk -F&#39;&quot;&#39; &#39;&#123;print$2&#125;&#39;); do touch /var/named/$i;chgrp named /var/named/$i;chmod 640 /var/named/$i;done</code></p><p>来看下&#x2F;var&#x2F;named&#x2F;92.222.219.zone文件怎么做反接配置的 <img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3131.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"></p><p><code>[root@LookBack223 named]``# cat !$</code></p><p><code>cat</code> <code>92.222.219.zone</code></p><p><code>$TTL 600</code></p><p><code>@   IN  SOA ns.zeaxion.com. admin.zeaxion.com. (</code></p><p><code>2014080601</code></p><p><code>1H</code></p><p><code>10M</code></p><p><code>7D</code></p><p><code>2H )</code></p><p><code>IN  NS      ns.zeaxion.com.</code></p><p><code>IN  NS      ns2.zeaxion.com.</code></p><p><code>219 IN  PTR     ns.zeaxion.com.</code></p><p><code>226 IN  PTR     ns2.zeaxion.com.</code></p><p><code>;106.186.17.185 IN  PTR zeaxion.com.</code></p><p><code>;106.186.17.185 IN  PTR www.zeaxion.com.</code></p><p><code>;106.186.17.185 IN  PTR manage.zeaxion.com.</code></p><p><code>####最后的3行不能用。。。请注意。。</code></p><p>接着来检测下配置文件，如果没有错误就让named重新载入下配置文件 <img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3141.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"></p><p><code>[root@LookBack223 named]``# named-checkconf</code></p><p><code>[root@LookBack223 named]``# named-checkzone &quot;219.222.92.in-addr.arpa&quot; 92.222.219.zone</code></p><p><code>zone 219.222.92.``in``-addr.arpa``/IN``: loaded serial 2014080601</code></p><p><code>OK</code></p><p><code>[root@LookBack223 named]``# service named reload</code></p><p><code>Reloading named:                                           [  OK  ]</code></p><p><code>[root@LookBack223 named]``#</code></p><p><img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3151.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"></p><p><code>[root@LookBack226 ~]``# ifconfig awk -F&#39;[ :]+&#39; &#39;/inet addr/&#123;print$4&#125;&#39; grep -vE &quot;^127.&quot;</code></p><p><code>92.222.219.226</code></p><p><code>[root@LookBack226 ~]``# dig -x 92.222.219.223 @92.222.219.223</code></p><p><code>; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.23.rc1.el6_5.1 &lt;&lt;&gt;&gt; -x 92.222.219.223 @92.222.219.223</code></p><p><code>;; global options: +cmd</code></p><p><code>;; Got answer:</code></p><p><code>;; -&gt;&gt;HEADER&lt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.23.rc1.el6_5.1 &lt;&lt;&gt;&gt; -t AXFR 219.222.92.``in``-addr.arpa @92.222.219.223</code></p><p><code>;; global options: +cmd</code></p><p><code>219.222.92.``in``-addr.arpa. 600    IN  SOA ns.zeaxion.com. admin.zeaxion.com. 2014080601 3600 600 604800 7200</code></p><p><code>219.222.92.``in``-addr.arpa. 600    IN  NS  ns.zeaxion.com.</code></p><p><code>219.222.92.``in``-addr.arpa. 600    IN  NS  ns2.zeaxion.com.</code></p><p><code>223.219.222.92.``in``-addr.arpa. 600 IN PTR ns.zeaxion.com.</code></p><p><code>226.219.222.92.``in``-addr.arpa. 600 IN PTR ns2.zeaxion.com.</code></p><p><code>219.222.92.``in``-addr.arpa. 600    IN  SOA ns.zeaxion.com. admin.zeaxion.com. 2014080601 3600 600 604800 7200</code></p><p><code>;; Query</code> <code>time``: 1 msec</code></p><p><code>;; SERVER: 92.222.219.223``#53(92.222.219.223)</code></p><p><code>;; WHEN: Wed Aug  6 15:26:04 2014</code></p><p><code>;; XFR size: 6 records (messages 1, bytes 201)</code></p><p>到此 反向解析也配置好了。</p><hr><h1 id="四、配置多DNS主从复制"><a href="#四、配置多DNS主从复制" class="headerlink" title="四、配置多DNS主从复制"></a><strong>四、配置多DNS主从复制</strong></h1><p>做主从复制的时候需要注意的几点的事情 (1)、从服务器的bind版本必须大于等于主服务器的bind版本。因为程序都是采取向下兼容的规则。如果从服务器版本低于主服务器那么很可能因为程序功能的改变导致失败 所以这里我们还是采取编译安装从服务器这样就可以保证主从服务器的bind都为同一版本。因为之前已经编译了一次 这里就不详说从服务器的编译安装过程了。直接使用下面的命令就可以了。 (2)、<strong>主从服务器的时间需要相对一致</strong>，所以我们这里给主从服务器都做NTP在线时间同步。<a target="_blank" rel="noopener" href="http://www.pool.ntp.org/en/">http://www.pool.ntp.org/en/</a></p><p><code>[root@LookBack226 ~]```# echo &quot;*/3 * * * *</code>which ntpdate&#96; fr.pool.ntp.org &amp;&gt; &#x2F;dev&#x2F;null” &#x2F;var&#x2F;spool&#x2F;cron&#x2F;root&#96;&#96;</p><p><code>[root@LookBack226 ~]``# ntpdate fr.pool.ntp.org</code></p><p><code>6 Aug 15:58:38 ntpdate[21702]: Can&#39;t adjust the</code> <code>time</code> <code>of day: Operation not permitted</code></p><p><code>我这里由于2台测试机都是openvz的虚拟机，被机房设置不能修改时间，因为虚拟机需要和母机做同步时间，那么我这里的时间问题就无需操心了。</code></p><p><strong>安装完毕之后还是需要重新启动下shell 或者服务器。因为系统的环境变量有改变。</strong></p><p><code>[root@LookBack226 ~]``# groupadd -g 153 -r named</code></p><p><code>[root@LookBack226 ~]``# useradd -g named -r -u 153 named</code></p><p><code>[root@LookBack226 ~]``# yum groupinstall &quot;Development tools&quot; &quot;Server Platform Development&quot; -y</code></p><p><code>[root@LookBack226 ~]``# wget -4c [http://www.05hd.com/wp-content/uploads/2014/08/bind-9.9.5.tar.gz](http://www.05hd.com/wp-content/uploads/2014/08/bind-9.9.5.tar.gz)</code></p><p><code>[root@LookBack226 ~]``# tar xf bind-9.9.5.tar.gz</code></p><p><code>[root@LookBack226 ~]``# cd bind-9.9.5</code></p><p><code>[root@LookBack226 bind-9.9.5]``# ./configure --prefix=/usr/local/bind995 --sysconfdir=/etc/named --disable-chroot --enable-threads --enable-ipv6</code></p><p><code>[root@LookBack226 bind-9.9.5]``# make &amp;&amp; make install</code></p><p><code>[root@LookBack226 ~]``# echo &quot;export PATH=/usr/local/bind995/bin:/usr/local/bind995/sbin:$PATH&quot; &gt; /etc/profile.d/bind995.sh</code></p><p><code>[root@LookBack226 ~]``# sed -i &quot;$(cat /etc/man.config grep -nE &#39;^MANPATH[[:space:]]+&#39; tail -1 awk -F: &#39;&#123;print$1&#125;&#39;)a MANPATHt/usr/local/bind995/share/man&quot; /etc/man.config</code></p><p><code>[root@LookBack226 ~]``# wget -c4 [http://www.05hd.com/named.sh](http://www.05hd.com/named.sh) -O /etc/rc.d/init.d/named</code></p><p><code>[root@LookBack226 ~]``# chmod +x /etc/rc.d/init.d/named</code></p><p><code>[root@LookBack226 ~]``# chkconfig --add named</code></p><p><code>[root@LookBack226 ~]``# chkconfig named on</code></p><p><code>[root@LookBack226 ~]``# chown root:named /etc/named/named.conf</code></p><p><code>[root@LookBack226 ~]``# chmod 640 /etc/named/named.conf</code></p><p><code>[root@LookBack226 ~]``# mkdir -p /var/named/slaves</code></p><p><code>[root@LookBack226 ~]``# chown root:named /var/named/</code></p><p><code>[root@LookBack226 ~]``# chown named:named /var/named/slaves/</code></p><p><code>[root@LookBack226 ~]``# chmod 750 /var/named/</code></p><p><code>[root@LookBack226 ~]``# chmod 770 /var/named/slaves/</code></p><p><code>#上面的步骤做好了 新建个shell进程进服务器或者直接重启下服务器</code></p><p><img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A316.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"> 上图可以看出 bind已经编译安装好了 系统环境变量也做OK了</p><p>首先来配置从服务器</p><p><code>[root@LookBack226 ~]``# cat /etc/named/named.conf</code></p><p><code>options &#123;</code></p><p><code>listen-on port 53 &#123; 127.0.0.1; 92.222.219.226; &#125;;``//``这里记得要换成从服务器的IPV4地址哦</code></p><p><code>listen-on-v6 port 53 &#123; 2001:41d0:52:300::10f8; &#125;;``//``这里记得要换成从服务器的IPV6地址哦</code></p><p><code>directory</code> <code>&quot;/var/named&quot;``;</code></p><p><code>//``定义工作目录</code></p><p><code>recursion</code> <code>yes``;</code></p><p><code>//``允许递归</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;.&quot;</code> <code>IN &#123;</code></p><p><code>type</code> <code>hint;</code></p><p><code>file</code> <code>&quot;named.ca&quot;``;</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;localhost&quot;</code> <code>IN &#123;</code></p><p><code>type</code> <code>master;</code></p><p><code>//``设施为主 master</code></p><p><code>file</code> <code>&quot;localhost.zone&quot;``;</code></p><p><code>allow-update &#123; none; &#125;;</code></p><p><code>//``不允许任何人更新</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;0.0.127.in-addr.arpa&quot;</code> <code>IN &#123;</code></p><p><code>//``把127.0.0反向解析</code></p><p><code>type</code> <code>master;</code></p><p><code>file</code> <code>&quot;127.0.0.zone&quot;``;</code></p><p><code>allow-update &#123; none; &#125;;</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;zeaxion.com&quot;</code> <code>IN &#123;</code></p><p><code>type</code> <code>slave;</code> <code>//``设置为从服务器</code></p><p><code>file</code> <code>&quot;slaves/zeaxion.com.zone&quot;``;</code> <code>//``设置从服务器配置文件存放路径</code></p><p><code>masters &#123; 92.222.219.223; &#125;;</code> <code>//``配置主DNS服务器的IP地址</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;219.222.92.in-addr.arpa&quot;</code> <code>&#123;</code></p><p><code>type</code> <code>slave;</code></p><p><code>file</code> <code>&quot;slaves/92.222.219.zone&quot;``;</code></p><p><code>masters &#123; 92.222.219.223; &#125;;</code></p><p><code>&#125;;</code></p><p><code>配置好了主配置文件后 ，和上面一样创建一个bind的启动脚本，然后启动服务。</code></p><p><code>来看看从服务器上的端口监听状态</code></p><p><code>&lt;a href=``&quot;[http://www.dwhd.org/wp-content/uploads/2015/05/bind](http://www.dwhd.org/wp-content/uploads/2015/05/bind)使用详解17.png&quot;``&gt;&lt;img class=``&quot;attachment-medium&quot;</code> <code>src=``&quot;[http://www.dwhd.org/wp-content/uploads/2015/05/bind](http://www.dwhd.org/wp-content/uploads/2015/05/bind)使用详解17.png&quot;</code> <code>alt=``&quot;bind使用详解17&quot;</code>  <code>/&gt;&lt;``/a``&gt;</code></p><p><code>然后来看看从服务器上的文件是否同步成功。。</code></p><p><code>&lt;a href=``&quot;[http://www.dwhd.org/wp-content/uploads/2015/05/bind](http://www.dwhd.org/wp-content/uploads/2015/05/bind)使用详解18.png&quot;``&gt;&lt;img class=``&quot;attachment-medium&quot;</code> <code>src=``&quot;[http://www.dwhd.org/wp-content/uploads/2015/05/bind](http://www.dwhd.org/wp-content/uploads/2015/05/bind)使用详解18.png&quot;</code> <code>alt=``&quot;bind使用详解18&quot;</code>  <code>/&gt;&lt;``/a``&gt;</code></p><p><code>来做下测试</code></p><p> </p><p><code>[root@LookBack226 ~]``# ifconfig awk -F&#39;[ :]+&#39; &#39;/inet addr/&#123;print$4&#125;&#39; grep -vE &quot;^127.&quot;</code></p><p><code>92.222.219.226</code></p><p><code>[root@LookBack226 ~]``# dig -x 92.222.219.223 @92.222.219.226</code></p><p><code>; &lt;&lt;&gt;&gt; DiG 9.9.5 &lt;&lt;&gt;&gt; -x 92.222.219.223 @92.222.219.226</code></p><p><code>;; global options: +cmd</code></p><p><code>;; Got answer:</code></p><p><code>;; -&gt;&gt;HEADER&lt;&gt; DiG 9.9.5 &lt;&lt;&gt;&gt; -x 92.222.219.226 @92.222.219.223</code></p><p><code>;; global options: +cmd</code></p><p><code>;; Got answer:</code></p><p><code>;; -&gt;&gt;HEADER&lt;&gt; DiG 9.9.5 &lt;&lt;&gt;&gt; -t AXFR 219.222.92.``in``-addr.arpa @92.222.219.226</code></p><p><code>;; global options: +cmd</code></p><p><code>219.222.92.``in``-addr.arpa. 600    IN  SOA ns.zeaxion.com. admin.zeaxion.com. 2014080601 3600 600 604800 7200</code></p><p><code>219.222.92.``in``-addr.arpa. 600    IN  NS  ns.zeaxion.com.</code></p><p><code>219.222.92.``in``-addr.arpa. 600    IN  NS  ns2.zeaxion.com.</code></p><p><code>223.219.222.92.``in``-addr.arpa. 600 IN PTR ns.zeaxion.com.</code></p><p><code>226.219.222.92.``in``-addr.arpa. 600 IN PTR ns2.zeaxion.com.</code></p><p><code>219.222.92.``in``-addr.arpa. 600    IN  SOA ns.zeaxion.com. admin.zeaxion.com. 2014080601 3600 600 604800 7200</code></p><p><code>;; Query</code> <code>time``: 0 msec</code></p><p><code>;; SERVER: 92.222.219.226``#53(92.222.219.226)</code></p><p><code>;; WHEN: Sat Aug 09 06:30:19 CEST 2014</code></p><p><code>;; XFR size: 6 records (messages 1, bytes 201)</code></p><p><code>[root@LookBack226 ~]``# dig -t A www.zeaxion.com @92.222.219.223</code></p><p><code>; &lt;&lt;&gt;&gt; DiG 9.9.5 &lt;&lt;&gt;&gt; -t A www.zeaxion.com @92.222.219.223</code></p><p><code>;; global options: +cmd</code></p><p><code>;; Got answer:</code></p><p><code>;; -&gt;&gt;HEADER&lt;&gt; DiG 9.9.5 &lt;&lt;&gt;&gt; -t A www.zeaxion.com @92.222.219.226</code></p><p><code>;; global options: +cmd</code></p><p><code>;; Got answer:</code></p><p><code>;; -&gt;&gt;HEADER&lt;</code></p><p><img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A320.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"></p><p><img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A319.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"></p><p><img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A321.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"></p><p><img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A322.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"> 可以看出从服务器已经同步OK了。好了 到了这里 主从同步就做好了</p><hr><h1 id="五、DNS正向子域授权的配置"><a href="#五、DNS正向子域授权的配置" class="headerlink" title="五、DNS正向子域授权的配置"></a><strong>五、DNS正向子域授权的配置</strong></h1><p><img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A323.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"></p><p>其实DNS的子域授权只需要在父域的区域解析库中添加“胶水记录”就OK</p><p>下面来说说怎么配置子域授权DNS吧</p><p><img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A324.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"></p><p>这里就不说子域授权的DNS服务器编译安装BIND和基础配置文件生成的过程了</p><p><code>[root@LookBack37 ~]``# groupadd -g 153 -r named</code></p><p><code>[root@LookBack37 ~]``# useradd -g named -r -u 153 named</code></p><p><code>[root@LookBack37 ~]``# yum groupinstall &quot;Development tools&quot; &quot;Server Platform Development&quot; -y</code></p><p><code>[root@LookBack37 ~]``# wget -4c [http://www.05hd.com/wp-content/uploads/2014/08/bind-9.9.5.tar.gz](http://www.05hd.com/wp-content/uploads/2014/08/bind-9.9.5.tar.gz)</code></p><p><code>[root@LookBack37 ~]``# tar xf bind-9.9.5.tar.gz</code></p><p><code>[root@LookBack37 ~]``# cd bind-9.9.5</code></p><p><code>[root@LookBack37 bind-9.9.5]``# ./configure --prefix=/usr/local/bind995 --sysconfdir=/etc/named --disable-chroot --enable-threads --enable-ipv6</code></p><p><code>[root@LookBack37 bind-9.9.5]``# make &amp;&amp; make install</code></p><p><code>[root@LookBack37 ~]``# echo &quot;export PATH=/usr/local/bind995/bin:/usr/local/bind995/sbin:$PATH&quot; &gt; /etc/profile.d/bind995.sh</code></p><p><code>[root@LookBack37 ~]``# sed -i &quot;$(cat /etc/man.config grep -nE &#39;^MANPATH[[:space:]]+&#39; tail -1 awk -F: &#39;&#123;print$1&#125;&#39;)a MANPATHt/usr/local/bind995/share/man&quot; /etc/man.config</code></p><p><code>[root@LookBack37 ~]``# wget -c4 [http://www.05hd.com/named.sh](http://www.05hd.com/named.sh) -O /etc/rc.d/init.d/named</code></p><p><code>[root@LookBack37 ~]``# chmod +x /etc/rc.d/init.d/named</code></p><p><code>[root@LookBack37 ~]``# chkconfig --add named</code></p><p><code>[root@LookBack37 ~]``# chkconfig named on</code></p><p><code>[root@LookBack37 ~]``# chown root:named /etc/named/named.conf</code></p><p><code>[root@LookBack37 ~]``# chmod 640 /etc/named/named.conf</code></p><p><code>[root@LookBack37 ~]``# mkdir -p /var/named/slaves</code></p><p><code>[root@LookBack37 ~]``# chown root:named /var/named/</code></p><p><code>[root@LookBack37 ~]``# chown named:named /var/named/slaves/</code></p><p><code>[root@LookBack37 ~]``# chmod 750 /var/named/</code></p><p><code>[root@LookBack37 ~]``# chmod 770 /var/named/slaves/</code></p><p><code>#上面的步骤做好了 新建个shell进程进服务器或者直接重启下服务器</code></p><p>下面来配置主DNS服务器上的&#x2F;var&#x2F;named&#x2F;zeaxion.com.zone文件</p><p><code>[root@LookBack1 named]``# pwd</code></p><p><code>/var/named</code></p><p><code>[root@LookBack1 named]``# cat zeaxion.com.zone</code></p><p><code>$TTL 600</code></p><p><code>@   IN  SOA ns.zeaxion.com. admin.zeaxion.com. (</code></p><p><code>;;上面的admin.zeaxion.com.其实邮箱地址，在这里邮箱地址不能使用@所以要使用.</code></p><p><code>2014080711</code></p><p><code>1H</code></p><p><code>10M</code></p><p><code>7D</code></p><p><code>2H )</code></p><p><code>IN  NS      ns.zeaxion.com.</code></p><p><code>IN  NS      ns2.zeaxion.com.</code></p><p><code>IN  MX  10  mxdomain.qq.com.</code></p><p><code>ns.zeaxion.com. IN  A           92.222.219.223</code></p><p><code>ns2.zeaxion.com. IN  A          92.222.219.226</code></p><p><code>www.zeaxion.com.    IN  A   106.186.17.185</code></p><p><code>web.zeaxion.com.    IN  A   106.186.17.185</code></p><p><code>manage.zeaxion.com. IN  A   106.186.17.185</code></p><p><code>ops.zeaxion.com.        IN      NS      ns.ops.zeaxion.com</code></p><p><code>nsops.zeaxion.com.    IN        A       37.59.108.37</code></p><p>配置好了来重启下服务</p><p><code>[root@LookBack1 named]``# /etc/init.d/named restart</code></p><p><code>Stopping named:                                            [  OK  ]</code></p><p><code>Starting named:                                            [  OK  ]</code></p><p>然后来看看效果</p><p><code>[root@LookBack1 named]``# dig -t NS ops.zeaxion.com @92.222.219.223</code></p><p><code>; &lt;&lt;&gt;&gt; DiG 9.9.5 &lt;&lt;&gt;&gt; -t NS ops.zeaxion.com @92.222.219.223</code></p><p><code>;; global options: +cmd</code></p><p><code>;; Got answer:</code></p><p><code>;; -&gt;&gt;HEADER&lt;</code></p><p>是不是这时候主DNS服务器就不能解析ops.zeaxion.com的域了 但是看看下面会发现我们的FQDN是有信息的</p><p><code>[root@LookBack1 named]``# dig -t AXFR zeaxion.com @92.222.219.226</code></p><p><code>; &lt;&lt;&gt;&gt; DiG 9.9.5 &lt;&lt;&gt;&gt; -t AXFR zeaxion.com @92.222.219.226</code></p><p><code>;; global options: +cmd</code></p><p><code>zeaxion.com.            600     IN      SOA     ns.zeaxion.com. admin.zeaxion.com. 2014080713 3600 600 604800 7200</code></p><p><code>zeaxion.com.            600     IN      MX      10 mxdomain.qq.com.</code></p><p><code>zeaxion.com.            600     IN      NS      ns.zeaxion.com.</code></p><p><code>zeaxion.com.            600     IN      NS      ns2.zeaxion.com.</code></p><p><code>manage.zeaxion.com.     600     IN      A       106.186.17.185</code></p><p><code>ns.zeaxion.com.         600     IN      A       92.222.219.223</code></p><p><code>ns2.zeaxion.com.        600     IN      A       92.222.219.226</code></p><p><code>ops.zeaxion.com.        600     IN      NS      ns.ops.zeaxion.com.</code></p><p><code>ns.ops.zeaxion.com.     600     IN      A       37.59.108.37</code></p><p><code>web.zeaxion.com.        600     IN      A       106.186.17.185</code></p><p><code>www.zeaxion.com.        600     IN      A       106.186.17.185</code></p><p><code>zeaxion.com.            600     IN      SOA     ns.zeaxion.com. admin.zeaxion.com. 2014080713 3600 600 604800 7200</code></p><p><code>;; Query</code> <code>time``: 0 msec</code></p><p><code>;; SERVER: 92.222.219.226``#53(92.222.219.226)</code></p><p><code>;; WHEN: Sat Aug 09 11:26:22 CEST 2014</code></p><p><code>;; XFR size: 12 records (messages 1, bytes 302)</code></p><p>这时候我们就可以得出 虽然我们在主DNS服务器上都建立了解析 但是这时候的ops.zeaxion.com的子域主DNS服务器是不负责解析了</p><p><strong>下面来配置子域的&#x2F;etc&#x2F;named&#x2F;named.conf文件</strong></p><p><code>[root@LookBack37 ~]``# vi /etc/named/named.conf</code></p><p><code>[root@LookBack37 ~]``# cat !$</code></p><p><code>cat</code> <code>/etc/named/named``.conf</code></p><p><code>options &#123;</code></p><p><code>listen-on port 53 &#123; 127.0.0.1; 37.59.108.37; &#125;;</code></p><p><code>listen-on-v6 port 53 &#123; 2001:41d0:51:1::d1c; &#125;;</code></p><p><code>directory</code> <code>&quot;/var/named&quot;``;</code></p><p><code>//``定义工作目录</code></p><p><code>recursion</code> <code>yes``;</code></p><p><code>//``允许递归</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;.&quot;</code>     <code>IN      &#123;</code></p><p><code>type</code> <code>hint;</code></p><p><code>file</code> <code>&quot;named.ca&quot;``;</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;localhost&quot;</code>     <code>IN      &#123;</code></p><p><code>type</code> <code>master;</code></p><p><code>//``设施为主  master</code></p><p><code>file</code> <code>&quot;localhost.zone&quot;``;</code></p><p><code>allow-update &#123; none; &#125;;</code></p><p><code>//``不允许任何人更新</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;0.0.127.in-addr.arpa&quot;</code>  <code>IN      &#123;</code></p><p><code>//``把127.0.0反向解析</code></p><p><code>type</code> <code>master;</code></p><p><code>file</code> <code>&quot;127.0.0.zone&quot;``;</code></p><p><code>allow-update &#123; none; &#125;;</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;ops.zeaxion.com&quot;</code>   <code>IN      &#123;</code></p><p><code>type</code> <code>master;</code></p><p><code>file</code> <code>&quot;ops.zeaxion.com.zone&quot;``;</code></p><p><code>//allow-update</code> <code>&#123; 127.0.0.1; &#125;;</code></p><p><code>&#125;;</code></p><p>再去&#x2F;var&#x2F;named&#x2F;下创建需要的文件</p><p><code>[root@LookBack37 ~]``# for i in $(grep &#39;file&#39; /etc/named/named.conf awk -F&#39;&quot;&#39; &#39;&#123;print$2&#125;&#39;); do touch /var/named/$i;chgrp named /var/named/$i;chmod 640 /var/named/$i;done</code></p><p><code>[root@LookBack37 ~]``# cd /var/named/</code></p><p><code>[root@LookBack37 named]``# ls -l</code></p><p><code>total 8</code></p><p><code>-rw-r----- 1 root  named    0 Aug  9 11:43 127.0.0.zone</code></p><p><code>drwxrwx--- 2 named named 4096 Jan 20  2014 data</code></p><p><code>drwxrwx--- 2 named named 4096 Aug  9 09:02 dynamic</code></p><p><code>-rw-r----- 1 root  named    0 Aug  9 11:43 localhost.zone</code></p><p><code>-rw-r----- 1 root  named    0 Aug  9 11:43 named.ca</code></p><p><code>-rw-r----- 1 root  named    0 Aug  9 11:43 ops.zeaxion.com.zone</code></p><p><code>##我这里就直接用命令批量创建好了文件  等下去补充文件内容</code></p><p><code>##127.0.0.zone  localhost.zone  named.ca  这3个文件和主从DNS服务器上文件内容是一样的</code></p><p><strong>下面是 127.0.0.zone localhost.zone named.ca 3个文件的内容</strong></p><p><code>[root@LookBack223 named]``# cat 127.0.0.zone</code></p><p><code>$TTL 86400</code></p><p><code>@       IN      SOA     localhost.      admin.05hd.org. (</code></p><p><code>2014080601</code></p><p><code>3H</code></p><p><code>15M</code></p><p><code>7D</code></p><p><code>1D )</code></p><p><code>IN      NS      localhost.</code></p><p><code>1       IN      PTR     localhost.</code></p><p><code>[root@LookBack223 named]``# cat localhost.zone</code></p><p><code>$TTL 86400</code></p><p><code>@       IN      SOA     localhost.      admin.05hd.org. (</code></p><p><code>2014080601</code></p><p><code>3H</code></p><p><code>15M</code></p><p><code>7D</code></p><p><code>1D )</code></p><p><code>IN      NS      localhost.</code></p><p><code>IN      A       127.0.0.1</code></p><p><code>[root@LookBack223 named]``# cat named.ca</code></p><p><code>; &lt;&lt;&gt;&gt; DiG 9.9.5 &lt;&lt;&gt;&gt; -t NS . @a.root-servers.net.</code></p><p><code>;; global options: +cmd</code></p><p><code>;; Got answer:</code></p><p><code>;; -&gt;&gt;HEADER&lt;</code></p><p><strong>下面来开始配置&#x2F;var&#x2F;named&#x2F;ops.zeaxion.com.zone的配置文件</strong></p><p><code>[root@LookBack37 named]``# cat ops.zeaxion.com.zone</code></p><p><code>$TTL 600</code></p><p><code>$ORIGIN ops.zeaxion.com.</code></p><p><code>@   IN  SOA ns.ops.zeaxion.com. admin.ops.zeaxion.com. (</code></p><p><code>2014080701 ;版本号</code></p><p><code>1H ;刷新时长</code></p><p><code>5M ;每5分钟做一次重试</code></p><p><code>3D ;过期时间</code></p><p><code>3H );否定回答时间)</code></p><p><code>IN NS ns ;这里ns后面不用写全了  因为第二行做了ORIGIN</code></p><p><code>IN  MX  10  mail</code></p><p><code>ns  IN  A   37.59.108.37</code></p><p><code>mail    IN  A   106.186.17.185</code></p><p><code>www IN  A   106.186.17.185</code></p><p><code>ftp</code> <code>IN  A   106.186.17.185</code></p><p><img src="/2020/04/bind%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A325.png" alt="自建DNS服务,实现双DNS服务器主从复制、子域授权、转发、智能解析等效果"></p><p><strong>下面来启动子域服务器上DNS服务</strong></p><p><code>[root@LookBack37 named]``# service named start</code></p><p><code>Starting named:                                            [  OK  ]</code></p><p><strong>来测试下子域配置</strong></p><p><code>[root@LookBack37 named]``# dig -t A www.ops.zeaxion.com @37.59.108.37</code></p><p><code>; &lt;&lt;&gt;&gt; DiG 9.9.5 &lt;&lt;&gt;&gt; -t A www.ops.zeaxion.com @37.59.108.37</code></p><p><code>;; global options: +cmd</code></p><p><code>;; Got answer:</code></p><p><code>;; -&gt;&gt;HEADER&lt;&gt; DiG 9.9.5 &lt;&lt;&gt;&gt; -t A www.ops.zeaxion.com @92.222.219.223</code></p><p><code>;; global options: +cmd</code></p><p><code>;; Got answer:</code></p><p><code>;; -&gt;&gt;HEADER&lt;</code></p><p> </p><p><code>[root@LookBack223 named]``# dig -t A www.ops.zeaxion.com</code></p><p><code>; &lt;&lt;&gt;&gt; DiG 9.9.5 &lt;&lt;&gt;&gt; -t A www.ops.zeaxion.com</code></p><p><code>;; global options: +cmd</code></p><p><code>;; Got answer:</code></p><p><code>;; -&gt;&gt;HEADER&lt;</code></p><p><strong>通过上面可以看出 不论是通过子域服务器查询还是通过父域查询 都可以了，也就是说到了这里 我们的子域服务器也OK了</strong></p><hr><h1 id="六、配置转发"><a href="#六、配置转发" class="headerlink" title="六、配置转发"></a><strong>六、配置转发</strong></h1><p>转发器顾名思义就是转发不是本机DNS所解析的服务至指定的服务器，这时候本机就是一个转发器了。 <strong>下面来看看第一种配置,转发器</strong></p><p><code>[root@LookBack37 named]``# pwd</code></p><p><code>/etc/named</code></p><p><code>[root@LookBack37 named]``# cat named.conf</code></p><p><code>options &#123;</code></p><p><code>listen-on port 53 &#123; 127.0.0.1; 37.59.108.37; &#125;;</code></p><p><code>listen-on-v6 port 53 &#123; 2001:41d0:51:1::d1c; &#125;;</code></p><p><code>directory</code> <code>&quot;/var/named&quot;``;</code></p><p><code>//``定义工作目录</code></p><p><code>recursion</code> <code>yes``;</code></p><p><code>//``允许递归</code></p><p><code>//forward</code> <code>only;</code></p><p><code>forward first;``//only</code> <code>是先递归给指定服务器，如果没有答案那么结果就是没答案，first 是先递归查询 要是没答案就自己再找一圈</code></p><p><code>forwarders &#123; 8.8.8.8; &#125;;``//``转发到哪个服务器上</code></p><p><code>&#125;;</code></p><p><strong>下面来看看第二种配置,转发区域(只对指定的区域做转发，其他的任然是去根上查询)</strong></p><p><code>#看zone  &quot;zeaxion.com&quot;   IN段中的配置，这里做了只转发zeaxion.com域的配置</code></p><p><code>[root@LookBack37 named]``# pwd</code></p><p><code>/etc/named</code></p><p><code>[root@LookBack37 named]``# cat named.conf</code></p><p><code>options &#123;</code></p><p><code>listen-on port 53 &#123; 127.0.0.1; 37.59.108.37; &#125;;</code></p><p><code>listen-on-v6 port 53 &#123; 2001:41d0:51:1::d1c; &#125;;</code></p><p><code>directory</code> <code>&quot;/var/named&quot;``;</code></p><p><code>//``定义工作目录</code></p><p><code>recursion</code> <code>yes``;</code></p><p><code>//``允许递归</code></p><p><code>//forward</code> <code>only;</code></p><p><code>forward first;</code></p><p><code>forwarders &#123; 8.8.8.8; &#125;;</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;.&quot;</code>     <code>IN      &#123;</code></p><p><code>type</code> <code>hint;</code></p><p><code>file</code> <code>&quot;named.ca&quot;``;</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;localhost&quot;</code>     <code>IN      &#123;</code></p><p><code>type</code> <code>master;</code></p><p><code>//``设施为主  master</code></p><p><code>file</code> <code>&quot;localhost.zone&quot;``;</code></p><p><code>allow-update &#123; none; &#125;;</code></p><p><code>//``不允许任何人更新</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;0.0.127.in-addr.arpa&quot;</code>  <code>IN      &#123;</code></p><p><code>//``把127.0.0反向解析</code></p><p><code>type</code> <code>master;</code></p><p><code>file</code> <code>&quot;127.0.0.zone&quot;``;</code></p><p><code>allow-update &#123; none; &#125;;</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;ops.zeaxion.com&quot;</code>   <code>IN      &#123;</code></p><p><code>type</code> <code>master;</code></p><p><code>file</code> <code>&quot;ops.zeaxion.com.zone&quot;``;</code></p><p><code>//allow-update</code> <code>&#123; 127.0.0.1; &#125;;</code></p><p><code>&#125;;</code></p><p><code>zone</code> <code>&quot;zeaxion.com&quot;</code>   <code>IN      &#123;</code></p><p><code>type</code> <code>forward;</code></p><p><code>forward only;</code></p><p><code>forwarders &#123; 92.222.219.223; 92.222.219.226; &#125;;</code></p><p><code>&#125;;</code></p><p>下面来看看效果</p><p><code>[root@LookBack37 named]``# dig -t A www.zeaxion.com @37.59.108.37</code></p><p><code>; &lt;&lt;&gt;&gt; DiG 9.9.5 &lt;&lt;&gt;&gt; -t A www.zeaxion.com @37.59.108.37</code></p><p><code>;; global options: +cmd</code></p><p><code>;; Got answer:</code></p><p><code>;; -&gt;&gt;HEADER&lt;</code></p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://jarod.vip/2020/04/22/%E8%80%81%E7%89%8C%E4%BA%91%E8%AE%A1%E7%AE%97%E6%89%98%E7%AE%A1%E6%9C%8D%E5%8A%A1%E5%95%86-ovzh-com-%E7%BE%8E%E5%9B%BDcn2-gia-vps/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="Jarod"><meta itemprop="description" content="记录生活中的点点滴滴"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Jarod's Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"><a href="/2020/04/22/%E8%80%81%E7%89%8C%E4%BA%91%E8%AE%A1%E7%AE%97%E6%89%98%E7%AE%A1%E6%9C%8D%E5%8A%A1%E5%95%86-ovzh-com-%E7%BE%8E%E5%9B%BDcn2-gia-vps/" class="post-title-link" itemprop="url">老牌云计算托管服务商 OVZH.COM 美国CN2 GIA VPS</a></h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-04-22 23:06:33" itemprop="dateCreated datePublished" datetime="2020-04-22T23:06:33+08:00">2020-04-22</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-09-29 21:27:46" itemprop="dateModified" datetime="2022-09-29T21:27:46+08:00">2022-09-29</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/VPS/" itemprop="url" rel="index"><span itemprop="name">VPS</span></a></span></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>1.7k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>2 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><p><img src="/2020/04/OVZH.COM-B.png"></p><p>老牌稳定商家推荐；OVZH.COM是一家专业的云计算托管服务商，自2017年以来，OVZH.COM为个人开发者和中小型企业客户提供了高质量稳定的专用服务器。以及其他各种托管和运维技术服务。并且专注于服务我们的客户，为每个客户提供了个性化一流的服务，我们与竞争对手的不同之处仅在于我们专注于为客户提供卓越的技术支持和企业级的托管服务。通过这几年的经验积累我们不仅可以在硬件和产品上提供最高质量的服务，而且还可以提供世界一流的24&#x2F;7技术和客户支持。在OVZH.COM上，我们在发布新产品之前，我们所有的专用服务器都经过我们专业的技术人员严格测试才会上架我们的官网，在这里我们有最优质的价格和企业级的托管硬件，如有疑问或问题，请通过电话或邮件联系我们。OVZH.COM的专家团队竭诚为您带来满意的服务！</p><p>OVZH-VDS-CN2-GIA云产品</p><p>CN2 GIA线路是中国电信推出的高速线路，分为双三网CN2 GIA和单程CN2 GIA单程是指国内访问国外为高速线路，回程走的普通线路。双程三网cn2 GIA是去程与回程都是走的 高速线路，所以在这里我们OVZH.COM采用的是双程三网CN2 GIA也就是全程CN2 GIA高端线路。</p><p><a target="_blank" rel="noopener" href="https://i.ovzh.com/cart.php?gid=1">https://i.ovzh.com/cart.php?gid=1</a></p><p>Cloud CN2 GIA 基础</p><p>¥50.00 CNY&#x2F;mo</p><p>¥1.00 初装费</p><p>IPV4 1</p><p>CPU 1个物理核心</p><p>内存 768MB</p><p>突发内存 128MB</p><p>SSD硬盘 15GB</p><p>列阵 RAID10</p><p>系统 Linux</p><p>线路 CN2-GIA三网直连</p><p>带宽 100Mbps</p><p>宽带流量 500GB</p><p>设备 戴尔企业级硬件</p><p>由OVZH.COM云服务商提供支持®</p><p>严禁违反中美法律的内容</p><p>99.95％的正常运行时间SLA</p><p>Cloud CN2 GIA 标准</p><p>¥80.00 CNY&#x2F;mo</p><p>¥1.00 初装费</p><p>IPV4 1</p><p>CPU 1个物理核心</p><p>内存 1332MB</p><p>突发内存 256MB</p><p>SSD硬盘 25GB</p><p>列阵 RAID10</p><p>系统 Linux</p><p>线路 CN2-GIA三网直连</p><p>带宽 100Mbps</p><p>宽带流量 1TB</p><p>设备 戴尔企业级硬件</p><p>由OVZH.COM云服务商提供支持®</p><p>严禁违反中美法律的内容</p><p>99.95％的正常运行时间SLA</p><p>OVZH-A-VDS-SERVERS 百分比 30% 优惠</p><p>OVZH-B-VDS-SERVERS 百分比 35% 优惠</p><p>OVZH-C-VDS-SERVERS 百分比 40% 优惠</p><p>OVZH-D-VDS-SERVERS 百分比 45% 优惠</p><p>OVZH-E-VDS-SERVERS 百分比 48% 优惠</p><p>OVZH-F-VDS-SERVERS 百分比 50% 优惠</p><p>服务器采用国际主流的 Linux+Apache+Mysql+PHP 架构. 完美支持 WordPress、Discuz、Joomla、Drupal、PHPwind、MediaWiki、phpBB、PHPcms、shopex、ecshop、帝国CMS、ZenCart、Typecho 等各种由 PHP+Mysql 构成的程序</p><p>OVZH-Hosting 云主机产品</p><p><a target="_blank" rel="noopener" href="https://i.ovzh.com/cart.php?gid=4">https://i.ovzh.com/cart.php?gid=4</a></p><p>OVZH-HOST1-ovzhcom  百分比 50% 优惠</p><p>OVZH-HOST2-ovzhcom  百分比 55% 优惠</p><p>基础</p><p>¥6.00 CNY&#x2F;mo</p><p>¥1.00 初装费</p><p>IPV4 1</p><p>网站 2</p><p>DDOS防御 80GB</p><p>SSD硬盘 1000MB</p><p>流量 1TB</p><p>提供 数据安全</p><p>提供 自动备份</p><p>提供 定时任务</p><p>提供 DDOS保护</p><p>提供 一键SSL开启</p><p>PHP5.6-7.4版本自由切换</p><p>OVZH-Hosting 分销云主机产品</p><p><a target="_blank" rel="noopener" href="https://i.ovzh.com/cart.php?gid=8">https://i.ovzh.com/cart.php?gid=8</a></p><p>OVZH-HOST3-ovzhcom  百分比 60% 优惠</p><p>OVZH-HOST4-ovzhcom  百分比 66% 优惠</p><p>基础</p><p>¥10.00 CNY&#x2F;mo</p><p>¥1.00 初装费</p><p>磁盘空间 10GB Raid10 SSD</p><p>每月流量 300GB</p><p>客户数量 5个独立客户</p><p>CPU 2核</p><p>内存 2GB</p><p>IPv4地址 1枚</p><p>超额销售 允许</p><p>云备份 支持</p><p>提供 数据安全</p><p>提供 定时任务</p><p>提供 定时采集</p><p>提供 DDOS保护</p><p>提供 一键SSL开启</p><p>提供 Cloudflare Pro</p><p>PHP5.6-7.4版本自由切换</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article><nav class="pagination"><a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right" aria-label="下一页"></i></a></nav></div><script>window.addEventListener("tabs:register",()=>{let t=CONFIG.comments["activeClass"];var e;(t=CONFIG.comments.storage?localStorage.getItem("comments_active")||t:t)&&(e=document.querySelector(`a[href="#comment-${t}"]`))&&e.click()}),CONFIG.comments.storage&&window.addEventListener("tabs:click",t=>{t.target.matches(".tabs-comment .tab-content .tab-pane")&&(t=t.target.classList[1],localStorage.setItem("comments_active",t))})</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Jarod</p><div class="site-description" itemprop="description">记录生活中的点点滴滴</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">258</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">6</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">306</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/jarodvip" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jarodvip" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Jarod</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span title="站点总字数">647k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">9:48</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script></body></html>